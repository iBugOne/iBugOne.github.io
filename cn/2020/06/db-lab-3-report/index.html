<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.26.2 by Michael Rose
  Copyright 2013-2024 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en-US" class="no-js">
	<head>
		<meta charset="utf-8">
		<!-- begin _includes/seo.html -->
		<title>银行业务管理系统系统设计与实现报告 - iBug</title>
		<meta name="description" content="“银行业务管理系统”是中科大 2020 年春季数据库课程的大实验">
		<meta name="author" content="iBug">
		<meta property="article:author" content="iBug">
		<meta property="og:type" content="article">
		<meta property="og:locale" content="en_US">
		<meta property="og:site_name" content="iBug">
		<meta property="og:title" content="银行业务管理系统系统设计与实现报告">
		<meta property="og:url" content="https://ibug.io/cn/2020/06/db-lab-3-report/">
		<meta property="og:description" content="“银行业务管理系统”是中科大 2020 年春季数据库课程的大实验">
		<meta property="og:image" content="https://ibug.io/image/og.jpg">
		<meta property="article:published_time" content="2020-06-30T00:00:00+00:00">
		<meta property="article:modified_time" content="2021-03-27T01:38:49+00:00">
		<link rel="canonical" href="https://ibug.io/cn/2020/06/db-lab-3-report/">
		<meta name="google-site-verification" content="5_jn7a-vZslUtLJO-BkY-cPDGgah5JP49RGgeOBmYSk" />
		<!-- end _includes/seo.html -->
		<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="iBug Feed">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<script type="text/javascript">
			document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
		</script>
		<!-- For all browsers -->
		<link rel="stylesheet" href="/assets/css/main.css?v=8d646e9">
		<link rel="stylesheet" href="https://static.ibugone.com/fontawesome/6/css/all.min.css" media="none" onload="if(media!='all')media='all'">
		<link rel="shortcut icon" type="image/png" href="/assets/favicon.png">
		<meta name="theme-color" content="#EDEDED">
		<script>
			const funcOnPageLoad = function() { document.body.classList.add("loaded"); };
			document.addEventListener('DOMContentLoaded', funcOnPageLoad);
		</script>
	</head>
	<body class="layout--single">
		<nav class="skip-links">
			<ul>
				<li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
				<li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
				<li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
			</ul>
		</nav>
		<div class="masthead">
			<div class="masthead__inner-wrap">
				<div class="masthead__menu">
					<nav id="site-nav" class="greedy-nav">
						<a class="site-logo" href="/"><img src="/assets/favicon.png" alt="iBug"></a>
						<a class="site-title" href="/">
							iBug
						</a>
						<ul class="visible-links">
							<li class="masthead__menu-item">
								<a href="/about/">About</a>
							</li>
							<li class="masthead__menu-item">
								<a href="/blog/">Blog</a>
							</li>
							<li class="masthead__menu-item">
								<a href="/projects/">Projects</a>
							</li>
							<li class="masthead__menu-item">
								<a href="/friends/">Friends</a>
							</li>
							<li class="masthead__menu-item">
								<a href="/cn/">中文内容</a>
							</li>
						</ul>
						<button class="search__toggle" type="button">
							<span class="visually-hidden">Toggle search</span>
							<i class="fas fa-search"></i>
						</button>
						<button class="greedy-nav__toggle hidden" type="button">
							<span class="visually-hidden">Toggle menu</span>
							<div class="navicon"></div>
						</button>
						<ul class="hidden-links hidden"></ul>
					</nav>
				</div>
			</div>
		</div>
		<div class="initial-content">
			<div class="page__hero--overlay" style=" background-image: linear-gradient(rgba(0, 146, 202, 0.3), rgba(0, 0, 0, 0.2)), url('/image/header/cloud-1.jpg');">
				<div class="wrapper">
					<h1 id="page-title" class="page__title" itemprop="headline">
						银行业务管理系统
						系统设计与实现报告
					</h1>
					<p class="page__lead">中科大 2020 年春季数据库课程的大实验
					</p>
					<p class="page__meta">
						<span class="page__meta-date">
							<i class="far fa-calendar-alt" aria-hidden="true"></i>
							<time datetime="2020-06-30T00:00:00+00:00">Jun 30, 2020</time>
						</span>
						<span class="page__meta-sep"></span>
						<span class="page__meta-readtime">
							<i class="far fa-clock" aria-hidden="true"></i>
							47 minute read
						</span>
					</p>
					<p>
						<a href="https://github.com/iBug/Junk-Bank-System" class="btn btn--light-outline btn--large"><i class="fab fa-github"></i> GitHub</a>
					</p>
				</div>
			</div>
			<div id="main" role="main">
				<div class="sidebar sticky">
					<div itemscope itemtype="https://schema.org/Person" class="h-card">
						<div class="author__avatar">
							<a href="https://ibug.io/">
								<img src="/image/avatar.png" alt="iBug" itemprop="image" class="u-photo">
							</a>
						</div>
						<div class="author__content">
							<h3 class="author__name p-name" itemprop="name">
								<a class="u-url" rel="me" href="https://ibug.io/" itemprop="url">iBug</a>
							</h3>
							<div class="author__bio p-note" itemprop="description">
								<p>Developer, System Administrator, Geek</p>
							</div>
						</div>
						<div class="author__urls-wrapper">
							<button class="btn btn--inverse">Follow</button>
							<ul class="author__urls social-icons">
								<li><a href="mailto:%69@ibugone.com" rel="nofollow noopener noreferrer me"><i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i><span class="label">Email</span></a></li>
								<li><a href="https://stackoverflow.com/users/5958455/ibug" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-stack-overflow" aria-hidden="true"></i><span class="label">Stack Overflow</span></a></li>
								<li><a href="https://github.com/iBug" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
								<li><a href="https://steamcommunity.com/id/ibugone" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-steam" aria-hidden="true"></i><span class="label">Steam</span></a></li>
								<li><a href="https://t.me/iBugThought" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-telegram" aria-hidden="true"></i><span class="label">Telegram Channel</span></a></li>
								<!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer me">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
							</ul>
						</div>
					</div>
					<nav class="nav__list">
						<input id="ac-toc" name="accordion-toc" type="checkbox">
						<label for="ac-toc">Toggle menu</label>
						<ul class="nav__items">
							<li>
								<span class="nav__sub-title">iBug on the Web</span>
								<ul>
									<li><a href="/"><i class="fas fa-fw fa-home"></i> Home</a></li>
									<li><a href="/about/"><i class="fas fa-fw fa-grin-alt"></i> About iBug</a></li>
									<li><a href="/blog/"><i class="fas fa-fw fa-book"></i> Blog</a></li>
									<li><a href="/skills/"><i class="fas fa-fw fa-wrench"></i> Skills</a></li>
									<li><a href="/open-source/"><i class="fas fa-fw fa-box-open"></i> Open Source</a></li>
									<li><a href="/projects/"><i class="fas fa-fw fa-puzzle-piece"></i> Projects</a></li>
									<li><a href="https://notes.ibug.io/"><i class="fas fa-fw fa-sticky-note"></i> Notes</a></li>
									<li><a href="/bookmarks/"><i class="fas fa-fw fa-bookmark"></i> Bookmarks</a></li>
									<li><a href="/friends/"><i class="fas fa-fw fa-user-friends"></i> Friends</a></li>
									<li><a href="/cn/"><i class="fas fa-fw fa-yin-yang"></i> Chinese Content</a></li>
								</ul>
							</li>
						</ul>
					</nav>
				</div>
				<article class="page" itemscope itemtype="https://schema.org/CreativeWork" lang="zh-CN">
					<meta itemprop="headline" content="银行业务管理系统系统设计与实现报告">
					<meta itemprop="description" content="“银行业务管理系统”是中科大 2020 年春季数据库课程的大实验">
					<meta itemprop="datePublished" content="2020-06-30T00:00:00+00:00">
					<meta itemprop="dateModified" content="2021-03-27T01:38:49+00:00">
					<div class="page__inner-wrap">
						<section class="page__content" itemprop="text">
							<aside class="sidebar__right sticky">
								<nav class="toc">
									<header>
										<h4 class="nav__title">
											<i class="fas fa-th-list"></i> 目录</h4>
									</header>
									<ul class="toc__menu">
										<li>
											<a href="#1-%E6%A6%82%E8%BF%B0">1 概述</a>
											<ul>
												<li><a href="#11-%E7%B3%BB%E7%BB%9F%E7%9B%AE%E6%A0%87">1.1 系统目标</a></li>
												<li>
													<a href="#12-%E9%9C%80%E6%B1%82%E8%AF%B4%E6%98%8E">1.2 需求说明</a>
													<ul>
														<li><a href="#121-%E6%95%B0%E6%8D%AE%E9%9C%80%E6%B1%82">1.2.1 数据需求</a></li>
														<li><a href="#122-%E5%8A%9F%E8%83%BD%E9%9C%80%E6%B1%82">1.2.2 功能需求</a></li>
														<li><a href="#123-%E9%9C%80%E6%B1%82%E8%AF%B4%E6%98%8E">1.2.3 需求说明</a></li>
													</ul>
												</li>
												<li><a href="#13-%E6%9C%AC%E6%8A%A5%E5%91%8A%E7%9A%84%E4%B8%BB%E8%A6%81%E8%B4%A1%E7%8C%AE">1.3 本报告的主要贡献</a></li>
											</ul>
										</li>
										<li>
											<a href="#2-%E6%80%BB%E4%BD%93%E8%AE%BE%E8%AE%A1">2 总体设计</a>
											<ul>
												<li><a href="#21-%E7%B3%BB%E7%BB%9F%E6%A8%A1%E5%9D%97%E7%BB%93%E6%9E%84">2.1 系统模块结构</a></li>
												<li><a href="#22-%E7%B3%BB%E7%BB%9F%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B">2.2 系统工作流程</a></li>
												<li>
													<a href="#23-%E6%95%B0%E6%8D%AE%E5%BA%93%E8%AE%BE%E8%AE%A1">2.3 数据库设计</a>
													<ul>
														<li><a href="#231-%E6%94%AF%E8%A1%8C">2.3.1 支行</a></li>
														<li><a href="#232-%E9%83%A8%E9%97%A8">2.3.2 部门</a></li>
														<li><a href="#233-%E5%91%98%E5%B7%A5">2.3.3 员工</a></li>
														<li><a href="#234-%E5%AE%A2%E6%88%B7">2.3.4 客户</a></li>
														<li><a href="#235-%E5%AE%A2%E6%88%B7%E7%9A%84%E8%81%94%E7%B3%BB%E4%BA%BA">2.3.5 客户的联系人</a></li>
														<li><a href="#236-%E8%B4%A6%E6%88%B7">2.3.6 账户</a></li>
														<li><a href="#237-%E5%AE%A2%E6%88%B7%E8%B4%A6%E6%88%B7%E5%85%B3%E7%B3%BB">2.3.7 客户账户关系</a></li>
														<li><a href="#238-%E5%82%A8%E8%93%84%E8%B4%A6%E6%88%B7%E5%A4%9A%E6%80%81%E5%85%B3%E8%81%94">2.3.8 储蓄账户（多态关联）</a></li>
														<li><a href="#239-%E6%94%AF%E7%A5%A8%E8%B4%A6%E6%88%B7%E5%A4%9A%E6%80%81%E5%85%B3%E8%81%94">2.3.9 支票账户（多态关联）</a></li>
														<li><a href="#2310-%E8%B4%B7%E6%AC%BE">2.3.10 贷款</a></li>
														<li><a href="#2311-%E5%AE%A2%E6%88%B7%E8%B4%B7%E6%AC%BE%E5%85%B3%E7%B3%BB">2.3.11 客户贷款关系</a></li>
														<li><a href="#2312-%E8%B4%B7%E6%AC%BE%E5%8F%91%E6%94%BE">2.3.12 贷款发放</a></li>
													</ul>
												</li>
											</ul>
										</li>
										<li>
											<a href="#3-%E8%AF%A6%E7%BB%86%E8%AE%BE%E8%AE%A1">3 详细设计</a>
											<ul>
												<li>
													<a href="#31-active-record-%E6%A8%A1%E5%9E%8B">3.1 Active Record 模型</a>
													<ul>
														<li><a href="#311-%E6%94%AF%E8%A1%8C">3.1.1 支行</a></li>
														<li><a href="#312-%E9%83%A8%E9%97%A8">3.1.2 部门</a></li>
														<li><a href="#313-%E5%91%98%E5%B7%A5">3.1.3 员工</a></li>
														<li><a href="#314-%E5%AE%A2%E6%88%B7">3.1.4 客户</a></li>
														<li><a href="#315-%E8%81%94%E7%B3%BB%E4%BA%BA">3.1.5 联系人</a></li>
														<li><a href="#316-%E8%B4%A6%E6%88%B7">3.1.6 账户</a></li>
														<li><a href="#317-%E8%B4%A6%E6%88%B7%E7%B1%BB%E5%9E%8B">3.1.7 账户类型</a></li>
														<li><a href="#318-%E5%AE%A2%E6%88%B7%E8%B4%A6%E6%88%B7%E5%85%B3%E7%B3%BB">3.1.8 客户账户关系</a></li>
														<li><a href="#319-%E8%B4%B7%E6%AC%BE">3.1.9 贷款</a></li>
														<li><a href="#3110-%E8%B4%B7%E6%AC%BE%E6%94%AF%E4%BB%98">3.1.10 贷款支付</a></li>
													</ul>
												</li>
												<li>
													<a href="#32-action-controller-%E6%8E%A7%E5%88%B6%E5%99%A8">3.2 Action Controller 控制器</a>
													<ul>
														<li><a href="#321-%E9%BB%98%E8%AE%A4%E5%8A%A8%E4%BD%9C--%E5%85%B1%E5%90%8C%E5%8A%A8%E4%BD%9C">3.2.1 默认动作 / 共同动作</a></li>
														<li><a href="#322-%E8%B7%AF%E7%94%B1">3.2.2 路由</a></li>
														<li><a href="#323-%E6%94%AF%E8%A1%8C%E6%8E%A7%E5%88%B6%E5%99%A8">3.2.3 支行控制器</a></li>
														<li><a href="#324-%E9%83%A8%E9%97%A8%E6%8E%A7%E5%88%B6%E5%99%A8">3.2.4 部门控制器</a></li>
														<li><a href="#325-%E5%91%98%E5%B7%A5%E6%8E%A7%E5%88%B6%E5%99%A8">3.2.5 员工控制器</a></li>
														<li><a href="#326-%E5%AE%A2%E6%88%B7%E6%8E%A7%E5%88%B6%E5%99%A8">3.2.6 客户控制器</a></li>
														<li><a href="#327-%E8%B4%A6%E6%88%B7%E6%8E%A7%E5%88%B6%E5%99%A8">3.2.7 账户控制器</a></li>
														<li><a href="#328-%E5%AE%A2%E6%88%B7%E8%B4%A6%E6%88%B7%E5%85%B3%E7%B3%BB%E6%8E%A7%E5%88%B6%E5%99%A8">3.2.8 客户账户关系控制器</a></li>
														<li><a href="#329-%E8%B4%B7%E6%AC%BE%E6%8E%A7%E5%88%B6%E5%99%A8">3.2.9 贷款控制器</a></li>
														<li><a href="#3210-%E8%B4%B7%E6%AC%BE%E5%8F%91%E6%94%BE%E6%8E%A7%E5%88%B6%E5%99%A8">3.2.10 贷款发放控制器</a></li>
														<li><a href="#3211-%E7%BB%9F%E8%AE%A1%E4%BF%A1%E6%81%AF%E6%8E%A7%E5%88%B6%E5%99%A8">3.2.11 统计信息控制器</a></li>
													</ul>
												</li>
												<li>
													<a href="#33-action-view-%E8%A7%86%E5%9B%BE">3.3 Action View 视图</a>
													<ul>
														<li><a href="#331-%E4%B8%BB%E5%B8%83%E5%B1%80-layoutsapplication">3.3.1 主布局 layouts/application</a></li>
														<li><a href="#332-%E9%A6%96%E9%A1%B5">3.3.2 首页</a></li>
														<li><a href="#333-%E5%8D%A1%E7%89%87%E5%B8%83%E5%B1%80">3.3.3 卡片布局</a></li>
														<li>
															<a href="#334-%E5%88%97%E8%A1%A8%E9%A1%B5%E9%9D%A2">3.3.4 列表页面</a>
															<ul>
																<li><a href="#%E5%BF%AB%E6%8D%B7%E6%90%9C%E7%B4%A2%E5%8A%9F%E8%83%BD">快捷搜索功能</a></li>
															</ul>
														</li>
														<li><a href="#335-%E8%AF%A6%E7%BB%86%E4%BF%A1%E6%81%AF%E9%A1%B5%E9%9D%A2">3.3.5 详细信息页面</a></li>
														<li><a href="#336-%E5%88%9B%E5%BB%BA--%E7%BC%96%E8%BE%91%E8%A1%A8%E6%A0%BC">3.3.6 创建 / 编辑表格</a></li>
														<li><a href="#337-%E5%85%B3%E8%81%94%E4%BF%A1%E6%81%AF%E5%88%97%E8%A1%A8%E9%A1%B5%E9%9D%A2">3.3.7 关联信息列表页面</a></li>
														<li><a href="#338-%E8%B4%A6%E6%88%B7%E7%9A%84%E5%85%B3%E8%81%94%E5%AE%A2%E6%88%B7%E9%A1%B5%E9%9D%A2">3.3.8 账户的关联客户页面</a></li>
														<li><a href="#339-%E4%B8%9A%E5%8A%A1%E7%BB%9F%E8%AE%A1%E9%A1%B5%E9%9D%A2">3.3.9 「业务统计」页面</a></li>
														<li><a href="#3310-%E4%B8%9A%E5%8A%A1%E7%BB%9F%E8%AE%A1%E7%9A%84%E6%90%9C%E7%B4%A2%E9%A1%B5%E9%9D%A2">3.3.10 业务统计的搜索页面</a></li>
													</ul>
												</li>
												<li>
													<a href="#34-sprockets-assets-pipeline">3.4 Sprockets Assets Pipeline</a>
													<ul>
														<li><a href="#341-javascript-%E8%84%9A%E6%9C%AC">3.4.1 JavaScript 脚本</a></li>
														<li><a href="#342-css-%E6%A0%B7%E5%BC%8F%E8%A1%A8">3.4.2 CSS 样式表</a></li>
														<li><a href="#343-%E5%9B%BE%E7%89%87">3.4.3 图片</a></li>
													</ul>
												</li>
											</ul>
										</li>
										<li>
											<a href="#4-%E5%AE%9E%E7%8E%B0%E4%B8%8E%E6%B5%8B%E8%AF%95">4 实现与测试</a>
											<ul>
												<li>
													<a href="#41-%E5%AE%9E%E7%8E%B0%E7%BB%93%E6%9E%9C">4.1 实现结果</a>
													<ul>
														<li><a href="#%E9%A6%96%E9%A1%B5">首页</a></li>
														<li><a href="#%E6%94%AF%E8%A1%8C%E5%88%97%E8%A1%A8%E9%A1%B5%E9%9D%A2">支行列表页面</a></li>
														<li><a href="#%E6%94%AF%E8%A1%8C%E8%AF%A6%E7%BB%86%E4%BF%A1%E6%81%AF%E9%A1%B5%E9%9D%A2">支行详细信息页面</a></li>
														<li><a href="#%E8%B4%A6%E6%88%B7%E7%BC%96%E8%BE%91%E9%A1%B5%E9%9D%A2">账户编辑页面</a></li>
														<li><a href="#%E6%94%AF%E8%A1%8C%E7%9A%84%E5%85%B3%E8%81%94%E8%B4%A6%E6%88%B7%E9%A1%B5%E9%9D%A2">支行的关联账户页面</a></li>
														<li><a href="#%E8%B4%A6%E6%88%B7%E7%9A%84%E5%85%B3%E8%81%94%E5%AE%A2%E6%88%B7%E9%A1%B5%E9%9D%A2">账户的关联客户页面</a></li>
														<li><a href="#%E8%B4%B7%E6%AC%BE%E7%9A%84%E6%94%AF%E4%BB%98%E9%A1%B5%E9%9D%A2">贷款的支付页面</a></li>
														<li><a href="#%E4%B8%9A%E5%8A%A1%E7%BB%9F%E8%AE%A1%E9%A1%B5%E9%9D%A2">「业务统计」页面</a></li>
														<li><a href="#%E4%B8%9A%E5%8A%A1%E7%BB%9F%E8%AE%A1%E7%9A%84%E6%90%9C%E7%B4%A2%E9%A1%B5%E9%9D%A2">业务统计的搜索页面</a></li>
													</ul>
												</li>
												<li>
													<a href="#42-%E6%B5%8B%E8%AF%95%E7%BB%93%E6%9E%9C">4.2 测试结果</a>
													<ul>
														<li>
															<a href="#421-%E6%93%8D%E4%BD%9C%E6%88%90%E5%8A%9F%E7%BB%93%E6%9E%9C">4.2.1 操作成功结果</a>
															<ul>
																<li><a href="#%E5%88%9B%E5%BB%BA%E6%94%AF%E8%A1%8C">创建支行</a></li>
																<li><a href="#%E6%9B%B4%E6%96%B0%E6%94%AF%E8%A1%8C">更新支行</a></li>
																<li><a href="#%E5%88%A0%E9%99%A4%E6%94%AF%E8%A1%8C">删除支行</a></li>
																<li><a href="#%E8%B4%A6%E6%88%B7%E6%96%B0%E5%A2%9E%E5%85%B3%E8%81%94%E5%AE%A2%E6%88%B7">账户新增关联客户</a></li>
																<li><a href="#%E8%B4%B7%E6%AC%BE%E6%96%B0%E5%A2%9E%E6%94%AF%E4%BB%98">贷款新增支付</a></li>
															</ul>
														</li>
														<li>
															<a href="#422-%E6%93%8D%E4%BD%9C%E5%A4%B1%E8%B4%A5%E7%BB%93%E6%9E%9C">4.2.2 操作失败结果</a>
															<ul>
																<li><a href="#%E5%88%9B%E5%BB%BA%E6%94%AF%E8%A1%8C-1">创建支行</a></li>
																<li><a href="#%E5%88%A0%E9%99%A4%E6%94%AF%E8%A1%8C-1">删除支行</a></li>
																<li><a href="#%E6%9B%B4%E6%96%B0%E8%B4%A6%E6%88%B7">更新账户</a></li>
																<li><a href="#%E8%B4%B7%E6%AC%BE%E6%94%AF%E4%BB%98">贷款支付</a></li>
															</ul>
														</li>
													</ul>
												</li>
											</ul>
										</li>
										<li><a href="#5-%E6%80%BB%E7%BB%93%E4%B8%8E%E8%AE%A8%E8%AE%BA">5 总结与讨论</a></li>
									</ul>
								</nav>
							</aside>
							<h2 id="1-概述">1 概述</h2>
							<p>本项目使用 <a href="https://rubyonrails.org/">Ruby on Rails</a> 实现了一个简易的银行业务管理系统，已于 GitHub 开源，地址为 <a href="https://github.com/iBug/Junk-Bank-System">https://github.com/iBug/Junk-Bank-System</a>。另外本项目还<a href="https://hub.docker.com/repository/docker/ibugone/junk-bank-system">发布在了 Docker Hub 上</a>（镜像为 <code class="language-plaintext highlighter-rouge">ibugone/junk-bank-system</code>），并据此实现了使用 <a href="https://docs.docker.com/compose/">Docker Compose</a> 的简易部署，其配置文件位于 <a href="https://github.com/iBug/Junk-Bank-System/blob/master/docker-compose.yml">https://github.com/iBug/Junk-Bank-System/blob/master/docker-compose.yml</a>。</p>
							<h3 id="11-系统目标">1.1 系统目标</h3>
							<p>某银行准备开发一个银行业务管理系统，要求实现<strong>客户管理</strong>、<strong>账户管理</strong>、<strong>贷款管理</strong>与<strong>业务统计</strong>四大类功能。详细需求在 1.2.2 节介绍。</p>
							<h3 id="12-需求说明">1.2 需求说明</h3>
							<h4 id="121-数据需求">1.2.1 数据需求</h4>
							<p>银行有多个支行。各个支行位于某个城市，每个支行有唯一的名字。银行要监控每个支行的资产。 银行的客户通过其身份证号来标识。银行存储每个客户的姓名、联系电话以及家庭住址。为了安全起见，银行还要求客户提供一位联系人的信息，包括联系人姓名、手机号、Email 以及与客户的关系。客户可以有帐户，并且可以贷款。客户可能和某个银行员工发生联系，该员工是此客户的贷款负责人或银行帐户负责人。银行员工也通过身份证号来标识。员工分为部门经理和普通员工，每个部门经理都负责领导其所在部门的员工，并且每个员工只允许在一个部门内工作。每个支行的管理机构存储每个员工的姓名、电话号码、家庭地址、所在的部门号、部门名称、部门类型及部门经理的身份证号。银行还需知道每个员工开始工作的日期，由此日期可以推知员工的雇佣期。银行提供两类帐户：储蓄帐户和支票帐户。帐户可以由多个客户所共有，一个客户也可开设多个账户，但在一个支行内最多只能开设一个储蓄账户和一个支票账户。每个帐户被赋以唯一的帐户号。银行记录每个帐户的余额、开户日期、开户的支行名以及每个帐户所有者访问该帐户的最近日期。另外，每个储蓄帐户有利率和货币类型，且每个支票帐户有透支额。每笔贷款由某个分支机构发放，能被一个或多个客户所共有。每笔贷款用唯一的贷款号标识。银行需要知道每笔贷款所贷金额以及逐次支付的情况（银行将贷款分几次付给客户）。虽然贷款号不能唯一标识银行所有为贷款所付的款项，但可以唯一标识为某贷款所付的款项。对每次的付款需要记录日期和金额。</p>
							<h4 id="122-功能需求">1.2.2 功能需求</h4>
							<ul>
								<li>
									<strong>客户管理</strong>：提供客户所有信息的增、删、改、查功能；如果客户存在着关联账户或者贷款记录，则不允许删除；</li>
								<li>
									<strong>账户管理</strong>：提供账户开户、销户、修改、查询功能，包括储蓄账户和支票账户；账户号不允许修改；</li>
								<li>
									<strong>贷款管理</strong>：提供贷款信息的增、删、查功能，提供贷款发放功能；贷款信息一旦添加成功后不允许修改；要求能查询每笔贷款的当前状态（未开始发放、发放中、已全部发放）；处于发放中状态的贷款记录不允许删除；</li>
								<li>
									<strong>业务统计</strong>：按业务分类（储蓄、贷款）和时间（月、季、年）统计各个支行的业务总金额和用户数，要求对统计结果同时提供表格和曲线图两种可视化展示方式。</li>
							</ul>
							<h4 id="123-需求说明">1.2.3 需求说明</h4>
							<ol>
								<li>支行、部门和员工的信息需要预先插入到数据库中，本项目假设这三类数据已经在数据库中了，并且本实验不要求实现这三类数据的维护。</li>
								<li>后台 DBMS 使用 MySQL；</li>
								<li>前端开发工具不限，可以是 C/S 架构也可以是 B/S 架构；</li>
								<li>查询功能允许自行设计，但要求尽可能灵活设计，考虑用户多样化的查询需求；</li>
								<li>各类数据的类型可自行根据实际情况设计；</li>
								<li>测试数据自行设计；</li>
								<li>系统实现时要保证数据之间的一致性；</li>
								<li>程序须有一定的出错处理，要求自己先做好测试，能够处理可以预见的一些错误，例如输入的客户姓名带单引号（类似 <code class="language-plaintext highlighter-rouge">O'Neil</code>）、输入数据不合法等等；</li>
								<li>其余功能可以自行添加，例如登录管理、权限管理等等，但不做强制要求。如果做了添加，请在实验报告中加以描述；</li>
								<li>本实验要求单独完成。</li>
							</ol>
							<h3 id="13-本报告的主要贡献">1.3 本报告的主要贡献</h3>
							<p>众所周知，好的实验报告是成功实验的一半。因此</p>
							<ul>
								<li>本报告的主要贡献在于完整、详实、丰富地填满了这份繁杂冗长的实验报告模板，尽自己所能<strong>充实</strong>了各位助教阅读实验报告的体验。</li>
								<li>其次，本报告介绍了一个采用良好开发技术达到 1.1 节所述目标、完成 1.2 节所述需求的 B/S 架构的银行业务管理系统，并对其代码及实现技巧进行了详细的剖析</li>
								<li>另外，本报告通过详细的分析，介绍了 Ruby on Rails 框架的强大与便捷</li>
								<li>最后，本报告在第 5 章为实验及实验报告的设计提出了一些改进意见。</li>
							</ul>
							<h2 id="2-总体设计">2 总体设计</h2>
							<p>系统采用 <a href="https://rubyonrails.org/">Ruby on Rails</a> 框架，使用 Model-View-Controller 架构进行前后端一体的全栈开发，前端采用 <a href="https://getbootstrap.com/docs/4.5/">Bootstrap 4</a> 进行界面设计与优化，并使用 JavaScript 与 <a href="https://jquery.com/">jQuery</a> 实现页面上的动态功能。</p>
							<h3 id="21-系统模块结构">2.1 系统模块结构</h3>
							<p>本系统采用标准的 Ruby on Rails 全找开发结构，其结构如下图所示：</p>
							<p><img src="https://ibug.github.io/Junk-Bank-System/image/2.1.png" alt="image"></p>
							<p>各模块功能：</p>
							<ul>
								<li>Puma Server 负责处理客户端（浏览器）发来的 HTTP 请求，解析内容，并根据路由规则选择合适的控制器和动作，以及向客户端返回 HTTP 响应</li>
								<li>Controller (Action Controller) 负责执行实际的业务逻辑，包括调用模型与数值计算等</li>
								<li>Model (Active Record) 为 ORM，负责与数据库通信，从数据库内容构建 Ruby 模型供其他模块使用</li>
								<li>View (Action View) 负责从模板渲染 HTML 页面，交由 Server 返回</li>
								<li>MySQL 或 MariaDB 为后端 DBMS，负责数据的存储与维护等</li>
							</ul>
							<p>模块之间的接口：</p>
							<ul>
								<li>五个模块组成应用程序整体，通过 HTTP 协议与外部通信</li>
								<li>Server 通过直接调用 Action Controller 中相关方法的方式执行动作，通过外部变量 <code class="language-plaintext highlighter-rouge">params</code> 传输 HTTP 请求参数（包括 URL 参数与 POST 方式的主体）</li>
								<li>MySQL 与 Active Record 通过 SQL 查询的方式通信。AR 维护一个 SQL 客户端，通过其发送 SQL 语句及接收结果</li>
								<li>Active Record，Action Controller 与 Action View 之间均通过传递 Ruby 对象的方式传输数据</li>
							</ul>
							<p>具体的 Active Record 模型、Action Controller 控制器与 Action View 视图在第 3 节介绍。</p>
							<h3 id="22-系统工作流程">2.2 系统工作流程</h3>
							<p>系统工作流程如 2.1 节的图中所示，客户端（浏览器）访问网站时实际发生的工作流程按 2.1 节的图中逆时针进行，文字过程如下：</p>
							<ol>
								<li>浏览器向服务器发送 web 请求；</li>
								<li>服务器（此处忽略前端 Nginx / Apache 等反向代理服务器）根据定义好的路由（Routes）决定该请求要交给哪个控制器处理；</li>
								<li>控制器接收到请求，处理请求参数，根据请求内容存取所需的数据（对象模型）；</li>
								<li>应用程序模型（Active Record）根据接收到的查询请求构造 SQL 语句，向 DBMS 服务器进行查询，将查询结果转换为 Ruby 模型，返回给调用者；</li>
								<li>控制器完成规定的操作，获取了需要的数据，将它们发送给视图（View）控制器，视图控制器将 HTML 模板渲染成完整的 HTML 页面，传回给前端服务器；</li>
								<li>前端服务器将 HTML 页面作为 web 响应发送给浏览器。</li>
							</ol>
							<h3 id="23-数据库设计">2.3 数据库设计</h3>
							<p>数据库一共 12 个表，存储了各种实体（如账户）与实体之间的关系（如客户与账户的联系）。由于部分实验要求，如使用「名称」、「身份证号」之类的属性作为主键等对数据库设计以及 Active Record 的默认行为不够友好，因此本系统实现时全部使用自增整数 ID 作为主键，实验要求中的主键全部加上 <code class="language-plaintext highlighter-rouge">UNIQUE NOT NULL</code> 约束保持候选性质，按照普通属性处理。另外 Active Record 会主动记录每个项（数据表行）的创建与更改时间，因此每个表都有两个额外的时间列（由 <code class="language-plaintext highlighter-rouge">t.timestamps</code> 创建），与本实验无关，可以放心忽略。</p>
							<p>下面为本实验所构建数据库模型的 ER 图：</p>
							<p><img src="https://ibug.github.io/Junk-Bank-System/image/er.png" alt="image"></p>
							<p>下面为创建每个表及相关约束所使用的 Active Record 迁移脚本。</p>
							<h4 id="231-支行">2.3.1 支行</h4>
							<div class="language-ruby highlighter-rouge">
								<div class="highlight">
									<pre class="highlight"><code><span class="k">class</span> <span class="nc">CreateBranches</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">6.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:branches</span><span class="p">,</span> <span class="ss">comment: </span><span class="s1">'支行'</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">limit: </span><span class="mi">64</span><span class="p">,</span> <span class="ss">unique: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">comment: </span><span class="s1">'名称'</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:city</span><span class="p">,</span> <span class="ss">limit: </span><span class="mi">64</span><span class="p">,</span> <span class="ss">comment: </span><span class="s1">'城市'</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">decimal</span> <span class="ss">:assets</span><span class="p">,</span> <span class="ss">precision: </span><span class="mi">12</span><span class="p">,</span> <span class="ss">scale: </span><span class="mi">2</span><span class="p">,</span> <span class="ss">default: </span><span class="mf">0.0</span><span class="p">,</span> <span class="ss">comment: </span><span class="s1">'资产'</span>

      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
								</div>
							</div>
							<p>每个支行具有三个属性：</p>
							<ul>
								<li>名称，是唯一的</li>
								<li>所在城市</li>
								<li>资产</li>
							</ul>
							<p>考虑到资产为金钱，因此使用两位定点小数存储。下面所有的「金额」属性相同处理。</p>
							<h4 id="232-部门">2.3.2 部门</h4>
							<div class="language-ruby highlighter-rouge">
								<div class="highlight">
									<pre class="highlight"><code><span class="k">class</span> <span class="nc">CreateDepartments</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">6.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:departments</span><span class="p">,</span> <span class="ss">comment: </span><span class="s1">'部门'</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">limit: </span><span class="mi">64</span><span class="p">,</span> <span class="ss">unique: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">comment: </span><span class="s1">'部门名称'</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:kind</span><span class="p">,</span> <span class="ss">limit: </span><span class="mi">64</span><span class="p">,</span> <span class="ss">comment: </span><span class="s1">'部门类型'</span>

      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
								</div>
							</div>
							<p>每个部门具有两个属性：</p>
							<ul>
								<li>部门名称，是唯一的</li>
								<li>部门类型</li>
							</ul>
							<p>其中部门类型在实验要求中并未详细说明，因此本实现将其当作字符串，灵活度较高。</p>
							<h4 id="233-员工">2.3.3 员工</h4>
							<div class="language-ruby highlighter-rouge">
								<div class="highlight">
									<pre class="highlight"><code><span class="k">class</span> <span class="nc">CreateStaffs</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">6.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:staffs</span><span class="p">,</span> <span class="ss">comment: </span><span class="s1">'员工'</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:person_id</span><span class="p">,</span> <span class="ss">limit: </span><span class="mi">18</span><span class="p">,</span> <span class="ss">unique: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">null: </span><span class="kp">false</span><span class="p">,</span> <span class="ss">comment: </span><span class="s1">'身份证号'</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">limit: </span><span class="mi">64</span><span class="p">,</span> <span class="ss">comment: </span><span class="s1">'姓名'</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:phone</span><span class="p">,</span> <span class="ss">limit: </span><span class="mi">64</span><span class="p">,</span> <span class="ss">comment: </span><span class="s1">'电话'</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:address</span><span class="p">,</span> <span class="ss">limit: </span><span class="mi">256</span><span class="p">,</span> <span class="ss">comment: </span><span class="s1">'家庭地址'</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">date</span> <span class="ss">:start_date</span><span class="p">,</span> <span class="ss">default: </span><span class="s1">'CURRENT_TIMESTAMP'</span><span class="p">,</span> <span class="ss">comment: </span><span class="s1">'开始工作日期'</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">boolean</span> <span class="ss">:manager</span><span class="p">,</span> <span class="ss">default: </span><span class="o">-&gt;</span> <span class="p">{</span> <span class="kp">false</span> <span class="p">},</span> <span class="ss">comment: </span><span class="s1">'经理'</span>

      <span class="n">t</span><span class="p">.</span><span class="nf">references</span> <span class="ss">:branch</span><span class="p">,</span> <span class="ss">index: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">foreign_key: </span><span class="p">{</span> <span class="ss">on_delete: :restrict</span> <span class="p">}</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">references</span> <span class="ss">:department</span><span class="p">,</span> <span class="ss">index: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">foreign_key: </span><span class="p">{</span> <span class="ss">on_delete: :restrict</span> <span class="p">}</span>

      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
								</div>
							</div>
							<p>每个员工具有八个属性：</p>
							<ul>
								<li>身份证号，是唯一的</li>
								<li>姓名</li>
								<li>电话号码</li>
								<li>家庭住址</li>
								<li>开始工作的日期</li>
								<li>是否是部门经理</li>
								<li>所属支行</li>
								<li>所属部门</li>
							</ul>
							<p>其中所属支行和部门采用 <code class="language-plaintext highlighter-rouge">t.references</code> 方法创建，该方法会自动创建一个 <code class="language-plaintext highlighter-rouge">table_id</code> 列和一个外键索引（由 <code class="language-plaintext highlighter-rouge">index: true</code> 指定）。同时这里设置了 <code class="language-plaintext highlighter-rouge">on_delete: :restrict</code>，表示当支行或部门有从属员工时禁止删除。</p>
							<h4 id="234-客户">2.3.4 客户</h4>
							<div class="language-ruby highlighter-rouge">
								<div class="highlight">
									<pre class="highlight"><code><span class="k">class</span> <span class="nc">CreateClients</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">6.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:clients</span><span class="p">,</span> <span class="ss">comment: </span><span class="s1">'客户'</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:person_id</span><span class="p">,</span> <span class="ss">limit: </span><span class="mi">18</span><span class="p">,</span> <span class="ss">unique: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">null: </span><span class="kp">false</span><span class="p">,</span> <span class="ss">comment: </span><span class="s1">'身份证号'</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">limit: </span><span class="mi">64</span><span class="p">,</span> <span class="ss">comment: </span><span class="s1">'姓名'</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:phone</span><span class="p">,</span> <span class="ss">limit: </span><span class="mi">64</span><span class="p">,</span> <span class="ss">comment: </span><span class="s1">'电话'</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:address</span><span class="p">,</span> <span class="ss">limit: </span><span class="mi">256</span><span class="p">,</span> <span class="ss">comment: </span><span class="s1">'地址'</span>

      <span class="n">t</span><span class="p">.</span><span class="nf">references</span> <span class="ss">:manager</span><span class="p">,</span> <span class="ss">null: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">index: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">foreign_key: </span><span class="p">{</span> <span class="ss">to_table: :staffs</span><span class="p">,</span> <span class="ss">on_delete: :restrict</span> <span class="p">}</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">integer</span> <span class="ss">:manager_type</span><span class="p">,</span> <span class="ss">limit: </span><span class="mi">1</span><span class="p">,</span> <span class="ss">default: </span><span class="mi">0</span><span class="p">,</span> <span class="ss">null: </span><span class="kp">true</span>

      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
								</div>
							</div>
							<p>每个客户具有六个属性：</p>
							<ul>
								<li>身份证号，是唯一的</li>
								<li>姓名</li>
								<li>电话号码</li>
								<li>家庭住址</li>
								<li>发生联系的员工（负责人）</li>
								<li>负责人类型（账户负责人 / 贷款负责人 / 两者皆是）</li>
							</ul>
							<p>每位客户还有一位联系人。出于实体独立性的考虑，联系人存在一张单独的表中，且该表使用客户 ID 作为主键（外键作主键），详细信息在 2.3.5 节介绍。</p>
							<p>每位客户还有一个或多个账户。根据实验要求，一个客户在一个支行只能开设每种类型的账户各一个，因此另外开一个表，对 $(客户,支行,账户类型)$ 加上唯一索引，详细信息在 2.3.7 节介绍。</p>
							<h4 id="235-客户的联系人">2.3.5 客户的联系人</h4>
							<div class="language-ruby highlighter-rouge">
								<div class="highlight">
									<pre class="highlight"><code><span class="k">class</span> <span class="nc">CreateContacts</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">6.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:contacts</span><span class="p">,</span> <span class="ss">id: </span><span class="kp">false</span><span class="p">,</span> <span class="ss">comment: </span><span class="s1">'联系人'</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">limit: </span><span class="mi">64</span><span class="p">,</span> <span class="ss">comment: </span><span class="s1">'姓名'</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:phone</span><span class="p">,</span> <span class="ss">limit: </span><span class="mi">64</span><span class="p">,</span> <span class="ss">comment: </span><span class="s1">'电话'</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">limit: </span><span class="mi">64</span><span class="p">,</span> <span class="ss">comment: </span><span class="s1">'Email'</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:relationship</span><span class="p">,</span> <span class="ss">limit: </span><span class="mi">64</span><span class="p">,</span> <span class="ss">comment: </span><span class="s1">'与客户关系'</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">references</span> <span class="ss">:client</span><span class="p">,</span> <span class="ss">primary_key: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">index: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">foreign_key: </span><span class="p">{</span> <span class="ss">on_delete: :cascade</span> <span class="p">}</span>

      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
								</div>
							</div>
							<p>每个联系人有五个属性：</p>
							<ul>
								<li>姓名</li>
								<li>电话</li>
								<li>Email</li>
								<li>与客户关系</li>
								<li>关联的客户</li>
							</ul>
							<p>该表没有独立的 ID 列（由 <code class="language-plaintext highlighter-rouge">create_table</code> 的参数 <code class="language-plaintext highlighter-rouge">id: false</code> 指定），使用 <code class="language-plaintext highlighter-rouge">client_id</code> 作主键（由 <code class="language-plaintext highlighter-rouge">t.references :client</code> 的 <code class="language-plaintext highlighter-rouge">primary_key: true</code> 指定）。每个联系人有一位关联客户，且当关联客户删除时联系人也一并删除（由 <code class="language-plaintext highlighter-rouge">t.references :client</code> 的 <code class="language-plaintext highlighter-rouge">on_delete: :cascade</code> 指定）。</p>
							<h4 id="236-账户">2.3.6 账户</h4>
							<div class="language-ruby highlighter-rouge">
								<div class="highlight">
									<pre class="highlight"><code><span class="k">class</span> <span class="nc">CreateAccounts</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">6.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:accounts</span><span class="p">,</span> <span class="ss">comment: </span><span class="s1">'账户'</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">references</span> <span class="ss">:branch</span><span class="p">,</span> <span class="ss">index: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">foreign_key: </span><span class="p">{</span> <span class="ss">on_delete: :restrict</span> <span class="p">},</span> <span class="ss">comment: </span><span class="s1">'开户支行'</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">references</span> <span class="ss">:accountable</span><span class="p">,</span> <span class="ss">null: </span><span class="kp">false</span><span class="p">,</span> <span class="ss">polymorphic: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">comment: </span><span class="s1">'类型账户ID'</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">decimal</span> <span class="ss">:balance</span><span class="p">,</span> <span class="ss">precision: </span><span class="mi">12</span><span class="p">,</span> <span class="ss">scale: </span><span class="mi">2</span><span class="p">,</span> <span class="ss">default: </span><span class="mf">0.0</span><span class="p">,</span> <span class="ss">comment: </span><span class="s1">'余额'</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">date</span> <span class="ss">:open_date</span><span class="p">,</span> <span class="ss">default: </span><span class="s1">'CURRENT_TIMESTAMP'</span><span class="p">,</span> <span class="ss">comment: </span><span class="s1">'开户日期'</span>

      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
								</div>
							</div>
							<p>每个账户有四个属性：</p>
							<ul>
								<li>所属支行</li>
								<li>账户类型及类型特定信息</li>
								<li>余额</li>
								<li>开户日期</li>
							</ul>
							<p>其中 <code class="language-plaintext highlighter-rouge">t.references :accountable</code> 表示账户类型以及类型特定的额外信息（如储蓄账户的利率和货币类型以及支票账户的透支额等），使用 Active Record 的<a href="https://guides.rubyonrails.org/association_basics.html#polymorphic-associations">多态关系 (Polymorphic Association)</a> 实现（由 <code class="language-plaintext highlighter-rouge">polymorphic: true</code> 指定），实际在数据库中记录为 <code class="language-plaintext highlighter-rouge">accountable_id</code> 和 <code class="language-plaintext highlighter-rouge">accountable_type</code> 两列，<code class="language-plaintext highlighter-rouge">accountable_id</code> 对应目标表的 ID 列为外键；<code class="language-plaintext highlighter-rouge">accountable_type</code> 为字符串，表示多态的具体类型，Active Record 根据该列决定要将哪个表作为关联表。该多态关系的两个具体类型：储蓄账户和支票账户分别在 2.3.8 节和 2.3.9 节详细介绍。</p>
							<p>每个账户还有一个或多个客户为所有者。根据实验要求，一个客户在一个支行只能开设每种类型的账户各一个，因此另外开一个表，对 $(客户,支行,账户类型)$ 加上唯一索引，详细信息在 2.3.7 节介绍。</p>
							<h4 id="237-客户账户关系">2.3.7 客户账户关系</h4>
							<div class="language-ruby highlighter-rouge">
								<div class="highlight">
									<pre class="highlight"><code><span class="k">class</span> <span class="nc">CreateOwnerships</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">6.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="c1"># (Client, Branch, AccountType) -&gt; Account</span>
    <span class="n">create_table</span> <span class="ss">:ownerships</span><span class="p">,</span> <span class="ss">comment: </span><span class="s1">'客户账户关系'</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">references</span> <span class="ss">:account</span><span class="p">,</span> <span class="ss">foreign_key: </span><span class="p">{</span> <span class="ss">on_delete: :cascade</span> <span class="p">}</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">references</span> <span class="ss">:client</span><span class="p">,</span> <span class="ss">foreign_key: </span><span class="p">{</span> <span class="ss">on_delete: :restrict</span> <span class="p">}</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">references</span> <span class="ss">:branch</span><span class="p">,</span> <span class="ss">foreign_key: </span><span class="p">{</span> <span class="ss">on_delete: :restrict</span> <span class="p">}</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:accountable_type</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">datetime</span> <span class="ss">:last_access</span><span class="p">,</span> <span class="ss">default: </span><span class="o">-&gt;</span> <span class="p">{</span> <span class="s1">'CURRENT_TIMESTAMP'</span> <span class="p">},</span> <span class="ss">comment: </span><span class="s1">'最近访问'</span>

      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
								</div>
							</div>
							<p>每个客户账户关系有五个属性：</p>
							<ul>
								<li>关联的账户</li>
								<li>关联的客户</li>
								<li>关联的支行</li>
								<li>账户类型</li>
								<li>最近访问时间</li>
							</ul>
							<p>该表的主要目的是实现实验要求中「一个客户在一个支行内最多只能开设一个储蓄账户和一个支票账户」一项，同时记录「每个帐户所有者访问该帐户的最近日期」。</p>
							<p>其中关联的支行和账户类型为账户中的信息，但是为了实现开设账户的约束，需要对元组 $(客户,支行,账户类型)$ 加上唯一索引（unique index），因此将这两列信息也加入本表。</p>
							<p>同时与本表关联的还有一个索引，其内容和意义如上所述。代码如下：</p>
							<div class="language-ruby highlighter-rouge">
								<div class="highlight">
									<pre class="highlight"><code><span class="k">class</span> <span class="nc">AddIndexToOwnerships</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">6.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">add_index</span> <span class="ss">:ownerships</span><span class="p">,</span> <span class="sx">%i[branch_id accountable_type client_id]</span><span class="p">,</span> <span class="ss">unique: </span><span class="kp">true</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
								</div>
							</div>
							<h4 id="238-储蓄账户多态关联">2.3.8 储蓄账户（多态关联）</h4>
							<div class="language-ruby highlighter-rouge">
								<div class="highlight">
									<pre class="highlight"><code><span class="k">class</span> <span class="nc">CreateDepositAccounts</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">6.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:deposit_accounts</span><span class="p">,</span> <span class="ss">comment: </span><span class="s1">'储蓄账户'</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">float</span> <span class="ss">:interest_rate</span><span class="p">,</span> <span class="ss">default: </span><span class="mf">1.0</span><span class="p">,</span> <span class="ss">comment: </span><span class="s1">'利率'</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:currency</span><span class="p">,</span> <span class="ss">limit: </span><span class="mi">3</span><span class="p">,</span> <span class="ss">default: </span><span class="s1">'BTC'</span><span class="p">,</span> <span class="ss">comment: </span><span class="s1">'货币类型'</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
								</div>
							</div>
							<p>每个储蓄账户在账户的基础上有两个额外属性：</p>
							<ul>
								<li>利率</li>
								<li>货币类型</li>
							</ul>
							<p>其中利率并非「金额」，因此采用浮点数存储；货币类型根据 ISO 4217 标准存储为 3 位大写字母，其中「3 位大写字母」由 Active Record 模型进行验证，而不是在数据库中验证，详细信息在 3.1 节介绍。</p>
							<h4 id="239-支票账户多态关联">2.3.9 支票账户（多态关联）</h4>
							<div class="language-ruby highlighter-rouge">
								<div class="highlight">
									<pre class="highlight"><code><span class="k">class</span> <span class="nc">CreateCheckAccounts</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">6.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:check_accounts</span><span class="p">,</span> <span class="ss">comment: </span><span class="s1">'支票账户'</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">decimal</span> <span class="ss">:withdraw_amount</span><span class="p">,</span> <span class="ss">precision: </span><span class="mi">12</span><span class="p">,</span> <span class="ss">scale: </span><span class="mi">2</span><span class="p">,</span> <span class="ss">default: </span><span class="mf">0.0</span><span class="p">,</span> <span class="ss">comment: </span><span class="s1">'透支额'</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
								</div>
							</div>
							<p>每个支票账户在账户的基础上有一个额外属性：</p>
							<ul>
								<li>透支额</li>
							</ul>
							<h4 id="2310-贷款">2.3.10 贷款</h4>
							<div class="language-ruby highlighter-rouge">
								<div class="highlight">
									<pre class="highlight"><code><span class="k">class</span> <span class="nc">CreateLoans</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">6.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:loans</span><span class="p">,</span> <span class="ss">comment: </span><span class="s1">'贷款'</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">decimal</span> <span class="ss">:amount</span><span class="p">,</span> <span class="ss">precision: </span><span class="mi">12</span><span class="p">,</span> <span class="ss">scale: </span><span class="mi">2</span><span class="p">,</span> <span class="ss">default: </span><span class="mf">0.0</span><span class="p">,</span> <span class="ss">comment: </span><span class="s1">'金额'</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">references</span> <span class="ss">:branch</span><span class="p">,</span> <span class="ss">index: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">foreign_key: </span><span class="p">{</span> <span class="ss">on_delete: :restrict</span> <span class="p">}</span>

      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
								</div>
							</div>
							<p>每个贷款有两个属性：</p>
							<ul>
								<li>所属支行</li>
								<li>总金额</li>
							</ul>
							<p>每个贷款还有一个或多个关联客户，采用普通的多对多关系，因此使用一张额外的表记录客户与贷款的关系，详细信息在 2.3.11 节中介绍。</p>
							<h4 id="2311-客户贷款关系">2.3.11 客户贷款关系</h4>
							<div class="language-ruby highlighter-rouge">
								<div class="highlight">
									<pre class="highlight"><code><span class="k">class</span> <span class="nc">CreateClientsLoans</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">6.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:clients_loans</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">references</span> <span class="ss">:loan</span><span class="p">,</span> <span class="ss">index: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">foreign_key: </span><span class="p">{</span> <span class="ss">on_delete: :cascade</span> <span class="p">}</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">references</span> <span class="ss">:client</span><span class="p">,</span> <span class="ss">index: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">foreign_key: </span><span class="p">{</span> <span class="ss">on_delete: :restrict</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
								</div>
							</div>
							<p>每个客户贷款关系有两个属性：</p>
							<ul>
								<li>关联贷款</li>
								<li>关联客户</li>
							</ul>
							<p>该表作为贷款——客户的多对多关系的中间表，没有额外属性。但是根据实验要求，贷款可以删除，但当客户有关联贷款时客户不能删除，所以该表的两个外键索引具有不同的 <code class="language-plaintext highlighter-rouge">on_delete</code> 设定。</p>
							<h4 id="2312-贷款发放">2.3.12 贷款发放</h4>
							<div class="language-ruby highlighter-rouge">
								<div class="highlight">
									<pre class="highlight"><code><span class="k">class</span> <span class="nc">CreateIssues</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">6.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:issues</span><span class="p">,</span> <span class="ss">comment: </span><span class="s1">'逐次支付'</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">references</span> <span class="ss">:loan</span><span class="p">,</span> <span class="ss">index: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">foreign_key: </span><span class="p">{</span> <span class="ss">on_delete: :cascade</span> <span class="p">}</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">date</span> <span class="ss">:date</span><span class="p">,</span> <span class="ss">default: </span><span class="s1">'CURRENT_TIMESTAMP'</span><span class="p">,</span> <span class="ss">comment: </span><span class="s1">'日期'</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">decimal</span> <span class="ss">:amount</span><span class="p">,</span> <span class="ss">precision: </span><span class="mi">12</span><span class="p">,</span> <span class="ss">scale: </span><span class="mi">2</span><span class="p">,</span> <span class="ss">default: </span><span class="mf">0.0</span><span class="p">,</span> <span class="ss">comment: </span><span class="s1">'金额'</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
								</div>
							</div>
							<p>每个贷款发放有三个属性：</p>
							<ul>
								<li>关联贷款</li>
								<li>发放日期</li>
								<li>发放金额</li>
							</ul>
							<h2 id="3-详细设计">3 详细设计</h2>
							<h3 id="31-active-record-模型">3.1 Active Record 模型</h3>
							<h4 id="311-支行">3.1.1 支行</h4>
							<div class="language-ruby highlighter-rouge">
								<div class="highlight">
									<pre class="highlight"><code><span class="k">class</span> <span class="nc">Branch</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:staffs</span><span class="p">,</span> <span class="ss">dependent: :restrict_with_error</span>
  <span class="n">has_many</span> <span class="ss">:ownerships</span><span class="p">,</span> <span class="ss">dependent: :restrict_with_error</span>
  <span class="n">has_many</span> <span class="ss">:accounts</span><span class="p">,</span> <span class="ss">through: :ownerships</span>
  <span class="n">has_many</span> <span class="ss">:loans</span><span class="p">,</span> <span class="ss">dependent: :restrict_with_error</span>

  <span class="n">validates_uniqueness_of</span> <span class="ss">:name</span>
  <span class="n">validates_presence_of</span> <span class="ss">:city</span>
  <span class="n">validates_numericality_of</span> <span class="ss">:assets</span><span class="p">,</span> <span class="ss">greater_than_or_equal_to: </span><span class="mf">0.0</span>
<span class="k">end</span>
</code></pre>
								</div>
							</div>
							<p>每个支行有多个员工、多个账户和多个贷款，使用 Active Record 的 <code class="language-plaintext highlighter-rouge">has_many</code> 定义关系，<code class="language-plaintext highlighter-rouge">dependent: :restrict_with_error</code> 指示当支行有关联项目时不允许删除。同时支行名称不能重复，所以加上唯一性验证（见 2.3.1 节）。剩下的支行城市验证非空，资产验证非负。</p>
							<h4 id="312-部门">3.1.2 部门</h4>
							<div class="language-ruby highlighter-rouge">
								<div class="highlight">
									<pre class="highlight"><code><span class="k">class</span> <span class="nc">Department</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:staffs</span><span class="p">,</span> <span class="ss">dependent: :restrict_with_error</span>

  <span class="n">validates_presence_of</span> <span class="ss">:name</span>
  <span class="n">validates_presence_of</span> <span class="ss">:kind</span>
<span class="k">end</span>
</code></pre>
								</div>
							</div>
							<p>每个部门有多个员工，同时部门名称和部门类型非空。这里由于部门号是主键，所以名称就不需要验证无重复了。</p>
							<h4 id="313-员工">3.1.3 员工</h4>
							<p>由于员工和客户有多个共同的属性，因此建立一个基类用于继承：</p>
							<div class="language-ruby highlighter-rouge">
								<div class="highlight">
									<pre class="highlight"><code><span class="k">class</span> <span class="nc">Person</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">abstract_class</span> <span class="o">=</span> <span class="kp">true</span>

  <span class="n">validates_uniqueness_of</span> <span class="ss">:person_id</span>
  <span class="c1">#validate :valid_person_id?</span>
  <span class="n">validates_presence_of</span> <span class="ss">:name</span>
  <span class="n">validates_presence_of</span> <span class="ss">:phone</span>
  <span class="n">validates_presence_of</span> <span class="ss">:address</span>

  <span class="k">def</span> <span class="nf">valid_person_id?</span>
    <span class="n">errors</span><span class="p">.</span><span class="nf">add</span> <span class="ss">:person_id</span><span class="p">,</span> <span class="s1">'Invalid personal ID'</span> <span class="k">unless</span> <span class="n">person_id</span> <span class="o">=~</span> <span class="sr">%r![0-9]{17}[0-9xX]!</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
								</div>
							</div>
							<p>这里为 Person 验证身份证号的唯一性，以及姓名电话地址非空。考虑到身份证号的合法性在本实验中并不重要，为了方便测试，就不验证身份证号的内容了（<code class="language-plaintext highlighter-rouge">validate :valid_person_id?</code> 即是按照中国身份证号的格式进行简单验证的操作）。</p>
							<div class="language-ruby highlighter-rouge">
								<div class="highlight">
									<pre class="highlight"><code><span class="k">class</span> <span class="nc">Staff</span> <span class="o">&lt;</span> <span class="no">Person</span>
  <span class="n">belongs_to</span> <span class="ss">:branch</span>
  <span class="n">belongs_to</span> <span class="ss">:department</span>

  <span class="n">has_many</span> <span class="ss">:clients</span><span class="p">,</span> <span class="ss">foreign_key: :manager_id</span><span class="p">,</span> <span class="ss">dependent: :restrict_with_error</span>
<span class="k">end</span>
</code></pre>
								</div>
							</div>
							<p>每个员工属于一个支行和一个部门（即数据库里有 <code class="language-plaintext highlighter-rouge">branch_id</code> 和 <code class="language-plaintext highlighter-rouge">department_id</code> 列），同时有多个客户。但是由于客户表里关联员工的列名并不是 <code class="language-plaintext highlighter-rouge">staff_id</code>，需要使用 <code class="language-plaintext highlighter-rouge">foreign_key</code> 参数指定。</p>
							<h4 id="314-客户">3.1.4 客户</h4>
							<div class="language-ruby highlighter-rouge">
								<div class="highlight">
									<pre class="highlight"><code><span class="k">class</span> <span class="nc">Client</span> <span class="o">&lt;</span> <span class="no">Person</span>
  <span class="n">belongs_to</span> <span class="ss">:manager</span><span class="p">,</span> <span class="ss">class_name: :Staff</span>
  <span class="n">has_one</span> <span class="ss">:contact</span><span class="p">,</span> <span class="ss">dependent: :destroy</span>
  <span class="n">has_many</span> <span class="ss">:ownerships</span><span class="p">,</span> <span class="ss">dependent: :restrict_with_error</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:accounts</span><span class="p">,</span> <span class="ss">through: :ownerships</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:loans</span><span class="p">,</span> <span class="ss">dependent: :restrict_with_error</span>

  <span class="n">accepts_nested_attributes_for</span> <span class="ss">:contact</span><span class="p">,</span> <span class="ss">update_only: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">allow_destroy: </span><span class="kp">true</span>
<span class="k">end</span>
</code></pre>
								</div>
							</div>
							<p>每个客户属于一个负责人，这里 <code class="language-plaintext highlighter-rouge">belongs_to :manager</code> 指定数据库的列名为 <code class="language-plaintext highlighter-rouge">manager_id</code>，通过 <code class="language-plaintext highlighter-rouge">class_name</code> 指定实际关系类型为 Staff 而不是 Manager。同时每个客户有一个联系人，<code class="language-plaintext highlighter-rouge">dependent: :destroy</code> 指定删除客户时将联系人一并删除。<code class="language-plaintext highlighter-rouge">has_and_belongs_to_many :accounts, through: :ownerships</code> 表示客户并不直接与账户关联（没有 <code class="language-plaintext highlighter-rouge">account_id</code> 外键列），而是通过 Ownership 作为“中间类”与账户有多对多的关联，即客户账户关系需要经过 <code class="language-plaintext highlighter-rouge">ownerships</code> 进行一次额外的 JOIN。<code class="language-plaintext highlighter-rouge">accepts_nested_attributes_for :contact</code> 表示从网页提交的表单中接受联系人信息，这是因为默认情况下出于安全起见不允许通过表单直接修改关联实体。</p>
							<h4 id="315-联系人">3.1.5 联系人</h4>
							<div class="language-ruby highlighter-rouge">
								<div class="highlight">
									<pre class="highlight"><code><span class="k">class</span> <span class="nc">Contact</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:client</span>

  <span class="n">validates_presence_of</span> <span class="ss">:name</span>
  <span class="n">validates_presence_of</span> <span class="ss">:phone</span>
  <span class="n">validates_presence_of</span> <span class="ss">:email</span>
  <span class="n">validates_presence_of</span> <span class="ss">:relationship</span>
<span class="k">end</span>
</code></pre>
								</div>
							</div>
							<p>联系人这里没有太多需要解释的，验证所有属性非空即可。</p>
							<h4 id="316-账户">3.1.6 账户</h4>
							<div class="language-ruby highlighter-rouge">
								<div class="highlight">
									<pre class="highlight"><code><span class="k">class</span> <span class="nc">Account</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:branch</span>
  <span class="n">belongs_to</span> <span class="ss">:accountable</span><span class="p">,</span> <span class="ss">polymorphic: </span><span class="kp">true</span>
  <span class="n">has_many</span> <span class="ss">:ownerships</span><span class="p">,</span> <span class="ss">dependent: :destroy</span>
  <span class="c1">#has_and_belongs_to_many :clients, through: :ownerships</span>

  <span class="n">accepts_nested_attributes_for</span> <span class="ss">:accountable</span><span class="p">,</span> <span class="ss">:ownerships</span><span class="p">,</span> <span class="ss">update_only: </span><span class="kp">true</span>

  <span class="n">validate</span> <span class="ss">:check_balance</span>
  <span class="n">validate</span> <span class="ss">:validate_owners</span>

  <span class="c1"># Credits: https://stackoverflow.com/a/32915379/5958455</span>
  <span class="k">def</span> <span class="nf">build_accountable</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">accountable</span> <span class="o">=</span> <span class="n">accountable_type</span><span class="p">.</span><span class="nf">safe_constantize</span><span class="p">.</span><span class="nf">new</span> <span class="n">params</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">validate_owners</span>
    <span class="n">errors</span><span class="p">.</span><span class="nf">add</span> <span class="ss">:base</span><span class="p">,</span> <span class="s1">'关联客户至少有一位'</span> <span class="k">if</span> <span class="n">ownerships</span><span class="p">.</span><span class="nf">empty?</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">check_balance</span>
    <span class="k">case</span> <span class="n">accountable_type</span>
    <span class="k">when</span> <span class="s1">'DepositAccount'</span>
      <span class="n">errors</span><span class="p">.</span><span class="nf">add</span> <span class="ss">:base</span><span class="p">,</span> <span class="s1">'储蓄账户不允许欠款'</span> <span class="k">if</span> <span class="n">balance</span> <span class="o">&lt;</span> <span class="mf">0.0</span>
    <span class="k">when</span> <span class="s1">'CheckAccount'</span>
      <span class="n">errors</span><span class="p">.</span><span class="nf">add</span> <span class="ss">:base</span><span class="p">,</span> <span class="s1">'支票账户欠款不允许超过透支额'</span> <span class="k">if</span> <span class="n">balance</span> <span class="o">+</span> <span class="n">accountable</span><span class="p">.</span><span class="nf">withdraw_amount</span> <span class="o">&lt;</span> <span class="mf">0.0</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
								</div>
							</div>
							<p>账户这里主要是多态关联的具体账户类型，<code class="language-plaintext highlighter-rouge">belongs_to :accountable, polymorphic: true</code> 表示数据库中有一列 <code class="language-plaintext highlighter-rouge">accountable_type</code> 指示实际的关联类型。其次就是验证账户必须要有至少一位客户作为所有者，同时对账户余额进行一些符合逻辑的验证。</p>
							<h4 id="317-账户类型">3.1.7 账户类型</h4>
							<p>由于储蓄账户和支票账户都是“具体账户类型”，因此使用一个 Active Record Concern 将公共元素提取出来：</p>
							<div class="language-ruby highlighter-rouge">
								<div class="highlight">
									<pre class="highlight"><code><span class="k">module</span> <span class="nn">Accountable</span>
  <span class="kp">extend</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Concern</span>

  <span class="n">included</span> <span class="k">do</span>
    <span class="n">has_one</span> <span class="ss">:account</span><span class="p">,</span> <span class="ss">as: :accountable</span><span class="p">,</span> <span class="ss">dependent: :destroy</span>

    <span class="n">accepts_nested_attributes_for</span> <span class="ss">:account</span>

    <span class="n">validates_presence_of</span> <span class="ss">:account</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
								</div>
							</div>
							<p>接下来就可以使用这个公共元素作为 mixin 了：</p>
							<div class="language-ruby highlighter-rouge">
								<div class="highlight">
									<pre class="highlight"><code><span class="k">class</span> <span class="nc">DepositAccount</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="kp">include</span> <span class="no">Accountable</span>

  <span class="n">validates_numericality_of</span> <span class="ss">:interest_rate</span><span class="p">,</span> <span class="ss">greater_than_or_equal_to: </span><span class="mf">0.0</span>
<span class="k">end</span>
</code></pre>
								</div>
							</div>
							<div class="language-ruby highlighter-rouge">
								<div class="highlight">
									<pre class="highlight"><code><span class="k">class</span> <span class="nc">CheckAccount</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="kp">include</span> <span class="no">Accountable</span>
<span class="k">end</span>
</code></pre>
								</div>
							</div>
							<p>这里没有太多需要解释的，显然储蓄账户的利率不能为负。</p>
							<h4 id="318-客户账户关系">3.1.8 客户账户关系</h4>
							<div class="language-ruby highlighter-rouge">
								<div class="highlight">
									<pre class="highlight"><code><span class="k">class</span> <span class="nc">Ownership</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:branch</span>
  <span class="n">belongs_to</span> <span class="ss">:client</span>
  <span class="n">belongs_to</span> <span class="ss">:account</span>

  <span class="n">validates_uniqueness_of</span> <span class="ss">:client</span><span class="p">,</span> <span class="ss">scope: </span><span class="sx">%i[branch accountable_type]</span>

  <span class="n">before_save</span> <span class="ss">:update_access_time</span>
  <span class="n">before_destroy</span> <span class="ss">:check_owners_count</span>

  <span class="k">def</span> <span class="nf">update_access_time</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">last_access</span> <span class="o">=</span> <span class="no">Time</span><span class="p">.</span><span class="nf">now</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">check_owners_count</span>
    <span class="k">return</span> <span class="k">if</span> <span class="n">account</span><span class="p">.</span><span class="nf">ownerships</span><span class="p">.</span><span class="nf">count</span> <span class="o">&gt;</span> <span class="mi">1</span>
    <span class="n">errors</span><span class="p">.</span><span class="nf">add</span> <span class="ss">:base</span><span class="p">,</span> <span class="s1">'关联客户至少有一位'</span>
    <span class="kp">throw</span> <span class="ss">:abort</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
								</div>
							</div>
							<p>每个关系属于一个客户和一个账户，如 2.3.7 节所述，额外加入了账户所属支行和账户类型用于进行唯一性约束。同时使用 Active Record 的 <code class="language-plaintext highlighter-rouge">before_save</code> 钩子在每次修改时更新「客户最近访问账户时间」，并使用 <code class="language-plaintext highlighter-rouge">before_destroy</code> 在删除前确保至少有两位客户（不能删掉一个账户的最后一位关联客户）。</p>
							<h4 id="319-贷款">3.1.9 贷款</h4>
							<div class="language-ruby highlighter-rouge">
								<div class="highlight">
									<pre class="highlight"><code><span class="k">class</span> <span class="nc">Loan</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:branch</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:clients</span>
  <span class="n">has_many</span> <span class="ss">:issues</span><span class="p">,</span> <span class="ss">dependent: :destroy</span>

  <span class="n">validates_presence_of</span> <span class="ss">:clients</span>
  <span class="n">validates_numericality_of</span> <span class="ss">:amount</span><span class="p">,</span> <span class="ss">greater_than: </span><span class="mf">0.0</span>

  <span class="n">before_destroy</span> <span class="ss">:check_issuing</span>

  <span class="k">def</span> <span class="nf">check_issuing</span>
    <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="ss">:issuing</span>
      <span class="n">errors</span><span class="p">.</span><span class="nf">add</span> <span class="ss">:base</span><span class="p">,</span> <span class="s1">'发放中的贷款不允许删除'</span>
      <span class="kp">throw</span> <span class="ss">:abort</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">status</span>
    <span class="k">if</span> <span class="n">issues</span><span class="p">.</span><span class="nf">empty?</span>
      <span class="ss">:unissued</span>
    <span class="k">elsif</span> <span class="n">issues</span><span class="p">.</span><span class="nf">sum</span><span class="p">(</span><span class="ss">:amount</span><span class="p">)</span> <span class="o">==</span> <span class="n">amount</span>
      <span class="ss">:issued</span>
    <span class="k">else</span>
      <span class="ss">:issuing</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">remaining</span>
    <span class="vi">@remaining</span> <span class="o">||=</span> <span class="n">amount</span> <span class="o">-</span> <span class="n">issues</span><span class="p">.</span><span class="nf">sum</span><span class="p">(</span><span class="ss">:amount</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">reset_remaining</span>
    <span class="vi">@remaining</span> <span class="o">=</span> <span class="kp">nil</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
								</div>
							</div>
							<p>贷款这里多了几个函数，主要是提供了支付状态属性（从数据库计算）以及利用该支付状态属性在删除前进行验证。同时对贷款的验证主要就一个大于零，因为数额为零的贷款没有意义。</p>
							<h4 id="3110-贷款支付">3.1.10 贷款支付</h4>
							<div class="language-ruby highlighter-rouge">
								<div class="highlight">
									<pre class="highlight"><code><span class="k">class</span> <span class="nc">Issue</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:loan</span>

  <span class="n">validates_numericality_of</span> <span class="ss">:amount</span><span class="p">,</span> <span class="ss">greater_than: </span><span class="mf">0.0</span>
  <span class="n">validate</span> <span class="ss">:check_amount</span><span class="p">,</span> <span class="ss">on: :create</span>

  <span class="k">def</span> <span class="nf">check_amount</span>
    <span class="k">if</span> <span class="n">amount</span> <span class="o">&gt;</span> <span class="n">loan</span><span class="p">.</span><span class="nf">remaining</span>
      <span class="n">errors</span><span class="p">.</span><span class="nf">add</span> <span class="ss">:base</span><span class="p">,</span> <span class="s1">'支付不能超出贷款总额'</span>
    <span class="k">else</span>
      <span class="n">loan</span><span class="p">.</span><span class="nf">reset_remaining</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
								</div>
							</div>
							<p>贷款支付的主要内容就是验证，一个是大于零（同样，一笔零元的支付是没有意义的），一个是支付后不能超出贷款总额。</p>
							<h3 id="32-action-controller-控制器">3.2 Action Controller 控制器</h3>
							<h4 id="321-默认动作--共同动作">3.2.1 默认动作 / 共同动作</h4>
							<p><code class="language-plaintext highlighter-rouge">rails generate scaffold_controller</code> 会生成很多默认代码 / 模板代码，其中不少都直接采用了，没有进行额外的加工，因此这些动作在六大类模型（支行、部门、员工、客户、账户、贷款）中基本一致，所以放在开头一个单独的小节统一介绍，以下小节只介绍对应控制器与默认的不同之处。</p>
							<p>Rails 自动生成的控制器包含了 7 个动作：</p>
							<ul>
								<li>
									<code class="language-plaintext highlighter-rouge">index</code>：列出对应模型的全部对象</li>
								<li>
									<code class="language-plaintext highlighter-rouge">show</code>：根据 <code class="language-plaintext highlighter-rouge">id</code> 为一个对象显示详情</li>
								<li>
									<code class="language-plaintext highlighter-rouge">new</code>：显示“新建对象”页面，渲染网页表单（Form）</li>
								<li>
									<code class="language-plaintext highlighter-rouge">edit</code>：显示“编辑对象”页面，渲染网页表单</li>
								<li>
									<code class="language-plaintext highlighter-rouge">create</code>：实际创建对象的动作，采用 HTTP POST 方式，一般通过点击「新建」页面的【提交】按钮触发</li>
								<li>
									<code class="language-plaintext highlighter-rouge">update</code>：实际修改对象的动作，采用 HTTP PATCH 方式，一般通过点击「编辑」页面的【提交】按钮触发</li>
								<li>
									<code class="language-plaintext highlighter-rouge">destroy</code>：删除对象的动作，采用 HTTP DELETE 方式，一般通过点击「删除」按钮触发</li>
							</ul>
							<p>其中部分动作包含一些默认代码（如 index 中的 <code class="language-plaintext highlighter-rouge">@objects = Object.all</code>）以使其立即可用。</p>
							<p>另外还包括两个助手方法（helper methods）：</p>
							<ul>
								<li>
									<code class="language-plaintext highlighter-rouge">set_object</code>：对于 show, edit, update, destroy 这四个动作，查询数据库获得当前正在操作对象以便使用数据。使用 <code class="language-plaintext highlighter-rouge">before_action</code> 钩子自动调用</li>
								<li>
									<code class="language-plaintext highlighter-rouge">object_params</code>：过滤传入的参数，指定必须存在的参数（如要创建 / 修改的对象）及可接受的参数</li>
							</ul>
							<p>下面以部门控制器 <code class="language-plaintext highlighter-rouge">DepartmentsController</code> 的代码为例，展示这部分“默认动作”：</p>
							<div class="language-ruby highlighter-rouge">
								<div class="highlight">
									<pre class="highlight"><code><span class="k">class</span> <span class="nc">DepartmentsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:set_department</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[show edit update destroy]</span>

  <span class="c1"># GET /departments</span>
  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@departments</span> <span class="o">=</span> <span class="no">Department</span><span class="p">.</span><span class="nf">order</span><span class="p">(</span><span class="ss">:id</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="c1"># GET /departments/1</span>
  <span class="k">def</span> <span class="nf">show</span>
  <span class="k">end</span>

  <span class="c1"># GET /departments/new</span>
  <span class="k">def</span> <span class="nf">new</span>
    <span class="vi">@department</span> <span class="o">=</span> <span class="no">Department</span><span class="p">.</span><span class="nf">new</span>
  <span class="k">end</span>

  <span class="c1"># GET /departments/1/edit</span>
  <span class="k">def</span> <span class="nf">edit</span>
  <span class="k">end</span>

  <span class="c1"># POST /departments</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@department</span> <span class="o">=</span> <span class="no">Department</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">department_params</span><span class="p">)</span>

    <span class="k">if</span> <span class="vi">@department</span><span class="p">.</span><span class="nf">save</span>
      <span class="n">redirect_to</span> <span class="vi">@department</span><span class="p">,</span> <span class="ss">success: </span><span class="s1">'成功创建部门'</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="ss">:new</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="c1"># PATCH/PUT /departments/1</span>
  <span class="k">def</span> <span class="nf">update</span>
    <span class="k">if</span> <span class="vi">@department</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">department_params</span><span class="p">)</span>
      <span class="n">redirect_to</span> <span class="vi">@department</span><span class="p">,</span> <span class="ss">success: </span><span class="s1">'成功更新部门'</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="ss">:edit</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="c1"># DELETE /departments/1</span>
  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="k">if</span> <span class="vi">@department</span><span class="p">.</span><span class="nf">destroy</span>
      <span class="n">redirect_to</span> <span class="n">departments_url</span><span class="p">,</span> <span class="ss">success: </span><span class="s1">'部门已删除'</span>
    <span class="k">else</span>
      <span class="n">redirect_back</span> <span class="ss">fallback_location: </span><span class="n">departments_url</span><span class="p">,</span> <span class="ss">alert: </span><span class="s1">'部门删除失败'</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kp">private</span>
    <span class="c1"># Use callbacks to share common setup or constraints between actions.</span>
    <span class="k">def</span> <span class="nf">set_department</span>
      <span class="vi">@department</span> <span class="o">=</span> <span class="no">Department</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
    <span class="k">end</span>

    <span class="c1"># Only allow a list of trusted parameters through.</span>
    <span class="k">def</span> <span class="nf">department_params</span>
      <span class="n">params</span><span class="p">.</span><span class="nf">require</span><span class="p">(</span><span class="ss">:department</span><span class="p">).</span><span class="nf">permit</span><span class="p">(</span><span class="sx">%i[name kind]</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre>
								</div>
							</div>
							<h4 id="322-路由">3.2.2 路由</h4>
							<p>服务器需要知道客户端（浏览器）访问的 URL 应该分派到哪个控制器的哪个动作上，以及如何解析 URL 中的参数（如数字 ID 等）。该部分路由配置位于 <code class="language-plaintext highlighter-rouge">config/routes.rb</code>。</p>
							<p>由于这部分没有自己实现的特别逻辑等，因此 Rails 的官方文档完全可以胜任本节的解释工作，故不在此重复，仅附上链接：<a href="https://guides.rubyonrails.org/routing.html">https://guides.rubyonrails.org/routing.html</a></p>
							<h4 id="323-支行控制器">3.2.3 支行控制器</h4>
							<p>支行控制器 <code class="language-plaintext highlighter-rouge">BranchesController</code> 实现了 <code class="language-plaintext highlighter-rouge">staffs</code>，<code class="language-plaintext highlighter-rouge">accounts</code> 和 <code class="language-plaintext highlighter-rouge">loans</code> 三个额外的动作，分别路由至</p>
							<div class="language-text highlighter-rouge">
								<div class="highlight">
									<pre class="highlight"><code>GET /branches/:id/accounts
GET /branches/:id/staffs
GET /branches/:id/loans
</code></pre>
								</div>
							</div>
							<p>用于列出与支行关联的员工、账户和贷款，相关代码如下：</p>
							<div class="language-ruby highlighter-rouge">
								<div class="highlight">
									<pre class="highlight"><code><span class="k">class</span> <span class="nc">BranchesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:set_branch</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[show accounts loans staffs edit update destroy]</span>
  <span class="n">before_action</span> <span class="ss">:set_staffs</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[show staffs]</span>
  <span class="n">before_action</span> <span class="ss">:set_accounts</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[show accounts]</span>
  <span class="n">before_action</span> <span class="ss">:set_loans</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[show loans]</span>

  <span class="kp">private</span>
    <span class="k">def</span> <span class="nf">set_branch</span>
      <span class="vi">@branch</span> <span class="o">=</span> <span class="no">Branch</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">set_staffs</span>
      <span class="vi">@staffs</span> <span class="o">=</span> <span class="no">Staff</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">branch: </span><span class="vi">@branch</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">set_accounts</span>
      <span class="vi">@accounts</span> <span class="o">=</span> <span class="no">Account</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">branch: </span><span class="vi">@branch</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">set_loans</span>
      <span class="vi">@loans</span> <span class="o">=</span> <span class="no">Loan</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">branch: </span><span class="vi">@branch</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre>
								</div>
							</div>
							<p>对应的，Action View 会自动渲染 <code class="language-plaintext highlighter-rouge">branches/accounts.html.erb</code> 等模板，相关内容在 3.3 节详细介绍。</p>
							<h4 id="324-部门控制器">3.2.4 部门控制器</h4>
							<p>部门控制器实现了 <code class="language-plaintext highlighter-rouge">staffs</code> 一个额外的动作，路由至 <code class="language-plaintext highlighter-rouge">GET /departments/:id/staffs</code>，用于列出部门下属的员工，相关代码如下：</p>
							<div class="language-ruby highlighter-rouge">
								<div class="highlight">
									<pre class="highlight"><code><span class="k">class</span> <span class="nc">DepartmentsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:set_department</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[show staffs edit update destroy]</span>
  <span class="n">before_action</span> <span class="ss">:set_staffs</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[show staffs]</span>

  <span class="kp">private</span>
    <span class="k">def</span> <span class="nf">set_department</span>
      <span class="vi">@department</span> <span class="o">=</span> <span class="no">Department</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">set_staffs</span>
      <span class="vi">@staffs</span> <span class="o">=</span> <span class="no">Staff</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">department: </span><span class="vi">@department</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre>
								</div>
							</div>
							<h4 id="325-员工控制器">3.2.5 员工控制器</h4>
							<p>员工控制器实现了 <code class="language-plaintext highlighter-rouge">clients</code> 一个额外的工作，路由至 <code class="language-plaintext highlighter-rouge">GET /staffs/:id/clients</code>，用于列出该员工负责的客户。另外，为了显示员工所属的支行和部门，查询时默认连结了支行和部门的表，并从两个表中选取名称列。相关代码如下：</p>
							<div class="language-ruby highlighter-rouge">
								<div class="highlight">
									<pre class="highlight"><code><span class="k">class</span> <span class="nc">StaffsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:set_staff</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[show clients edit update destroy]</span>
  <span class="n">before_action</span> <span class="ss">:set_clients</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[show clients]</span>

  <span class="kp">private</span>
    <span class="k">def</span> <span class="nf">staffs</span>
      <span class="vi">@staffs</span> <span class="o">||=</span> <span class="no">Staff</span><span class="p">.</span><span class="nf">joins</span><span class="p">(</span><span class="ss">:branch</span><span class="p">,</span> <span class="ss">:department</span><span class="p">).</span><span class="nf">select</span><span class="p">(</span><span class="s1">'staffs.*'</span><span class="p">,</span> <span class="s1">'branches.name AS branch_name'</span><span class="p">,</span> <span class="s1">'departments.name AS department_name'</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">set_clients</span>
      <span class="vi">@clients</span> <span class="o">=</span> <span class="no">Client</span><span class="p">.</span><span class="nf">joins</span><span class="p">(</span><span class="ss">:manager</span><span class="p">).</span><span class="nf">where</span><span class="p">(</span><span class="ss">manager: </span><span class="vi">@staff</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre>
								</div>
							</div>
							<h4 id="326-客户控制器">3.2.6 客户控制器</h4>
							<p>客户控制器实现了 <code class="language-plaintext highlighter-rouge">accounts</code> 和 <code class="language-plaintext highlighter-rouge">loans</code> 两个额外的动作，分别路由至</p>
							<div class="language-text highlighter-rouge">
								<div class="highlight">
									<pre class="highlight"><code>GET /clients/:id/accounts
GET /clients/:id/loans
</code></pre>
								</div>
							</div>
							<p>用于列出与客户关联的账户及贷款，相关代码如下：</p>
							<div class="language-ruby highlighter-rouge">
								<div class="highlight">
									<pre class="highlight"><code><span class="k">class</span> <span class="nc">ClientsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="kp">include</span> <span class="no">AccountsHelper</span>

  <span class="n">before_action</span> <span class="ss">:set_client</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[edit update destroy accounts loans]</span>

  <span class="c1"># GET /clients/1/accounts</span>
  <span class="k">def</span> <span class="nf">accounts</span>
    <span class="vi">@accounts</span> <span class="o">=</span> <span class="no">Ownership</span><span class="p">.</span><span class="nf">joins</span><span class="p">(</span><span class="ss">:account</span><span class="p">,</span> <span class="ss">:branch</span><span class="p">).</span><span class="nf">where</span><span class="p">(</span><span class="ss">client: </span><span class="vi">@client</span><span class="p">).</span><span class="nf">select</span><span class="p">(</span><span class="s1">'ownerships.*'</span><span class="p">,</span> <span class="s1">'accounts.balance AS balance'</span><span class="p">,</span> <span class="s1">'branches.name AS branch_name'</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="c1"># GET /clients/1/loans</span>
  <span class="k">def</span> <span class="nf">loans</span>
    <span class="vi">@loans</span> <span class="o">=</span> <span class="no">Loan</span><span class="p">.</span><span class="nf">joins</span><span class="p">(</span><span class="ss">:clients</span><span class="p">,</span> <span class="ss">:branch</span><span class="p">).</span><span class="nf">where</span><span class="p">(</span><span class="s1">'clients.id = ?'</span><span class="p">,</span> <span class="vi">@client</span><span class="p">.</span><span class="nf">id</span><span class="p">).</span><span class="nf">select</span><span class="p">(</span><span class="s1">'loans.*'</span><span class="p">,</span> <span class="s1">'branches.name AS branch_name'</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
								</div>
							</div>
							<p>同时，由于联系人作为一个单独的实体（表）存储，在新建客户时，为了能够正确生成联系人相关表格，对 <code class="language-plaintext highlighter-rouge">new</code> 动作进行了一些修改，相关代码如下：</p>
							<div class="language-ruby highlighter-rouge">
								<div class="highlight">
									<pre class="highlight"><code><span class="c1"># GET /clients/new</span>
<span class="k">def</span> <span class="nf">new</span>
  <span class="vi">@client</span> <span class="o">=</span> <span class="no">Client</span><span class="p">.</span><span class="nf">new</span>
  <span class="vi">@client</span><span class="p">.</span><span class="nf">build_contact</span>
<span class="k">end</span>
</code></pre>
								</div>
							</div>
							<h4 id="327-账户控制器">3.2.7 账户控制器</h4>
							<p>账户控制器实现了 <code class="language-plaintext highlighter-rouge">owners</code> 一个额外的动作，路由至 <code class="language-plaintext highlighter-rouge">GET /accounts/:id/owners</code>，用于显示与账户关联的所有者，相关代码如下：</p>
							<div class="language-ruby highlighter-rouge">
								<div class="highlight">
									<pre class="highlight"><code><span class="k">class</span> <span class="nc">AccountsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:set_account</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[show edit owners update destroy]</span>

  <span class="c1"># GET /accounts/1/owners</span>
  <span class="k">def</span> <span class="nf">owners</span>
    <span class="vi">@ownership</span> <span class="o">=</span> <span class="no">Ownership</span><span class="p">.</span><span class="nf">new</span>
    <span class="vi">@owners</span> <span class="o">=</span> <span class="vi">@account</span><span class="p">.</span><span class="nf">ownerships</span><span class="p">.</span><span class="nf">joins</span><span class="p">(</span><span class="ss">:client</span><span class="p">).</span><span class="nf">select</span><span class="p">(</span><span class="s1">'ownerships.*'</span><span class="p">,</span> <span class="s1">'clients.name AS client_name'</span><span class="p">)</span>
    <span class="vi">@available_clients</span> <span class="o">=</span> <span class="no">Client</span><span class="p">.</span><span class="nf">where</span><span class="p">.</span><span class="nf">not</span><span class="p">(</span><span class="ss">id: </span><span class="no">Ownership</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">branch_id: </span><span class="vi">@account</span><span class="p">.</span><span class="nf">branch_id</span><span class="p">,</span> <span class="ss">accountable_type: </span><span class="vi">@account</span><span class="p">.</span><span class="nf">accountable_type</span><span class="p">).</span><span class="nf">select</span><span class="p">(</span><span class="ss">:client_id</span><span class="p">)).</span><span class="nf">select</span><span class="p">(</span><span class="ss">:id</span><span class="p">,</span> <span class="ss">:name</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
								</div>
							</div>
							<p>其中该页面包含了新增账户关联客户的表格，因此加入了 <code class="language-plaintext highlighter-rouge">@ownership = Ownership.new</code> 以使表格能够正常渲染，同时构造 <code class="language-plaintext highlighter-rouge">@available_clients</code> 列表用于填充表格中的下拉菜单，自动过滤掉不符合要求的客户（即不能够添加为当前账户所有者的客户）。</p>
							<p>由于账户的创建涉及对应多态关联的维护，因此修改了 <code class="language-plaintext highlighter-rouge">create</code> 方法，增加相关维护逻辑，代码如下：</p>
							<div class="language-ruby highlighter-rouge">
								<div class="highlight">
									<pre class="highlight"><code><span class="c1"># POST /accounts</span>
<span class="k">def</span> <span class="nf">create</span>
  <span class="n">params</span> <span class="o">=</span> <span class="n">account_params</span>
  <span class="n">accountable_type</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="ss">:accountable_type</span><span class="p">]</span>
  <span class="vi">@typed_account</span> <span class="o">=</span> <span class="n">accountable_type</span><span class="p">.</span><span class="nf">safe_constantize</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:accountable_attributes</span><span class="p">])</span>
  <span class="c1"># Insert account and branch info into ownership</span>
  <span class="n">params</span><span class="p">[</span><span class="ss">:ownerships_attributes</span><span class="p">]</span><span class="o">&amp;</span><span class="p">.</span><span class="nf">each_value</span> <span class="k">do</span> <span class="o">|</span><span class="kp">attr</span><span class="o">|</span>
    <span class="kp">attr</span><span class="p">.</span><span class="nf">merge!</span><span class="p">(</span><span class="ss">accountable_type: </span><span class="n">accountable_type</span><span class="p">,</span> <span class="ss">branch_id: </span><span class="n">params</span><span class="p">[</span><span class="ss">:branch_id</span><span class="p">])</span>
  <span class="k">end</span>
  <span class="vi">@account</span> <span class="o">=</span> <span class="vi">@typed_account</span><span class="p">.</span><span class="nf">build_account</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

  <span class="k">if</span> <span class="vi">@account</span><span class="p">.</span><span class="nf">save</span>
    <span class="n">redirect_to</span> <span class="vi">@account</span><span class="p">,</span> <span class="ss">success: </span><span class="s1">'成功创建账户'</span>
  <span class="k">else</span>
    <span class="n">render</span> <span class="ss">:new</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
								</div>
							</div>
							<p>由于账户更改支行涉及额外的验证及处理，<code class="language-plaintext highlighter-rouge">update</code> 方法需要完全重写，添加对修改支行情况的处理，代码如下：</p>
							<div class="language-ruby highlighter-rouge">
								<div class="highlight">
									<pre class="highlight"><code><span class="c1"># PATCH/PUT /accounts/1</span>
<span class="k">def</span> <span class="nf">update</span>
  <span class="k">if</span> <span class="n">update_params</span><span class="p">[</span><span class="ss">:branch_id</span><span class="p">].</span><span class="nf">to_i</span> <span class="o">!=</span> <span class="vi">@account</span><span class="p">.</span><span class="nf">branch_id</span>
    <span class="n">client_ids</span> <span class="o">=</span> <span class="no">Ownership</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">account: </span><span class="vi">@account</span><span class="p">).</span><span class="nf">select</span><span class="p">(</span><span class="ss">:client_id</span><span class="p">)</span>
    <span class="n">target_client_ids</span> <span class="o">=</span> <span class="no">Ownership</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">branch_id: </span><span class="n">update_params</span><span class="p">[</span><span class="ss">:branch_id</span><span class="p">],</span> <span class="ss">client_id: </span><span class="n">client_ids</span><span class="p">)</span>
    <span class="k">unless</span> <span class="n">target_client_ids</span><span class="p">.</span><span class="nf">empty?</span>
      <span class="n">target_client_ids</span><span class="p">.</span><span class="nf">joins</span><span class="p">(</span><span class="ss">:branch</span><span class="p">,</span> <span class="ss">:client</span><span class="p">).</span><span class="nf">select</span><span class="p">(</span><span class="s1">'branches.name AS branch_name'</span><span class="p">,</span> <span class="s1">'clients.name AS client_name'</span><span class="p">).</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">target</span><span class="o">|</span>
        <span class="n">errors</span> <span class="o">&lt;&lt;</span> <span class="s2">"客户 </span><span class="si">#{</span><span class="n">target</span><span class="p">.</span><span class="nf">client_name</span><span class="si">}</span><span class="s2"> 在支行 </span><span class="si">#{</span><span class="n">target</span><span class="p">.</span><span class="nf">branch_name</span><span class="si">}</span><span class="s2"> 已有账户"</span>
      <span class="k">end</span>
      <span class="n">render</span> <span class="ss">:edit</span> <span class="ow">and</span> <span class="k">return</span>
    <span class="k">end</span>

    <span class="no">Account</span><span class="p">.</span><span class="nf">transaction</span> <span class="k">do</span>
      <span class="no">Ownership</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">account: </span><span class="vi">@account</span><span class="p">).</span><span class="nf">update_all</span><span class="p">(</span><span class="ss">branch_id: </span><span class="n">update_params</span><span class="p">[</span><span class="ss">:branch_id</span><span class="p">])</span>
      <span class="vi">@account</span><span class="p">.</span><span class="nf">update!</span> <span class="n">update_params</span>
    <span class="k">end</span>
  <span class="k">else</span>
    <span class="vi">@account</span><span class="p">.</span><span class="nf">update!</span> <span class="n">update_params</span>
  <span class="k">end</span>
  <span class="n">redirect_to</span> <span class="vi">@account</span><span class="p">,</span> <span class="ss">success: </span><span class="s1">'成功更新账户'</span>
<span class="k">rescue</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">ActiveRecordError</span>
  <span class="n">render</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">alert: </span><span class="s1">'账户更新失败'</span>
<span class="k">end</span>
</code></pre>
								</div>
							</div>
							<p>首先使用 if 判断客户端提交上来的表格中支行是否被修改（与记录值不一致），若未修改则不需要验证。验证过程首先构建查询找出当前账户的全部关联客户，然后通过 <code class="language-plaintext highlighter-rouge">WHERE id IN (subquery)</code> 的方式判断这些客户中是否已有人在目标支行拥有相同类型的账户，若有则将这些客户列出作为错误信息返回。此时初步验证通过，需要同时更新「账户所有者」表中与该账户关联记录的「支行」列，再使用其他表格数据更新账户的其他属性。由于此处两步更新可能出错（如账户余额不符合要求等），故将两个更新操作包装在一个事务中，即 <code class="language-plaintext highlighter-rouge">Account.transaction</code> 代码块。</p>
							<h4 id="328-客户账户关系控制器">3.2.8 客户账户关系控制器</h4>
							<p>由于客户账户关系不是独立的实体，因此该控制器不符合 3.2.1 节的介绍。</p>
							<p>该控制器仅包含 <code class="language-plaintext highlighter-rouge">create</code> 和 <code class="language-plaintext highlighter-rouge">destroy</code> 两个动作，分别用于增减账户的关联客户，路由至</p>
							<div class="language-text highlighter-rouge">
								<div class="highlight">
									<pre class="highlight"><code>POST /accounts/:id/owners
DELETE /accounts/:id/owners
</code></pre>
								</div>
							</div>
							<p>除此之外，其实现逻辑与普通实体的创建与删除无异。个别细节如下所示：</p>
							<div class="language-ruby highlighter-rouge">
								<div class="highlight">
									<pre class="highlight"><code><span class="c1"># POST /accounts/1/owners</span>
<span class="k">def</span> <span class="nf">create</span>
  <span class="n">owner</span> <span class="o">=</span> <span class="no">Ownership</span><span class="p">.</span><span class="nf">new</span> <span class="n">ownership_params</span>

  <span class="k">if</span> <span class="n">owner</span><span class="p">.</span><span class="nf">save</span>
    <span class="n">redirect_to</span> <span class="n">account_owners_url</span><span class="p">(</span><span class="vi">@account</span><span class="p">),</span> <span class="ss">success: </span><span class="s1">'成功为账户添加客户'</span>
  <span class="k">else</span>
    <span class="n">render</span> <span class="s1">'accounts/owners'</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
								</div>
							</div>
							<p>由于客户账户关系没有独立的页面，因此在创建成功后回到账户页面，在创建失败时重新渲染相同页面，因此使用 <code class="language-plaintext highlighter-rouge">render 'accounts/owners'</code> 指定模板，避免 Action View 根据默认规则寻找 <code class="language-plaintext highlighter-rouge">ownerships/create</code> 页面。</p>
							<h4 id="329-贷款控制器">3.2.9 贷款控制器</h4>
							<p>贷款控制器实现了 <code class="language-plaintext highlighter-rouge">issues</code> 一个额外的动作，路由至 <code class="language-plaintext highlighter-rouge">GET /loans/:id/issues</code>，用于显示贷款的发放记录，相关代码如下：</p>
							<div class="language-ruby highlighter-rouge">
								<div class="highlight">
									<pre class="highlight"><code><span class="k">class</span> <span class="nc">LoansController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:set_loan</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[show issues clients add_client destroy_client destroy]</span>
  <span class="n">before_action</span> <span class="ss">:set_issues</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[issues]</span>

  <span class="c1"># GET /loans/1/issues</span>
  <span class="k">def</span> <span class="nf">issues</span>
    <span class="vi">@issue</span> <span class="o">=</span> <span class="no">Issue</span><span class="p">.</span><span class="nf">new</span>
  <span class="k">end</span>

  <span class="kp">private</span>
    <span class="c1"># Use callbacks to share common setup or constraints between actions.</span>
    <span class="k">def</span> <span class="nf">set_loan</span>
      <span class="nb">id</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">]</span>
      <span class="vi">@loan</span> <span class="o">=</span> <span class="no">Loan</span><span class="p">.</span><span class="nf">left_outer_joins</span><span class="p">(</span><span class="ss">:branch</span><span class="p">,</span> <span class="ss">:issues</span><span class="p">).</span><span class="nf">group</span><span class="p">(</span><span class="ss">:id</span><span class="p">).</span><span class="nf">select</span><span class="p">(</span><span class="s1">'loans.*'</span><span class="p">,</span> <span class="s1">'branches.name AS branch_name'</span><span class="p">,</span> <span class="s1">'IFNULL(SUM(issues.amount), 0.0) AS amount_issued'</span><span class="p">,</span> <span class="s1">'loans.amount - IFNULL(SUM(issues.amount), 0.0) AS remaining'</span><span class="p">).</span><span class="nf">find</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
      <span class="vi">@clients</span> <span class="o">=</span> <span class="no">Loan</span><span class="p">.</span><span class="nf">left_outer_joins</span><span class="p">(</span><span class="ss">:clients</span><span class="p">).</span><span class="nf">where</span><span class="p">(</span><span class="s1">'loans.id = ?'</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
      <span class="vi">@status</span> <span class="o">=</span> <span class="n">status_of</span> <span class="vi">@loan</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">set_issues</span>
      <span class="vi">@issues</span> <span class="o">=</span> <span class="vi">@loan</span><span class="p">.</span><span class="nf">issues</span><span class="p">.</span><span class="nf">order</span><span class="p">(</span><span class="ss">date: :asc</span><span class="p">,</span> <span class="ss">id: :asc</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre>
								</div>
							</div>
							<p>其中获取贷款数据通过 LEFT OUTER JOIN 的方式连结贷款发放表，获取支付金额的同时避免没有支付记录的贷款被过滤掉。</p>
							<p>另外，由于贷款不能修改，因此贷款控制器从默认动作中删掉了 <code class="language-plaintext highlighter-rouge">create</code> 和 <code class="language-plaintext highlighter-rouge">update</code>。</p>
							<h4 id="3210-贷款发放控制器">3.2.10 贷款发放控制器</h4>
							<p>由于贷款不是独立的实体，因此该控制器不符合 3.2.1 节的介绍。</p>
							<p>该控制器仅包含 <code class="language-plaintext highlighter-rouge">create</code> 一个动作，用于为贷款添加一笔新的支付记录，路由至 <code class="language-plaintext highlighter-rouge">POST /loans/:id/issues</code>。除此之外，其实现逻辑与普通实体的创建无异。相关代码如下：</p>
							<div class="language-ruby highlighter-rouge">
								<div class="highlight">
									<pre class="highlight"><code><span class="c1"># POST /loans/1/issues</span>
<span class="k">def</span> <span class="nf">create</span>
  <span class="vi">@issue</span> <span class="o">=</span> <span class="no">Issue</span><span class="p">.</span><span class="nf">new</span> <span class="n">issue_params</span>

  <span class="k">if</span> <span class="vi">@issue</span><span class="p">.</span><span class="nf">save</span>
    <span class="n">redirect_to</span> <span class="n">loan_issues_url</span><span class="p">(</span><span class="vi">@loan</span><span class="p">),</span> <span class="ss">success: </span><span class="s1">'成功添加支付'</span>
  <span class="k">else</span>
    <span class="n">redirect_to</span> <span class="n">loan_issues_url</span><span class="p">(</span><span class="vi">@loan</span><span class="p">),</span> <span class="ss">alert: </span><span class="vi">@issue</span><span class="p">.</span><span class="nf">errors</span><span class="p">.</span><span class="nf">full_messages</span><span class="p">.</span><span class="nf">first</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
								</div>
							</div>
							<p>其中金额验证等在 Active Record 模型处理，详细内容见 3.1.10 节。</p>
							<h4 id="3211-统计信息控制器">3.2.11 统计信息控制器</h4>
							<p>由于业务统计没有对应的实体，因此该控制器不符合 3.2.1 节的介绍。</p>
							<p>该控制器实现了业务统计相关的 <code class="language-plaintext highlighter-rouge">home</code>, <code class="language-plaintext highlighter-rouge">index</code>, <code class="language-plaintext highlighter-rouge">deposit</code>, <code class="language-plaintext highlighter-rouge">loan</code> 四个动作，分别为</p>
							<ul>
								<li>
									<code class="language-plaintext highlighter-rouge">home</code> 负责显示应用程序主页，路由至 <code class="language-plaintext highlighter-rouge">GET /</code>
								</li>
								<li>
									<code class="language-plaintext highlighter-rouge">index</code> 负责显示业务统计页面，路由至 <code class="language-plaintext highlighter-rouge">GET /stats</code>
								</li>
								<li>
									<code class="language-plaintext highlighter-rouge">deposit</code> 负责提供储蓄业务的查询功能，路由至 <code class="language-plaintext highlighter-rouge">GET /stats/deposit</code>
								</li>
								<li>
									<code class="language-plaintext highlighter-rouge">loan</code> 负责提供贷款业务的查询功能，路由至 <code class="language-plaintext highlighter-rouge">GET /stats/loan</code>
								</li>
							</ul>
							<p>其中<code class="language-plaintext highlighter-rouge">home</code> 为主页动作，只需准备需要在主页上显示的各大类模型，代码如下：</p>
							<div class="language-ruby highlighter-rouge">
								<div class="highlight">
									<pre class="highlight"><code><span class="k">class</span> <span class="nc">StatsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="c1"># GET /</span>
  <span class="k">def</span> <span class="nf">home</span>
    <span class="vi">@cards</span> <span class="o">=</span> <span class="p">[</span><span class="no">Branch</span><span class="p">,</span> <span class="no">Department</span><span class="p">,</span> <span class="no">Staff</span><span class="p">,</span> <span class="no">Client</span><span class="p">,</span> <span class="no">Account</span><span class="p">,</span> <span class="no">Loan</span><span class="p">].</span><span class="nf">zip</span> <span class="p">\</span>
      <span class="sx">%w[safe department manager user credit-card debt]</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
								</div>
							</div>
							<p><code class="language-plaintext highlighter-rouge">index</code> 为「业务统计」页面，此处需要处理在页面上显示的「概览」数据，其代码如下：</p>
							<div class="language-ruby highlighter-rouge">
								<div class="highlight">
									<pre class="highlight"><code><span class="k">class</span> <span class="nc">StatsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="c1"># GET /stats</span>
  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@branches_count</span> <span class="o">=</span> <span class="no">Branch</span><span class="p">.</span><span class="nf">count</span>
    <span class="vi">@accounts_count</span><span class="p">,</span> <span class="vi">@accounts_amount</span> <span class="o">=</span> <span class="no">Account</span><span class="p">.</span><span class="nf">pluck</span><span class="p">(</span><span class="s1">'COUNT(id)'</span><span class="p">,</span> <span class="s1">'SUM(balance)'</span><span class="p">).</span><span class="nf">first</span>
    <span class="no">Account</span><span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="ss">:accountable_type</span><span class="p">).</span><span class="nf">pluck</span><span class="p">(</span><span class="s1">'COUNT(id)'</span><span class="p">,</span> <span class="ss">:accountable_type</span><span class="p">).</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">count</span><span class="p">,</span> <span class="n">type</span><span class="o">|</span>
      <span class="vi">@deposit_accounts_count</span> <span class="o">=</span> <span class="n">count</span> <span class="k">if</span> <span class="n">type</span> <span class="o">==</span> <span class="s1">'DepositAccount'</span>
      <span class="vi">@check_accounts_count</span> <span class="o">=</span> <span class="n">count</span> <span class="k">if</span> <span class="n">type</span> <span class="o">==</span> <span class="s1">'CheckAccount'</span>
    <span class="k">end</span>
    <span class="vi">@loans_count</span><span class="p">,</span> <span class="vi">@loans_amount</span> <span class="o">=</span> <span class="no">Loan</span><span class="p">.</span><span class="nf">pluck</span><span class="p">(</span><span class="s1">'COUNT(id)'</span><span class="p">,</span> <span class="s1">'SUM(amount)'</span><span class="p">).</span><span class="nf">first</span>
    <span class="n">loan_statuses</span> <span class="o">=</span> <span class="no">Loan</span><span class="p">.</span><span class="nf">left_outer_joins</span><span class="p">(</span><span class="ss">:issues</span><span class="p">).</span><span class="nf">group</span><span class="p">(</span><span class="ss">:id</span><span class="p">).</span><span class="nf">select</span><span class="p">(</span><span class="ss">:id</span><span class="p">,</span> <span class="sx">%[
      CASE
        WHEN IFNULL(SUM(issues.amount), 0) = 0 THEN 0
        WHEN SUM(issues.amount) = loans.amount THEN 2
        ELSE 1
      END AS status
    ]</span><span class="p">.</span><span class="nf">squish</span><span class="p">)</span>
    <span class="no">Loan</span><span class="p">.</span><span class="nf">from</span><span class="p">(</span><span class="n">loan_statuses</span><span class="p">,</span> <span class="ss">:statuses</span><span class="p">).</span><span class="nf">group</span><span class="p">(</span><span class="ss">:status</span><span class="p">).</span><span class="nf">select</span><span class="p">(</span><span class="s1">'COUNT(id) AS count'</span><span class="p">,</span> <span class="ss">:status</span><span class="p">).</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">row</span><span class="o">|</span>
      <span class="k">case</span> <span class="n">row</span><span class="p">.</span><span class="nf">status</span>
      <span class="k">when</span> <span class="mi">0</span>
        <span class="vi">@unissued</span> <span class="o">=</span> <span class="n">row</span><span class="p">.</span><span class="nf">count</span>
      <span class="k">when</span> <span class="mi">2</span>
        <span class="vi">@issued</span> <span class="o">=</span> <span class="n">row</span><span class="p">.</span><span class="nf">count</span>
      <span class="k">else</span>
        <span class="vi">@issuing</span> <span class="o">=</span> <span class="n">row</span><span class="p">.</span><span class="nf">count</span>
      <span class="k">end</span>
    <span class="k">end</span>
    <span class="vi">@issues_amount</span> <span class="o">=</span> <span class="no">Issue</span><span class="p">.</span><span class="nf">sum</span><span class="p">(</span><span class="ss">:amount</span><span class="p">)</span>

    <span class="vi">@deposit_card_content</span> <span class="o">=</span> <span class="sx">%w[支行 账户 总金额 储蓄账户 支票账户]</span><span class="p">.</span><span class="nf">zip</span> <span class="p">[</span>
      <span class="vi">@branches_count</span><span class="p">,</span> <span class="vi">@accounts_count</span><span class="p">,</span> <span class="n">helpers</span><span class="p">.</span><span class="nf">currency_value</span><span class="p">(</span><span class="vi">@accounts_amount</span><span class="p">),</span>
      <span class="p">(</span><span class="vi">@deposit_accounts_count</span> <span class="o">||=</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="vi">@check_accounts_count</span> <span class="o">||=</span> <span class="mi">0</span><span class="p">),</span>
    <span class="p">]</span>
    <span class="vi">@loan_card_content</span> <span class="o">=</span> <span class="sx">%w[支行 贷款 总金额 已支付 未发放 发放中 已发放]</span><span class="p">.</span><span class="nf">zip</span> <span class="p">[</span>
      <span class="vi">@branches_count</span><span class="p">,</span> <span class="vi">@loans_count</span><span class="p">,</span>
      <span class="n">helpers</span><span class="p">.</span><span class="nf">currency_value</span><span class="p">(</span><span class="vi">@loans_amount</span><span class="p">),</span> <span class="n">helpers</span><span class="p">.</span><span class="nf">currency_value</span><span class="p">(</span><span class="vi">@issues_amount</span><span class="p">),</span>
      <span class="p">(</span><span class="vi">@unissued</span> <span class="o">||=</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="vi">@issuing</span> <span class="o">||=</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="vi">@issued</span> <span class="o">||=</span> <span class="mi">0</span><span class="p">),</span>
    <span class="p">]</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
								</div>
							</div>
							<p>该部分代码为页面准备了以下数据：</p>
							<ul>
								<li>储蓄业务
									<ul>
										<li>支行数</li>
										<li>账户数</li>
										<li>账户余额总数</li>
										<li>储蓄账户数</li>
										<li>支票账户数</li>
									</ul>
								</li>
								<li>贷款业务
									<ul>
										<li>支行数</li>
										<li>贷款笔数</li>
										<li>贷款总金额</li>
										<li>已支付的总金额</li>
										<li>未开始发放的贷款数</li>
										<li>发放中的贷款数</li>
										<li>已发放完毕的贷款数</li>
									</ul>
								</li>
							</ul>
							<p><code class="language-plaintext highlighter-rouge">deposit</code> 和 <code class="language-plaintext highlighter-rouge">loan</code> 页面都包含一个搜索表格，通过 URL parameters 传入搜索参数，准备及处理搜索参数的相关代码如下：</p>
							<div class="language-ruby highlighter-rouge">
								<div class="highlight">
									<pre class="highlight"><code><span class="k">class</span> <span class="nc">StatsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:set_form</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[deposit loan]</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">search_params</span>
    <span class="vi">@url_params</span> <span class="o">||=</span> <span class="n">request</span><span class="o">.</span><span class="no">GET</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">set_form</span>
    <span class="vi">@action</span> <span class="o">=</span> <span class="n">search_params</span><span class="p">[</span><span class="ss">:action</span><span class="p">]</span>
    <span class="vi">@branches</span> <span class="o">=</span> <span class="p">(</span><span class="n">search_params</span><span class="p">[</span><span class="ss">:branch</span><span class="p">]</span> <span class="o">||</span> <span class="s1">''</span><span class="p">).</span><span class="nf">split</span><span class="p">(</span><span class="s1">' '</span><span class="p">).</span><span class="nf">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:to_i</span><span class="p">)</span>
    <span class="vi">@start_date</span> <span class="o">=</span> <span class="no">Date</span><span class="p">.</span><span class="nf">parse</span> <span class="n">search_params</span><span class="p">[</span><span class="ss">:start_date</span><span class="p">]</span> <span class="k">rescue</span> <span class="no">Date</span><span class="p">.</span><span class="nf">today</span><span class="p">.</span><span class="nf">at_beginning_of_month</span>
    <span class="vi">@end_date</span> <span class="o">=</span> <span class="no">Date</span><span class="p">.</span><span class="nf">parse</span> <span class="n">search_params</span><span class="p">[</span><span class="ss">:end_date</span><span class="p">]</span> <span class="k">rescue</span> <span class="no">Date</span><span class="p">.</span><span class="nf">today</span>
    <span class="vi">@end_year</span> <span class="o">=</span> <span class="no">Date</span><span class="p">.</span><span class="nf">today</span><span class="p">.</span><span class="nf">year</span>
    <span class="n">valid_time_spans</span> <span class="o">=</span> <span class="sx">%i[none month quarter year]</span>
    <span class="vi">@time_spans</span> <span class="o">=</span> <span class="sx">%w[无 月 季度 年]</span><span class="p">.</span><span class="nf">zip</span> <span class="n">valid_time_spans</span>
    <span class="vi">@time_span</span> <span class="o">=</span> <span class="p">(</span><span class="n">search_params</span><span class="p">[</span><span class="ss">:time_span</span><span class="p">]</span> <span class="o">||</span> <span class="ss">:none</span><span class="p">).</span><span class="nf">to_sym</span>
    <span class="vi">@time_span</span> <span class="o">=</span> <span class="ss">:none</span> <span class="k">unless</span> <span class="n">valid_time_spans</span><span class="p">.</span><span class="nf">include?</span> <span class="vi">@time_span</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
								</div>
							</div>
							<p>其中 <code class="language-plaintext highlighter-rouge">search_params</code> 函数从请求的 URL 解析搜索参数，<code class="language-plaintext highlighter-rouge">set_form</code> 函数从搜索参数中解析选项和数值等具体参数，以及处理默认选项等。</p>
							<p>下面为 <code class="language-plaintext highlighter-rouge">deposit</code> 和 <code class="language-plaintext highlighter-rouge">loan</code> 动作的代码，它们基本一致：</p>
							<div class="language-ruby highlighter-rouge">
								<div class="highlight">
									<pre class="highlight"><code><span class="k">class</span> <span class="nc">StatsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="c1"># GET /stats/deposit</span>
  <span class="k">def</span> <span class="nf">deposit</span>
    <span class="vi">@start_year</span> <span class="o">=</span> <span class="no">Account</span><span class="p">.</span><span class="nf">order</span><span class="p">(</span><span class="ss">open_date: :asc</span><span class="p">).</span><span class="nf">select</span><span class="p">(</span><span class="ss">:open_date</span><span class="p">).</span><span class="nf">first</span><span class="o">&amp;</span><span class="p">.</span><span class="nf">open_date</span><span class="o">&amp;</span><span class="p">.</span><span class="nf">year</span> <span class="o">||</span> <span class="no">Date</span><span class="p">.</span><span class="nf">today</span><span class="p">.</span><span class="nf">year</span>
    <span class="k">return</span> <span class="k">unless</span> <span class="vi">@action</span>

    <span class="n">wheres</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">selects</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'accounts.*'</span><span class="p">,</span>
               <span class="s1">'COUNT(DISTINCT ownerships.client_id) AS clients_count'</span><span class="p">,</span>
               <span class="s1">'SUM(balance) AS total_amount'</span><span class="p">,</span>
               <span class="s1">'branches.name AS branch_name'</span><span class="p">]</span>
    <span class="n">groups</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'accounts.branch_id'</span><span class="p">]</span>
    <span class="n">orders</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">wheres</span><span class="p">[</span><span class="ss">:branch_id</span><span class="p">]</span> <span class="o">=</span> <span class="vi">@branches</span> <span class="k">unless</span> <span class="vi">@branches</span><span class="p">.</span><span class="nf">empty?</span>

    <span class="c1"># Apparently this is MySQL-specific</span>
    <span class="k">case</span> <span class="vi">@time_span</span>
    <span class="k">when</span> <span class="ss">:year</span>
      <span class="n">selects</span> <span class="o">&lt;&lt;</span> <span class="s1">'YEAR(open_date) AS open_year'</span>
      <span class="n">selects</span> <span class="o">&lt;&lt;</span> <span class="s1">'YEAR(open_date) AS display_time'</span>
      <span class="n">groups</span> <span class="o">&lt;&lt;</span> <span class="s1">'open_year'</span>
      <span class="n">orders</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">open_year: :asc</span><span class="p">,</span> <span class="ss">branch_id: :asc</span> <span class="p">}</span>
    <span class="k">when</span> <span class="ss">:quarter</span>
      <span class="n">selects</span> <span class="o">&lt;&lt;</span> <span class="s1">'YEAR(open_date) AS open_year'</span>
      <span class="n">selects</span> <span class="o">&lt;&lt;</span> <span class="s1">'((MONTH(open_date) + 2) DIV 3) AS open_quarter'</span>
      <span class="n">selects</span> <span class="o">&lt;&lt;</span> <span class="s1">'CONCAT(YEAR(open_date), " Q", (MONTH(open_date) + 2) DIV 3) AS display_time'</span>
      <span class="n">groups</span> <span class="o">&lt;&lt;</span> <span class="s1">'open_quarter'</span>
      <span class="n">orders</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">open_year: :asc</span><span class="p">,</span> <span class="ss">open_quarter: :asc</span><span class="p">,</span> <span class="ss">branch_id: :asc</span> <span class="p">}</span>
    <span class="k">when</span> <span class="ss">:month</span>
      <span class="n">selects</span> <span class="o">&lt;&lt;</span> <span class="s1">'YEAR(open_date) AS open_year'</span>
      <span class="n">selects</span> <span class="o">&lt;&lt;</span> <span class="s1">'MONTH(open_date) AS open_month'</span>
      <span class="n">selects</span> <span class="o">&lt;&lt;</span> <span class="s1">'CONCAT(YEAR(open_date), "-", LPAD(MONTH(open_date), 2, "0")) AS display_time'</span>
      <span class="n">groups</span> <span class="o">&lt;&lt;</span> <span class="s1">'open_month'</span>
      <span class="n">orders</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">open_year: :asc</span><span class="p">,</span> <span class="ss">open_month: :asc</span><span class="p">,</span> <span class="ss">branch_id: :asc</span> <span class="p">}</span>
    <span class="k">else</span>
      <span class="n">selects</span> <span class="o">&lt;&lt;</span> <span class="s1">'open_date'</span>
      <span class="n">selects</span> <span class="o">&lt;&lt;</span> <span class="s1">'open_date AS display_time'</span>
      <span class="n">groups</span> <span class="o">&lt;&lt;</span> <span class="s1">'open_date'</span>
      <span class="n">orders</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">open_date: :asc</span><span class="p">,</span> <span class="ss">branch_id: :asc</span> <span class="p">}</span>
    <span class="k">end</span>

    <span class="vi">@query</span> <span class="o">=</span> <span class="no">Account</span><span class="p">.</span><span class="nf">select</span><span class="p">(</span><span class="n">selects</span><span class="p">).</span><span class="nf">joins</span><span class="p">(</span><span class="ss">:branch</span><span class="p">).</span><span class="nf">where</span><span class="p">(</span><span class="n">wheres</span><span class="p">).</span><span class="nf">group</span><span class="p">(</span><span class="n">groups</span><span class="p">).</span><span class="nf">order</span><span class="p">(</span><span class="n">orders</span><span class="p">)</span>
    <span class="vi">@data_branches</span> <span class="o">=</span> <span class="vi">@query</span><span class="p">.</span><span class="nf">except</span><span class="p">(</span><span class="ss">:select</span><span class="p">,</span> <span class="ss">:group</span><span class="p">,</span> <span class="ss">:order</span><span class="p">).</span><span class="nf">select</span><span class="p">(</span><span class="s1">'DISTINCT branch_id'</span><span class="p">,</span> <span class="s1">'branches.name AS branch_name'</span><span class="p">).</span><span class="nf">order</span><span class="p">(</span><span class="ss">branch_id: :ASC</span><span class="p">)</span>
    <span class="vi">@query</span> <span class="o">=</span> <span class="vi">@query</span><span class="p">.</span><span class="nf">joins</span><span class="p">(</span><span class="ss">:ownerships</span><span class="p">)</span>
    <span class="vi">@record_groups</span> <span class="o">=</span> <span class="vi">@query</span><span class="p">.</span><span class="nf">group_by</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:branch_id</span><span class="p">).</span><span class="nf">sort_by</span> <span class="p">{</span> <span class="o">|</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="o">|</span> <span class="n">k</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="c1"># GET /stats/loan</span>
  <span class="k">def</span> <span class="nf">loan</span>
    <span class="vi">@start_year</span> <span class="o">=</span> <span class="no">Issue</span><span class="p">.</span><span class="nf">order</span><span class="p">(</span><span class="ss">date: :asc</span><span class="p">).</span><span class="nf">select</span><span class="p">(</span><span class="ss">:date</span><span class="p">).</span><span class="nf">first</span><span class="o">&amp;</span><span class="p">.</span><span class="nf">date</span><span class="o">&amp;</span><span class="p">.</span><span class="nf">year</span> <span class="o">||</span> <span class="no">Date</span><span class="p">.</span><span class="nf">today</span><span class="p">.</span><span class="nf">year</span>
    <span class="k">return</span> <span class="k">unless</span> <span class="vi">@action</span>

    <span class="n">wheres</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">selects</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'loans.*'</span><span class="p">,</span> <span class="s1">'issues.date AS date'</span><span class="p">,</span>
               <span class="s1">'@clients_count := COUNT(DISTINCT clients.id) AS clients_count'</span><span class="p">,</span>
               <span class="s1">'SUM(issues.amount / @clients_count) AS total_amount'</span><span class="p">,</span>
               <span class="s1">'branches.name AS branch_name'</span><span class="p">]</span>
    <span class="n">groups</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'loans.branch_id'</span><span class="p">,</span> <span class="s1">'loans.id'</span><span class="p">]</span>
    <span class="n">orders</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">wheres</span><span class="p">[</span><span class="ss">:branch_id</span><span class="p">]</span> <span class="o">=</span> <span class="vi">@branches</span> <span class="k">unless</span> <span class="vi">@branches</span><span class="p">.</span><span class="nf">empty?</span>

    <span class="k">case</span> <span class="vi">@time_span</span>
    <span class="k">when</span> <span class="ss">:year</span>
      <span class="n">selects</span> <span class="o">&lt;&lt;</span> <span class="s1">'YEAR(date) AS year'</span>
      <span class="n">selects</span> <span class="o">&lt;&lt;</span> <span class="s1">'YEAR(date) AS display_time'</span>
      <span class="n">groups</span> <span class="o">&lt;&lt;</span> <span class="s1">'year'</span>
      <span class="n">orders</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">year: :asc</span><span class="p">,</span> <span class="ss">branch_id: :asc</span> <span class="p">}</span>
    <span class="k">when</span> <span class="ss">:quarter</span>
      <span class="n">selects</span> <span class="o">&lt;&lt;</span> <span class="s1">'YEAR(date) AS year'</span>
      <span class="n">selects</span> <span class="o">&lt;&lt;</span> <span class="s1">'((MONTH(date) + 2) DIV 3) AS quarter'</span>
      <span class="n">selects</span> <span class="o">&lt;&lt;</span> <span class="s1">'CONCAT(YEAR(date), " Q", (MONTH(date) + 2) DIV 3) AS display_time'</span>
      <span class="n">groups</span> <span class="o">&lt;&lt;</span> <span class="s1">'quarter'</span>
      <span class="n">orders</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">year: :asc</span><span class="p">,</span> <span class="ss">quarter: :asc</span><span class="p">,</span> <span class="ss">branch_id: :asc</span> <span class="p">}</span>
    <span class="k">when</span> <span class="ss">:month</span>
      <span class="n">selects</span> <span class="o">&lt;&lt;</span> <span class="s1">'YEAR(date) AS year'</span>
      <span class="n">selects</span> <span class="o">&lt;&lt;</span> <span class="s1">'MONTH(date) AS month'</span>
      <span class="n">selects</span> <span class="o">&lt;&lt;</span> <span class="s1">'CONCAT(YEAR(date), "-", LPAD(MONTH(date), 2, "0")) AS display_time'</span>
      <span class="n">groups</span> <span class="o">&lt;&lt;</span> <span class="s1">'month'</span>
      <span class="n">orders</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">year: :asc</span><span class="p">,</span> <span class="ss">month: :asc</span><span class="p">,</span> <span class="ss">branch_id: :asc</span> <span class="p">}</span>
    <span class="k">else</span>
      <span class="n">selects</span> <span class="o">&lt;&lt;</span> <span class="s1">'date'</span>
      <span class="n">selects</span> <span class="o">&lt;&lt;</span> <span class="s1">'date AS display_time'</span>
      <span class="n">groups</span> <span class="o">&lt;&lt;</span> <span class="s1">'date'</span>
      <span class="n">orders</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">date: :asc</span><span class="p">,</span> <span class="ss">branch_id: :asc</span> <span class="p">}</span>
    <span class="k">end</span>

    <span class="vi">@query</span> <span class="o">=</span> <span class="no">Loan</span><span class="p">.</span><span class="nf">select</span><span class="p">(</span><span class="n">selects</span><span class="p">).</span><span class="nf">joins</span><span class="p">(</span><span class="ss">:branch</span><span class="p">).</span><span class="nf">where</span><span class="p">(</span><span class="n">wheres</span><span class="p">).</span><span class="nf">group</span><span class="p">(</span><span class="n">groups</span><span class="p">).</span><span class="nf">order</span><span class="p">(</span><span class="n">orders</span><span class="p">)</span>
    <span class="vi">@data_branches</span> <span class="o">=</span> <span class="vi">@query</span><span class="p">.</span><span class="nf">except</span><span class="p">(</span><span class="ss">:select</span><span class="p">,</span> <span class="ss">:group</span><span class="p">,</span> <span class="ss">:order</span><span class="p">).</span><span class="nf">select</span><span class="p">(</span><span class="s1">'DISTINCT branch_id'</span><span class="p">,</span> <span class="s1">'branches.name AS branch_name'</span><span class="p">).</span><span class="nf">order</span><span class="p">(</span><span class="ss">branch_id: :ASC</span><span class="p">)</span>
    <span class="vi">@query</span> <span class="o">=</span> <span class="vi">@query</span><span class="p">.</span><span class="nf">joins</span><span class="p">(</span><span class="ss">:clients</span><span class="p">,</span> <span class="ss">:issues</span><span class="p">)</span>
    <span class="vi">@record_groups</span> <span class="o">=</span> <span class="vi">@query</span><span class="p">.</span><span class="nf">group_by</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:branch_id</span><span class="p">).</span><span class="nf">sort_by</span> <span class="p">{</span> <span class="o">|</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="o">|</span> <span class="n">k</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
								</div>
							</div>
							<p>首先若没有查询动作（action 为空），则直接返回页面，此时的页面没有「搜索结果」部分，仅包含搜索表格。若有查询动作，则根据搜索参数构建 SQL 语句，其中主要内容是区分按月、按季度和按年归纳的部分。构建好查询之后将结果按支行归类以便显示。</p>
							<h3 id="33-action-view-视图">3.3 Action View 视图</h3>
							<p>由于 Rails 会自动根据控制器和动作构建路径寻找 Action View 模板（见 <a href="https://guides.rubyonrails.org/layouts_and_rendering.html">https://guides.rubyonrails.org/layouts_and_rendering.html</a>），因此项目的 <code class="language-plaintext highlighter-rouge">/app/views</code> 目录仅包含 HTML 模板，不包含搜索模板及传递数据等相关代码，故本节也仅介绍所用 HTML 模板及其他前端相关设计。</p>
							<p>由于各个模型的列表页面、详细信息页面及编辑页面具有相同的结构，因此不分别介绍，这部分内容在 3.3.3 节至 3.3.6 节统一介绍。</p>
							<p>为避免重复，本章节不包含实际效果展示，所有截图都在第 4 章展示。</p>
							<h4 id="331-主布局-layoutsapplication">3.3.1 主布局 <code class="language-plaintext highlighter-rouge">layouts/application</code>
							</h4>
							<p><code class="language-plaintext highlighter-rouge">layouts/application.html.erb</code> 为整个应用程序的基本模板，定义了 HTML 框架及在其他页面中可指定的部分（<code class="language-plaintext highlighter-rouge">content_for</code>）。所有其他页面都从该模板继承。</p>
							<p>下面为 HTML <code class="language-plaintext highlighter-rouge">&lt;head&gt;</code> 部分定义：</p>
							<div class="language-erb highlighter-rouge">
								<div class="highlight">
									<pre class="highlight"><code><span class="nt">&lt;head&gt;</span>
  <span class="nt">&lt;title&gt;</span>
    <span class="cp">&lt;%=</span> <span class="k">if</span> <span class="n">content_for?</span><span class="p">(</span><span class="ss">:title</span><span class="p">)</span> <span class="k">then</span> <span class="k">yield</span><span class="p">(</span><span class="ss">:title</span><span class="p">)</span> <span class="o">+</span> <span class="s1">' - '</span> <span class="k">end</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">site_name</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/title&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">favicon_link_tag</span> <span class="n">asset_path</span><span class="p">(</span><span class="s1">'bank.png'</span><span class="p">),</span> <span class="ss">type: </span><span class="s1">'image/png'</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">"viewport"</span> <span class="na">content=</span><span class="s">"width=device-width, initial-scale=1, maximum-scale=1"</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">csrf_meta_tags</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">csp_meta_tag</span> <span class="cp">%&gt;</span>

  <span class="cp">&lt;%=</span> <span class="n">stylesheet_link_tag</span> <span class="s2">"https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/css/bootstrap.min.css"</span><span class="p">,</span> <span class="ss">integrity: </span><span class="s2">"sha256-aAr2Zpq8MZ+YA/D6JtRD3xtrwpEz2IqOS+pWD/7XKIw="</span><span class="p">,</span> <span class="ss">crossorigin: :anonymous</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">stylesheet_link_tag</span> <span class="s2">"https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"</span><span class="p">,</span> <span class="ss">crossorigin: :anonymous</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">stylesheet_link_tag</span> <span class="s1">'application'</span><span class="p">,</span> <span class="ss">media: :all</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="k">yield</span> <span class="ss">:head</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/head&gt;</span>
</code></pre>
								</div>
							</div>
							<p>该部分内容作用如下：</p>
							<ul>
								<li>定义页面标题格式为 <em>页面名称 - 网站名称</em>
								</li>
								<li>显示网站图标（即 favicon）</li>
								<li>生成 <a href="https://en.wikipedia.org/wiki/Cross-site_request_forgery">CSRF</a> 与 <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy">CSP</a> 标签</li>
								<li>从 <a href="https://www.jsdelivr.com/">jsDelivr CDN</a> 载入 <a href="https://getbootstrap.com/docs/4.5/getting-started/introduction/">Boostrap 4</a> 样式表以及 <a href="https://fontawesome.com/">Font Awesome 5</a> 图标样式表</li>
								<li>载入一些自定义的样式表，详细信息在 3.4 节介绍</li>
								<li>为额外的头部信息提供插入位置，该功能在其他模板中并没有用到</li>
							</ul>
							<p>下面为 HTML <code class="language-plaintext highlighter-rouge">&lt;body&gt;</code> 部分定义（精简内容）：</p>
							<div class="language-erb highlighter-rouge">
								<div class="highlight">
									<pre class="highlight"><code><span class="nt">&lt;body</span> <span class="na">class=</span><span class="s">"d-flex flex-column min-vh-100"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;nav</span> <span class="na">class=</span><span class="s">"navbar navbar-expand-md navbar-light shadow-sm"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;/nav&gt;</span>

  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"initial-content flex-grow-1 my-3 my-md-4 container px-sm-0"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">unless</span> <span class="n">alert</span><span class="p">.</span><span class="nf">nil?</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"alert"</span> <span class="na">class=</span><span class="s">"alert alert-danger"</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">alert</span> <span class="cp">%&gt;</span><span class="nt">&lt;/div&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">unless</span> <span class="n">success</span><span class="p">.</span><span class="nf">nil?</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"success"</span> <span class="na">class=</span><span class="s">"alert alert-success"</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">success</span> <span class="cp">%&gt;</span><span class="nt">&lt;/div&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">unless</span> <span class="n">notice</span><span class="p">.</span><span class="nf">nil?</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"notice"</span> <span class="na">class=</span><span class="s">"alert alert-primary"</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">notice</span> <span class="cp">%&gt;</span><span class="nt">&lt;/div&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

    <span class="cp">&lt;%=</span> <span class="k">yield</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>

  <span class="nt">&lt;footer</span> <span class="na">class=</span><span class="s">"footer shadow py-3 py-md-4 border-top"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;/footer&gt;</span>

  <span class="c">&lt;%# Optional scripts %&gt;</span>
<span class="nt">&lt;/body&gt;</span>
</code></pre>
								</div>
							</div>
							<p>该部分定义了网页页面实际显示的内容，主要包含四部分：</p>
							<ul>
								<li>顶部导航栏</li>
								<li>主体内容</li>
								<li>页脚</li>
								<li>额外的脚本，放置在页面底部以保证在页面加载完成后才加载</li>
							</ul>
							<p>其中为了使页脚在页面内容较少时也能正确保持在页面底部，采用了 CSS Flex 的方案，因此 <code class="language-plaintext highlighter-rouge">body</code> 元素上有 <code class="language-plaintext highlighter-rouge">d-flex flex-column min-vh-100</code> 等类，主体内容的外部 <code class="language-plaintext highlighter-rouge">div</code> 容器上有 <code class="language-plaintext highlighter-rouge">flex-grow-1</code> 等类。详情见 Stack Overflow 上的<a href="https://stackoverflow.com/a/34146411/5958455">这篇回答</a>。</p>
							<p>下面为导航栏的代码：</p>
							<div class="language-erb highlighter-rouge">
								<div class="highlight">
									<pre class="highlight"><code><span class="nt">&lt;nav</span> <span class="na">class=</span><span class="s">"navbar navbar-expand-md navbar-light shadow-sm"</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">root_path</span><span class="p">,</span> <span class="ss">class: </span><span class="s1">'navbar-brand'</span> <span class="k">do</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">image_tag</span> <span class="s2">"bank.svg"</span><span class="p">,</span> <span class="ss">data: </span><span class="p">{</span> <span class="ss">svg_fallback: </span><span class="n">asset_path</span><span class="p">(</span><span class="s1">'bank.svg'</span><span class="p">)</span> <span class="p">},</span> <span class="ss">class: </span><span class="s1">'svg-inline'</span> <span class="cp">%&gt;</span>
    <span class="c">&lt;%# site_name %&gt;</span>
    iBug 银行
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;button</span> <span class="na">class=</span><span class="s">"navbar-toggler"</span> <span class="na">type=</span><span class="s">"button"</span> <span class="na">data-toggle=</span><span class="s">"collapse"</span> <span class="na">data-target=</span><span class="s">"#navbar-content"</span> <span class="na">aria-controls=</span><span class="s">"navbar-content"</span> <span class="na">aria-expanded=</span><span class="s">"false"</span> <span class="na">aria-label=</span><span class="s">"Toggle navigation"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"navbar-toggler-icon"</span><span class="nt">&gt;&lt;/span&gt;</span>
  <span class="nt">&lt;/button&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"collapse navbar-collapse"</span> <span class="na">id=</span><span class="s">"navbar-content"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"navbar-nav mr-auto"</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%</span> <span class="n">navbar_models</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">model</span><span class="p">,</span> <span class="n">icon</span><span class="o">|</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"nav-item </span><span class="cp">&lt;%=</span> <span class="n">active_page</span> <span class="n">url_for</span> <span class="n">model</span> <span class="cp">%&gt;</span><span class="s">"</span><span class="nt">&gt;</span>
          <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">url_for</span><span class="p">(</span><span class="n">model</span><span class="p">),</span> <span class="ss">class: </span><span class="s1">'nav-link'</span> <span class="k">do</span> <span class="cp">%&gt;</span>
            <span class="nt">&lt;i</span> <span class="na">class=</span><span class="s">"fas fa-fw fa-</span><span class="cp">&lt;%=</span> <span class="n">icon</span> <span class="cp">%&gt;</span><span class="s">"</span><span class="nt">&gt;&lt;/i&gt;</span>
            <span class="cp">&lt;%=</span> <span class="n">model</span><span class="p">.</span><span class="nf">model_name</span><span class="p">.</span><span class="nf">human</span> <span class="cp">%&gt;</span>
          <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;/li&gt;</span>
      <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

      <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"nav-item dropdown"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">"nav-link dropdown-toggle"</span> <span class="na">data-toggle=</span><span class="s">"dropdown"</span> <span class="na">href=</span><span class="s">"#"</span> <span class="na">role=</span><span class="s">"button"</span> <span class="na">aria-haspopup=</span><span class="s">"true"</span> <span class="na">aria-expanded=</span><span class="s">"false"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;i</span> <span class="na">class=</span><span class="s">"fas fa-fw fa-chart-pie"</span><span class="nt">&gt;&lt;/i&gt;</span>
          统计
        <span class="nt">&lt;/a&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"dropdown-menu"</span><span class="nt">&gt;</span>
          <span class="cp">&lt;%</span> <span class="n">navbar_stats</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">path</span><span class="p">,</span> <span class="n">icon</span><span class="p">,</span> <span class="nb">name</span><span class="o">|</span> <span class="cp">%&gt;</span>
            <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">path</span><span class="p">,</span> <span class="ss">class: </span><span class="s2">"dropdown-item </span><span class="si">#{</span><span class="n">active_page</span> <span class="n">path</span><span class="si">}</span><span class="s2">"</span> <span class="k">do</span> <span class="cp">%&gt;</span>
              <span class="nt">&lt;i</span> <span class="na">class=</span><span class="s">"fas fa-fw fa-</span><span class="cp">&lt;%=</span> <span class="n">icon</span> <span class="cp">%&gt;</span><span class="s">"</span><span class="nt">&gt;&lt;/i&gt;</span>
              <span class="cp">&lt;%=</span> <span class="nb">name</span> <span class="cp">%&gt;</span>
            <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
          <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;/li&gt;</span>
    <span class="nt">&lt;/ul&gt;</span>
    <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"navbar-nav my-2 my-md-0"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"nav-item"</span><span class="nt">&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">about_path</span><span class="p">,</span> <span class="ss">class: </span><span class="s1">'nav-link d-lg-block'</span> <span class="k">do</span> <span class="cp">%&gt;</span>
          <span class="nt">&lt;i</span> <span class="na">class=</span><span class="s">"fas fa-fw fa-info-circle"</span><span class="nt">&gt;&lt;/i&gt;</span>
          关于
        <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/li&gt;</span>
    <span class="nt">&lt;/ul&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/nav&gt;</span>
</code></pre>
								</div>
							</div>
							<p>导航栏内容从左往右为</p>
							<ul>
								<li>网站标题，链接至主页</li>
								<li>各个模型（Active Record models）的列表页面</li>
								<li>【统计】，是一个下拉菜单，其中包含三个选项：
									<ul>
										<li>【业务统计】，即该类的主页（见 3.2.11 节）</li>
										<li>储蓄业务的搜索页面</li>
										<li>贷款业务的搜索页面</li>
									</ul>
								</li>
								<li>导航栏右侧为一个「关于」页面，包含一些介绍性文字</li>
							</ul>
							<p>其中 <code class="language-plaintext highlighter-rouge">active_page</code> 为自己编写的一个帮助函数，用于对匹配的当前页面生成 active 文字，用作 CSS class 高亮显示，其内容为：</p>
							<div class="language-ruby highlighter-rouge">
								<div class="highlight">
									<pre class="highlight"><code><span class="k">module</span> <span class="nn">ApplicationHelper</span>
  <span class="k">def</span> <span class="nf">active_page</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>
    <span class="n">current_page?</span><span class="p">(</span><span class="n">page</span><span class="p">)</span> <span class="p">?</span> <span class="s1">'active'</span> <span class="p">:</span> <span class="s1">''</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
								</div>
							</div>
							<p>下面为页脚的代码：</p>
							<div class="language-erb highlighter-rouge">
								<div class="highlight">
									<pre class="highlight"><code><span class="nt">&lt;footer</span> <span class="na">class=</span><span class="s">"footer shadow py-3 py-md-4 border-top"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container px-sm-0"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">"text-muted my-0"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"https://github.com/iBug/Junk-Bank-System"</span><span class="nt">&gt;</span>Junk Bank System<span class="nt">&lt;/a&gt;</span>, Copyright <span class="ni">&amp;copy;</span> 2020-<span class="cp">&lt;%=</span> <span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">.</span><span class="nf">strftime</span> <span class="s1">'%Y'</span> <span class="cp">%&gt;</span> <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"https://github.com/iBug"</span><span class="nt">&gt;</span>iBug<span class="nt">&lt;/a&gt;</span>
    <span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
    Revision <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"https://github.com/iBug/Junk-Bank-System/commit/</span><span class="cp">&lt;%=</span> <span class="n">git_revision</span> <span class="cp">%&gt;</span><span class="s">"</span><span class="nt">&gt;&lt;code&gt;</span><span class="cp">&lt;%=</span> <span class="n">git_revision_short</span> <span class="cp">%&gt;</span><span class="nt">&lt;/code&gt;&lt;/a&gt;</span>
    <span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/footer&gt;</span>
</code></pre>
								</div>
							</div>
							<p>该页脚仅包含几个链接和版本信息，是出于美观的考虑而设置的。其中 <code class="language-plaintext highlighter-rouge">git_revision</code> 和 <code class="language-plaintext highlighter-rouge">git_revision_short</code> 为两个自定义的帮助函数，从 Rails configurations 中获取当前目录的 Git 版本信息。</p>
							<p>下面为页面底部脚本的代码：</p>
							<div class="language-erb highlighter-rouge">
								<div class="highlight">
									<pre class="highlight"><code><span class="c">&lt;%# Optional scripts %&gt;</span>
<span class="c">&lt;%# jQuery, Popper.js, Bootstrap, Rails UJS, Font Awesome, Vue.js %&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">javascript_include_tag</span> <span class="s2">"https://cdn.jsdelivr.net/npm/vue@2.6.11/dist/vue.min.js"</span><span class="p">,</span> <span class="ss">integrity: </span><span class="s2">"sha256-ngFW3UnAN0Tnm76mDuu7uUtYEcG3G5H1+zioJw3t+68="</span><span class="p">,</span> <span class="ss">crossorigin: </span><span class="s2">"anonymous"</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">javascript_include_tag</span> <span class="s2">"https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"</span><span class="p">,</span> <span class="ss">integrity: </span><span class="s2">"sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="</span><span class="p">,</span> <span class="ss">crossorigin: </span><span class="s2">"anonymous"</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">javascript_include_tag</span> <span class="s2">"https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/js/bootstrap.bundle.min.js"</span><span class="p">,</span> <span class="ss">integrity: </span><span class="s2">"sha256-Xt8pc4G0CdcRvI0nZ2lRpZ4VHng0EoUDMlGcBSQ9HiQ="</span><span class="p">,</span> <span class="ss">crossorigin: </span><span class="s2">"anonymous"</span><span class="p">,</span> <span class="ss">async: </span><span class="kp">true</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">javascript_include_tag</span> <span class="s2">"https://cdn.jsdelivr.net/npm/rails-ujs/lib/assets/compiled/rails-ujs.min.js"</span><span class="p">,</span> <span class="ss">crossorigin: </span><span class="s2">"anonymous"</span><span class="p">,</span> <span class="ss">async: </span><span class="kp">true</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%=</span> <span class="k">yield</span> <span class="ss">:body_after</span> <span class="cp">%&gt;</span>
</code></pre>
								</div>
							</div>
							<p>该部分代码按顺序载入 Vue.js，jQuery，Bootstrap 的脚本以及 <a href="https://github.com/rails/rails/tree/master/actionview/app/assets/javascripts">Rails UJS</a> 帮助脚本，并提供了一个在脚本加载完毕后插入内容的位置。</p>
							<h4 id="332-首页">3.3.2 首页</h4>
							<h4 id="333-卡片布局">3.3.3 卡片布局</h4>
							<p>本布局使用 <a href="https://getbootstrap.com/docs/4.5/components/card/">Bootstrap 的卡片外观</a>实现，代码如下：</p>
							<div class="language-erb highlighter-rouge">
								<div class="highlight">
									<pre class="highlight"><code><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"card border-info"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"card-header shadow-sm bg-info text-white text-center"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="k">yield</span> <span class="ss">:heading</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>

  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"card-body"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="k">yield</span> <span class="ss">:body</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>

  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"card-footer bg-info text-white text-center"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="k">yield</span> <span class="ss">:footer</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>

<span class="cp">&lt;%=</span> <span class="k">yield</span> <span class="ss">:after</span> <span class="cp">%&gt;</span>
</code></pre>
								</div>
							</div>
							<h4 id="334-列表页面">3.3.4 列表页面</h4>
							<p>列表页面基于 3.3.3 节所述的卡片布局，卡片标题为页面标题，卡片主体为一个表格（即 <code class="language-plaintext highlighter-rouge">&lt;table&gt;</code>），列出该模型的所有对象。下面以支行列表页面 <code class="language-plaintext highlighter-rouge">branches/index.html.erb</code> 为例展示：</p>
							<div class="language-erb highlighter-rouge">
								<div class="highlight">
									<pre class="highlight"><code><span class="cp">&lt;%</span> <span class="n">content_for</span> <span class="ss">:heading</span> <span class="k">do</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;h1</span> <span class="na">class=</span><span class="s">"mb-0"</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">title</span> <span class="s1">'支行'</span> <span class="cp">%&gt;</span><span class="nt">&lt;/h1&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

<span class="cp">&lt;%</span> <span class="n">content_for</span> <span class="ss">:body</span> <span class="k">do</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;table</span> <span class="na">class=</span><span class="s">"table table-hover mb-0 with-action"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;thead&gt;</span>
      <span class="nt">&lt;tr&gt;</span>
        <span class="nt">&lt;th&gt;</span>支行名称<span class="nt">&lt;/th&gt;</span>
        <span class="nt">&lt;th&gt;</span>城市<span class="nt">&lt;/th&gt;</span>
        <span class="nt">&lt;th&gt;</span>资产<span class="nt">&lt;/th&gt;</span>
        <span class="nt">&lt;th&gt;</span>操作<span class="nt">&lt;/th&gt;</span>
      <span class="nt">&lt;/tr&gt;</span>
    <span class="nt">&lt;/thead&gt;</span>

    <span class="nt">&lt;tbody</span> <span class="na">id=</span><span class="s">"search-content"</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%</span> <span class="vi">@branches</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">branch</span><span class="o">|</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;tr&gt;</span>
          <span class="nt">&lt;td&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">branch</span><span class="p">.</span><span class="nf">name</span><span class="p">,</span> <span class="n">branch</span> <span class="cp">%&gt;</span><span class="nt">&lt;/td&gt;</span>
          <span class="nt">&lt;td&gt;</span><span class="cp">&lt;%=</span> <span class="n">branch</span><span class="p">.</span><span class="nf">city</span> <span class="cp">%&gt;</span><span class="nt">&lt;/td&gt;</span>
          <span class="nt">&lt;td&gt;</span><span class="cp">&lt;%=</span> <span class="n">branch</span><span class="p">.</span><span class="nf">assets</span> <span class="cp">%&gt;</span><span class="nt">&lt;/td&gt;</span>
          <span class="nt">&lt;td&gt;</span>
            <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">raw</span><span class="p">(</span><span class="n">t</span><span class="s1">'actions.view'</span><span class="p">),</span> <span class="n">branch</span><span class="p">,</span> <span class="ss">class: </span><span class="s1">'btn btn-outline-primary'</span> <span class="cp">%&gt;</span>
            <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">raw</span><span class="p">(</span><span class="n">t</span><span class="s1">'actions.edit'</span><span class="p">),</span> <span class="n">edit_branch_path</span><span class="p">(</span><span class="n">branch</span><span class="p">),</span> <span class="ss">class: </span><span class="s1">'btn btn-outline-secondary'</span> <span class="cp">%&gt;</span>
            <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">raw</span><span class="p">(</span><span class="n">t</span><span class="s1">'actions.destroy'</span><span class="p">),</span> <span class="n">branch</span><span class="p">,</span> <span class="ss">method: :delete</span><span class="p">,</span> <span class="ss">class: </span><span class="s1">'btn btn-outline-danger'</span><span class="p">,</span> <span class="ss">data: </span><span class="p">{</span> <span class="ss">confirm: </span><span class="n">t</span><span class="p">(</span><span class="s1">'confirm'</span><span class="p">)</span> <span class="p">}</span> <span class="cp">%&gt;</span>
          <span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;/tr&gt;</span>
      <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/tbody&gt;</span>
  <span class="nt">&lt;/table&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

<span class="cp">&lt;%</span> <span class="n">content_for</span> <span class="ss">:footer</span> <span class="k">do</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s1">'新建支行'</span><span class="p">,</span> <span class="n">new_branch_path</span><span class="p">,</span> <span class="ss">class: </span><span class="s1">'btn btn-success'</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">"btn btn-primary"</span> <span class="na">href=</span><span class="s">"#search-form"</span> <span class="na">data-toggle=</span><span class="s">"collapse"</span> <span class="na">role=</span><span class="s">"button"</span> <span class="na">aria-expanded=</span><span class="s">"false"</span> <span class="na">aria-controls=</span><span class="s">"search-form"</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">raw</span><span class="p">(</span><span class="n">t</span><span class="s1">'actions.search'</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="nt">&lt;/a&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="ss">partial: </span><span class="s1">'quick_search'</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">render</span> <span class="ss">template: </span><span class="s1">'layouts/listing'</span> <span class="cp">%&gt;</span>
</code></pre>
								</div>
							</div>
							<p>卡片标题与页面标题一致，使用自定义的 <code class="language-plaintext highlighter-rouge">title</code> 帮助函数完成，其代码如下：</p>
							<div class="language-ruby highlighter-rouge">
								<div class="highlight">
									<pre class="highlight"><code><span class="k">module</span> <span class="nn">ApplicationHelper</span>
  <span class="k">def</span> <span class="nf">title</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="n">content_for</span> <span class="ss">:title</span><span class="p">,</span> <span class="n">text</span>
    <span class="n">text</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
								</div>
							</div>
							<p>卡片主体只有一个表格，使用了一些 Bootstrap 样式及自定义样式（见 3.4.2 节）以美化，</p>
							<p>卡片脚部包含了一个指向「新建支行」页面，以及页面内的快捷搜索功能。</p>
							<h5 id="快捷搜索功能">快捷搜索功能</h5>
							<p>页面内的快捷搜索功能采用纯前端方案实现，具体做法为文字匹配，支持正则表达式。</p>
							<p>搜索功能由两个部件组成，控制部件与内容部件，其中内容部件即上面代码中的 <code class="language-plaintext highlighter-rouge">&lt;tbody id="search-content"&gt;</code>，控制部件由一个【搜索】按钮和展开式搜索输入框组成。点击【搜索】按钮会展开 / 隐藏输入框，该特性使用 Bootstrap 实现。搜索输入框为一个普通的文本输入框，其使用 <code class="language-plaintext highlighter-rouge">oninput</code> 事件在输入时执行 JavaScript 代码。<code class="language-plaintext highlighter-rouge">quick_search</code> 部件代码如下：</p>
							<div class="language-erb highlighter-rouge">
								<div class="highlight">
									<pre class="highlight"><code><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"collapse"</span> <span class="na">id=</span><span class="s">"search-form"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form-group pt-3 mb-0"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"search-input"</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">class=</span><span class="s">"form-control"</span> <span class="na">placeholder=</span><span class="s">"输入以开始搜索"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>

<span class="cp">&lt;%</span> <span class="n">content_for</span> <span class="ss">:after</span> <span class="k">do</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">javascript_include_tag</span> <span class="s2">"quick-search.js"</span><span class="p">,</span> <span class="ss">async: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">defer: </span><span class="kp">true</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</code></pre>
								</div>
							</div>
							<p>搜索代码 <code class="language-plaintext highlighter-rouge">quick-search.js</code> 如下：</p>
							<div class="language-javascript highlighter-rouge">
								<div class="highlight">
									<pre class="highlight"><code><span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">'</span><span class="s1">search-input</span><span class="dl">'</span><span class="p">).</span><span class="nx">oninput</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">searchTerm</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">'</span><span class="s1">search-input</span><span class="dl">'</span><span class="p">).</span><span class="nx">value</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">searchRegex</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="nx">searchRegex</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RegExp</span><span class="p">(</span><span class="nx">searchTerm</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
    <span class="c1">// Bad regex, ignore</span>
  <span class="p">}</span>
  <span class="kd">var</span> <span class="nx">tbody</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">'</span><span class="s1">search-content</span><span class="dl">'</span><span class="p">);</span>

  <span class="k">for </span><span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">tbody</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">tr</span> <span class="o">=</span> <span class="nx">tbody</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
    <span class="kd">var</span> <span class="nx">match</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">texts</span> <span class="o">=</span> <span class="p">[];</span>

    <span class="c1">// Filter: Exclude last element because it contains only action buttons</span>
    <span class="k">for </span><span class="p">(</span><span class="kd">let</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">tr</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">td</span> <span class="o">=</span> <span class="nx">tr</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="nx">j</span><span class="p">];</span>
      <span class="nx">texts</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="nx">td</span><span class="p">.</span><span class="nx">innerText</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">text</span> <span class="o">=</span> <span class="nx">texts</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="dl">"</span><span class="se">\n</span><span class="dl">"</span><span class="p">);</span>

    <span class="k">if </span><span class="p">(</span><span class="nx">text</span><span class="p">.</span><span class="nf">indexOf</span><span class="p">(</span><span class="nx">searchTerm</span><span class="p">)</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">match</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if </span><span class="p">(</span><span class="k">typeof</span> <span class="nx">searchRegex</span> <span class="o">!==</span> <span class="dl">"</span><span class="s2">undefined</span><span class="dl">"</span> <span class="o">&amp;&amp;</span> <span class="nx">searchRegex</span><span class="p">.</span><span class="nf">test</span><span class="p">(</span><span class="nx">text</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">match</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">tr</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="nx">match</span> <span class="p">?</span> <span class="dl">""</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">none</span><span class="dl">"</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span>
</code></pre>
								</div>
							</div>
							<p>该代码首先尝试将文本框内容作为正则表达式编译，若编译失败则忽略。随后对表格的每一行进行文字匹配与（若正则表达式编译成功）正则匹配，将不匹配的行全部隐藏。由于空字符串是任何字符串的子串，所以当输入框为空时所有内容都显示出来，符合直觉。</p>
							<h4 id="335-详细信息页面">3.3.5 详细信息页面</h4>
							<p>详细信息页面同样使用卡片布局，但与列表页面不同之处在于详细信息页面不使用 <code class="language-plaintext highlighter-rouge">&lt;table&gt;</code> 列出信息，而是使用 <a href="https://developer.mozilla.org/en/docs/Web/HTML/Element/dl"><code class="language-plaintext highlighter-rouge">&lt;dl&gt;</code> 标签</a>。除此之外，由于详细信息页面一次只列出一个对象，所以其通常包含更多信息（如支行的关联员工、账户、贷款等），这在列表页面会带来大量的数据库查询，但在详细信息页面所使用的额外数据库查询数量完全可以接受。下面以支行详细信息页面 <code class="language-plaintext highlighter-rouge">branches/show.html.erb</code> 为例展示：</p>
							<div class="language-erb highlighter-rouge">
								<div class="highlight">
									<pre class="highlight"><code><span class="cp">&lt;%</span> <span class="n">content_for</span> <span class="ss">:heading</span> <span class="k">do</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;h1</span> <span class="na">class=</span><span class="s">"mb-0"</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">title</span> <span class="s2">"支行 </span><span class="si">#{</span><span class="vi">@branch</span><span class="p">.</span><span class="nf">name</span><span class="si">}</span><span class="s2">"</span> <span class="cp">%&gt;</span><span class="nt">&lt;/h1&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

<span class="cp">&lt;%</span> <span class="n">content_for</span> <span class="ss">:body</span> <span class="k">do</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;dl</span> <span class="na">class=</span><span class="s">"row my-0"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;dt</span> <span class="na">class=</span><span class="s">"col col-12 col-md-2"</span><span class="nt">&gt;</span>名称<span class="nt">&lt;/dt&gt;</span>
    <span class="nt">&lt;dd</span> <span class="na">class=</span><span class="s">"col col-12 col-md-10"</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="vi">@branch</span><span class="p">.</span><span class="nf">name</span> <span class="cp">%&gt;</span><span class="nt">&lt;/dd&gt;</span>
    <span class="nt">&lt;dt</span> <span class="na">class=</span><span class="s">"col col-12 col-md-2"</span><span class="nt">&gt;</span>城市<span class="nt">&lt;/dt&gt;</span>
    <span class="nt">&lt;dd</span> <span class="na">class=</span><span class="s">"col col-12 col-md-10"</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="vi">@branch</span><span class="p">.</span><span class="nf">city</span> <span class="cp">%&gt;</span><span class="nt">&lt;/dd&gt;</span>
    <span class="nt">&lt;dt</span> <span class="na">class=</span><span class="s">"col col-12 col-md-2"</span><span class="nt">&gt;</span>资产<span class="nt">&lt;/dt&gt;</span>
    <span class="nt">&lt;dd</span> <span class="na">class=</span><span class="s">"col col-12 col-md-10"</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="vi">@branch</span><span class="p">.</span><span class="nf">assets</span> <span class="cp">%&gt;</span><span class="nt">&lt;/dd&gt;</span>
    <span class="nt">&lt;dt</span> <span class="na">class=</span><span class="s">"col col-12 col-md-2"</span><span class="nt">&gt;</span>员工<span class="nt">&lt;/dt&gt;</span>
    <span class="nt">&lt;dd</span> <span class="na">class=</span><span class="s">"col col-12 col-md-10"</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">list_items</span> <span class="vi">@staffs</span><span class="p">,</span> <span class="ss">view_all: </span><span class="n">branch_staffs_path</span><span class="p">(</span><span class="vi">@branch</span><span class="p">)</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/dd&gt;</span>
    <span class="nt">&lt;dt</span> <span class="na">class=</span><span class="s">"col col-12 col-md-2"</span><span class="nt">&gt;</span>账户<span class="nt">&lt;/dt&gt;</span>
    <span class="nt">&lt;dd</span> <span class="na">class=</span><span class="s">"col col-12 col-md-10"</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">list_items</span> <span class="vi">@accounts</span><span class="p">,</span> <span class="ss">name_field: :id</span><span class="p">,</span> <span class="ss">separator: </span><span class="s1">','</span><span class="p">,</span> <span class="ss">view_all: </span><span class="n">branch_accounts_path</span><span class="p">(</span><span class="vi">@branch</span><span class="p">)</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/dd&gt;</span>
    <span class="nt">&lt;dt</span> <span class="na">class=</span><span class="s">"col col-12 col-md-2"</span><span class="nt">&gt;</span>贷款<span class="nt">&lt;/dt&gt;</span>
    <span class="nt">&lt;dd</span> <span class="na">class=</span><span class="s">"col col-12 col-md-10"</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">list_items</span> <span class="vi">@loans</span><span class="p">,</span> <span class="ss">name_field: :id</span><span class="p">,</span> <span class="ss">separator: </span><span class="s1">','</span><span class="p">,</span> <span class="ss">view_all: </span><span class="n">branch_loans_path</span><span class="p">(</span><span class="vi">@branch</span><span class="p">)</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/dd&gt;</span>
  <span class="nt">&lt;/dl&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

<span class="cp">&lt;%</span> <span class="n">content_for</span> <span class="ss">:footer</span> <span class="k">do</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">raw</span><span class="p">(</span><span class="n">t</span><span class="s1">'actions.edit'</span><span class="p">),</span> <span class="n">edit_branch_path</span><span class="p">(</span><span class="vi">@branch</span><span class="p">),</span> <span class="ss">class: </span><span class="s1">'btn btn-primary'</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">raw</span><span class="p">(</span><span class="n">t</span><span class="s1">'actions.back'</span><span class="p">),</span> <span class="n">branches_path</span><span class="p">,</span> <span class="ss">class: </span><span class="s1">'btn btn-secondary'</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">raw</span><span class="p">(</span><span class="n">t</span><span class="s1">'actions.destroy'</span><span class="p">),</span> <span class="vi">@branch</span><span class="p">,</span> <span class="ss">method: :delete</span><span class="p">,</span> <span class="ss">class: </span><span class="s1">'btn btn-danger'</span><span class="p">,</span> <span class="ss">data: </span><span class="p">{</span> <span class="ss">confirm: </span><span class="n">t</span><span class="p">(</span><span class="s1">'confirm'</span><span class="p">)</span> <span class="p">}</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">render</span> <span class="ss">template: </span><span class="s1">'layouts/card.html'</span> <span class="cp">%&gt;</span>
</code></pre>
								</div>
							</div>
							<p>标题的实现方式与列表页面相同，除了内容增加了识别信息（对于支行、部门、员工和客户，使用名称作为识别信息，对于账户和贷款则使用编号）。</p>
							<p>主体部分为一个 <code class="language-plaintext highlighter-rouge">&lt;dl&gt;</code> 元素，列出所展示对象的全部适用的属性及关联对象。<code class="language-plaintext highlighter-rouge">list_items</code> 为一个自定义帮助函数，其内容如下：</p>
							<div class="language-ruby highlighter-rouge">
								<div class="highlight">
									<pre class="highlight"><code><span class="k">module</span> <span class="nn">ApplicationHelper</span>
  <span class="k">def</span> <span class="nf">list_items</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="p">{})</span>
    <span class="n">render</span> <span class="ss">partial: </span><span class="s1">'inline_listing'</span><span class="p">,</span> <span class="ss">locals: </span><span class="n">options</span><span class="p">.</span><span class="nf">merge</span><span class="p">(</span><span class="ss">items: </span><span class="n">items</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
								</div>
							</div>
							<p>对应的列表模板 <code class="language-plaintext highlighter-rouge">application/_inline_listing.html.erb</code> 如下：</p>
							<div class="language-erb highlighter-rouge">
								<div class="highlight">
									<pre class="highlight"><code><span class="cp">&lt;%</span> <span class="n">limit</span> <span class="o">||=</span> <span class="mi">3</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="n">name_field</span> <span class="o">||=</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="n">separator</span> <span class="o">||=</span> <span class="kp">false</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="n">view_all</span> <span class="o">||=</span> <span class="n">root_path</span> <span class="cp">%&gt;</span>

<span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">separator</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%</span> <span class="n">items</span><span class="p">.</span><span class="nf">limit</span><span class="p">(</span><span class="n">limit</span><span class="p">).</span><span class="nf">each_with_index</span> <span class="k">do</span> <span class="o">|</span><span class="n">item</span><span class="p">,</span> <span class="n">index</span><span class="o">|</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">separator</span> <span class="k">unless</span> <span class="n">index</span><span class="p">.</span><span class="nf">zero?</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">item</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">name_field</span><span class="p">),</span> <span class="n">item</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"list-unstyled mb-0"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%</span> <span class="n">items</span><span class="p">.</span><span class="nf">limit</span><span class="p">(</span><span class="n">limit</span><span class="p">).</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">item</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">name_field</span><span class="p">),</span> <span class="n">item</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/ul&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

<span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">items</span><span class="p">.</span><span class="nf">empty?</span> <span class="cp">%&gt;</span>
  无
<span class="cp">&lt;%</span> <span class="k">elsif</span> <span class="n">items</span><span class="p">.</span><span class="nf">size</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">separator</span> <span class="cp">%&gt;</span>
  <span class="ni">&amp;hellip;</span>
  <span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
  共 <span class="cp">&lt;%=</span> <span class="n">items</span><span class="p">.</span><span class="nf">size</span> <span class="cp">%&gt;</span> 个，<span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s1">'查看全部'</span><span class="p">,</span> <span class="n">view_all</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</code></pre>
								</div>
							</div>
							<p>该列表列出了默认前 3 个对象，并在总数超过该默认值时显示总数及一个「查看全部」的链接。</p>
							<p>卡片脚部为【编辑】（当前对象）、【返回】和【删除】三个按钮，其中在不适用的场合下【编辑】和【删除】按钮可能不存在，例如贷款的详细信息页面，当贷款状态为「发放中」时。这些按钮的功能都使用 Rails 自带的库实现。</p>
							<h4 id="336-创建--编辑表格">3.3.6 创建 / 编辑表格</h4>
							<p>模型表格使用 Rails 自带的 Action View Forms 实现，在新建对象时能够自动填充为默认值，在编辑对象时能够自动填充为当前值。下面以支行的编辑表格 <code class="language-plaintext highlighter-rouge">branches/_form.html.erb</code> 为例展示：</p>
							<div class="language-erb highlighter-rouge">
								<div class="highlight">
									<pre class="highlight"><code><span class="cp">&lt;%=</span> <span class="n">form_with</span> <span class="ss">model: </span><span class="n">branch</span><span class="p">,</span> <span class="ss">local: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">class: </span><span class="s1">'my-3'</span> <span class="k">do</span> <span class="o">|</span><span class="n">form</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="ss">partial: </span><span class="s1">'error_explanation'</span><span class="p">,</span> <span class="ss">locals: </span><span class="p">{</span> <span class="ss">model: </span><span class="n">branch</span> <span class="p">}</span> <span class="cp">%&gt;</span>

  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form-group"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form</span><span class="p">.</span><span class="nf">label</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form</span><span class="p">.</span><span class="nf">text_field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">class: </span><span class="s1">'form-control'</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>

  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form-group"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form</span><span class="p">.</span><span class="nf">label</span> <span class="ss">:city</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form</span><span class="p">.</span><span class="nf">text_field</span> <span class="ss">:city</span><span class="p">,</span> <span class="ss">class: </span><span class="s1">'form-control'</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>

  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form-group"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form</span><span class="p">.</span><span class="nf">label</span> <span class="ss">:assets</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form</span><span class="p">.</span><span class="nf">number_field</span> <span class="ss">:assets</span><span class="p">,</span> <span class="ss">step: </span><span class="mf">0.01</span><span class="p">,</span> <span class="ss">class: </span><span class="s1">'form-control'</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>

  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"actions"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form</span><span class="p">.</span><span class="nf">submit</span> <span class="ss">class: </span><span class="s1">'btn btn-success'</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</code></pre>
								</div>
							</div>
							<p>其中账户的新建页面有个别选项会随「账户类型」的选择而变化，且「账户类型」选项在编辑时是不可修改的。该功能使用 Vue.js 实现，相关部分代码如下：</p>
							<div class="language-erb highlighter-rouge">
								<div class="highlight">
									<pre class="highlight"><code><span class="cp">&lt;%=</span> <span class="n">form_with</span> <span class="ss">model: </span><span class="n">account</span><span class="p">,</span> <span class="ss">local: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">id: </span><span class="s1">'account-form'</span><span class="p">,</span> <span class="ss">class: </span><span class="s1">'my-3'</span> <span class="k">do</span> <span class="o">|</span><span class="n">form</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form-group"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form</span><span class="p">.</span><span class="nf">label</span> <span class="ss">:accountable_type</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form</span><span class="p">.</span><span class="nf">select</span> <span class="ss">:accountable_type</span><span class="p">,</span> <span class="n">options_for_select</span><span class="p">(</span><span class="sx">%w[储蓄账户 支票账户]</span><span class="p">.</span><span class="nf">zip</span><span class="p">(</span><span class="sx">%i[DepositAccount CheckAccount]</span><span class="p">),</span> <span class="n">account</span><span class="p">.</span><span class="nf">accountable_type</span><span class="p">),</span> <span class="p">{},</span> <span class="p">{</span> <span class="ss">class: </span><span class="s1">'form-control'</span><span class="p">,</span> <span class="s1">'v-model'</span><span class="p">:</span> <span class="s1">'accountType'</span><span class="p">,</span> <span class="ss">disabled: </span><span class="o">!</span><span class="n">account</span><span class="p">.</span><span class="nf">new_record?</span> <span class="p">}</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>

  <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">account</span><span class="p">.</span><span class="nf">new_record?</span> <span class="o">||</span> <span class="n">account</span><span class="p">.</span><span class="nf">accountable_type</span> <span class="o">==</span> <span class="s1">'DepositAccount'</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span> <span class="na">v-if=</span><span class="s">"accountType === 'DepositAccount'"</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">form</span><span class="p">.</span><span class="nf">fields_for</span> <span class="ss">:accountable</span><span class="p">,</span> <span class="p">(</span><span class="n">account</span><span class="p">.</span><span class="nf">new_record?</span> <span class="p">?</span> <span class="no">DepositAccount</span><span class="p">.</span><span class="nf">new</span> <span class="p">:</span> <span class="n">account</span><span class="p">.</span><span class="nf">accountable</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form-group pr-sm-0 col"</span><span class="nt">&gt;</span>
          <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">label</span> <span class="ss">:interest_rate</span> <span class="cp">%&gt;</span>
          <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">number_field</span> <span class="ss">:interest_rate</span><span class="p">,</span> <span class="ss">step: :any</span><span class="p">,</span> <span class="ss">class: </span><span class="s1">'form-control'</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form-group col col-12 col-sm-4 col-lg-3 col-xl-2"</span><span class="nt">&gt;</span>
          <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">label</span> <span class="ss">:currency</span> <span class="cp">%&gt;</span>
          <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">text_field</span> <span class="ss">:currency</span><span class="p">,</span> <span class="ss">class: </span><span class="s1">'form-control'</span><span class="p">,</span> <span class="ss">maxlength: </span><span class="mi">3</span><span class="p">,</span> <span class="ss">value: </span><span class="n">f</span><span class="p">.</span><span class="nf">object</span><span class="p">.</span><span class="nf">currency</span><span class="p">.</span><span class="nf">upcase</span><span class="p">,</span> <span class="ss">style: </span><span class="s1">'font-family: Consolas, monospace; text-transform: uppercase;'</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
      <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

  <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">account</span><span class="p">.</span><span class="nf">new_record?</span> <span class="o">||</span> <span class="n">account</span><span class="p">.</span><span class="nf">accountable_type</span> <span class="o">==</span> <span class="s1">'CheckAccount'</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">v-if=</span><span class="s">"accountType === 'CheckAccount'"</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">form</span><span class="p">.</span><span class="nf">fields_for</span> <span class="ss">:accountable</span><span class="p">,</span> <span class="p">(</span><span class="n">account</span><span class="p">.</span><span class="nf">new_record?</span> <span class="p">?</span> <span class="no">CheckAccount</span><span class="p">.</span><span class="nf">new</span> <span class="p">:</span> <span class="n">account</span><span class="p">.</span><span class="nf">accountable</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form-group"</span><span class="nt">&gt;</span>
          <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">label</span> <span class="ss">:withdraw_amount</span> <span class="cp">%&gt;</span>
          <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">number_field</span> <span class="ss">:withdraw_amount</span><span class="p">,</span> <span class="ss">step: </span><span class="mf">0.01</span><span class="p">,</span> <span class="ss">class: </span><span class="s1">'form-control'</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
      <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

  <span class="cp">&lt;%</span> <span class="n">content_for</span> <span class="ss">:body_after</span> <span class="k">do</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"text/javascript"</span><span class="nt">&gt;</span>
      <span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Vue</span><span class="p">({</span>
        <span class="na">el</span><span class="p">:</span> <span class="dl">'</span><span class="s1">#account-form</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">data</span><span class="p">:</span> <span class="p">{</span><span class="na">accountType</span><span class="p">:</span> <span class="nb">document</span><span class="p">.</span><span class="nf">querySelector</span><span class="p">(</span><span class="dl">'</span><span class="s1">[v-model="accountType"]</span><span class="dl">'</span><span class="p">).</span><span class="nx">value</span><span class="p">}</span>
      <span class="p">});</span>
    <span class="nt">&lt;/script&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</code></pre>
								</div>
							</div>
							<h4 id="337-关联信息列表页面">3.3.7 关联信息列表页面</h4>
							<p>该页面用于</p>
							<ul>
								<li>支行的关联员工、账户、贷款</li>
								<li>部门的关联员工</li>
								<li>员工的关联客户</li>
							</ul>
							<p>使用一个 <code class="language-plaintext highlighter-rouge">&lt;div&gt;</code> 标签列出全部项目，每个项目自己占据一行，代码如下：</p>
							<div class="language-erb highlighter-rouge">
								<div class="highlight">
									<pre class="highlight"><code><span class="cp">&lt;%</span> <span class="n">name_field</span> <span class="o">||=</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>

<span class="cp">&lt;%</span> <span class="n">content_for</span> <span class="ss">:heading</span> <span class="k">do</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;h1</span> <span class="na">class=</span><span class="s">"mb-0"</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">title</span> <span class="n">heading</span> <span class="cp">%&gt;</span><span class="nt">&lt;/h1&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

<span class="cp">&lt;%</span> <span class="n">content_for</span> <span class="ss">:body</span> <span class="k">do</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"list-group list-group-flush my-0"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%</span> <span class="n">items</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">item</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">name_field</span><span class="p">),</span> <span class="n">item</span><span class="p">,</span> <span class="ss">class: </span><span class="s1">'list-group-item list-group-item-action'</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

<span class="cp">&lt;%</span> <span class="n">content_for</span> <span class="ss">:footer</span> <span class="k">do</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">raw</span><span class="p">(</span><span class="n">t</span><span class="s1">'actions.back'</span><span class="p">),</span> <span class="n">back_to</span><span class="p">,</span> <span class="ss">class: </span><span class="s1">'btn btn-primary'</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">render</span> <span class="ss">template: </span><span class="s1">'layouts/listing'</span> <span class="cp">%&gt;</span>
</code></pre>
								</div>
							</div>
							<h4 id="338-账户的关联客户页面">3.3.8 账户的关联客户页面</h4>
							<p>账户的关联客户页面与 3.3.7 节所述的关联信息列表页面不同，使用一个完整的 table 以列出额外信息，如客户访问账户的时间等。另外主卡片下方还有一个额外卡片，作为「添加新关联客户」的表格。代码 <code class="language-plaintext highlighter-rouge">accounts/owners.html.erb</code> 如下：</p>
							<div class="language-erb highlighter-rouge">
								<div class="highlight">
									<pre class="highlight"><code><span class="cp">&lt;%</span> <span class="n">content_for</span> <span class="ss">:heading</span> <span class="k">do</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;h1</span> <span class="na">class=</span><span class="s">"mb-0"</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">title</span> <span class="s2">"账户 </span><span class="se">\#</span><span class="si">#{</span><span class="vi">@account</span><span class="p">.</span><span class="nf">id</span><span class="si">}</span><span class="s2"> 的关联客户"</span> <span class="cp">%&gt;</span><span class="nt">&lt;/h1&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

<span class="cp">&lt;%</span> <span class="n">content_for</span> <span class="ss">:body</span> <span class="k">do</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;table</span> <span class="na">class=</span><span class="s">"table table-hover mb-0 with-action"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;thead&gt;</span>
      <span class="nt">&lt;tr&gt;</span>
        <span class="nt">&lt;th&gt;</span>客户<span class="nt">&lt;/th&gt;</span>
        <span class="nt">&lt;th&gt;</span>最近访问时间<span class="nt">&lt;/th&gt;</span>
        <span class="nt">&lt;th&gt;</span>操作<span class="nt">&lt;/th&gt;</span>
      <span class="nt">&lt;/tr&gt;</span>
    <span class="nt">&lt;/thead&gt;</span>

    <span class="nt">&lt;tbody&gt;</span>
      <span class="cp">&lt;%</span> <span class="vi">@owners</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">owner</span><span class="o">|</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;tr&gt;</span>
          <span class="nt">&lt;td&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">owner</span><span class="p">.</span><span class="nf">client_name</span><span class="p">,</span> <span class="n">clients_path</span><span class="p">(</span><span class="n">owner</span><span class="p">.</span><span class="nf">client_id</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="nt">&lt;/td&gt;</span>
          <span class="nt">&lt;td&gt;</span><span class="cp">&lt;%=</span> <span class="n">owner</span><span class="p">.</span><span class="nf">last_access</span> <span class="cp">%&gt;</span><span class="nt">&lt;/td&gt;</span>
          <span class="nt">&lt;td&gt;</span>
            <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">raw</span><span class="p">(</span><span class="n">t</span><span class="s1">'actions.destroy'</span><span class="p">),</span> <span class="n">destroy_account_owner_path</span><span class="p">(</span><span class="vi">@account</span><span class="p">,</span> <span class="n">owner</span><span class="p">.</span><span class="nf">client_id</span><span class="p">),</span> <span class="ss">method: :delete</span><span class="p">,</span> <span class="ss">class: </span><span class="s1">'text-danger'</span><span class="p">,</span> <span class="ss">data: </span><span class="p">{</span> <span class="ss">confirm: </span><span class="n">t</span><span class="p">(</span><span class="s1">'confirm'</span><span class="p">)</span> <span class="p">}</span> <span class="cp">%&gt;</span>
          <span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;/tr&gt;</span>
      <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/tbody&gt;</span>
  <span class="nt">&lt;/table&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

<span class="cp">&lt;%</span> <span class="n">content_for</span> <span class="ss">:footer</span> <span class="k">do</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">raw</span><span class="p">(</span><span class="n">t</span><span class="s1">'actions.back'</span><span class="p">),</span> <span class="vi">@account</span><span class="p">,</span> <span class="ss">class: </span><span class="s1">'btn btn-primary'</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

<span class="cp">&lt;%</span> <span class="n">content_for</span> <span class="ss">:after</span> <span class="k">do</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">if</span> <span class="vi">@available_clients</span><span class="p">.</span><span class="nf">empty?</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"my-3"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;p&gt;</span>无客户可添加<span class="nt">&lt;/p&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form_with</span> <span class="ss">url: </span><span class="n">new_account_owner_path</span><span class="p">,</span> <span class="ss">local: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">class: </span><span class="s1">'my-3'</span> <span class="k">do</span> <span class="o">|</span><span class="n">form</span><span class="o">|</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"card"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"card-header"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;h3</span> <span class="na">class=</span><span class="s">"my-0"</span><span class="nt">&gt;</span>新增客户<span class="nt">&lt;/h3&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"card-body"</span><span class="nt">&gt;</span>
          <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="ss">partial: </span><span class="s1">'error_explanation'</span><span class="p">,</span> <span class="ss">locals: </span><span class="p">{</span> <span class="ss">model: </span><span class="vi">@account</span> <span class="p">}</span> <span class="cp">%&gt;</span>

          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form-group"</span><span class="nt">&gt;</span>
            <span class="cp">&lt;%=</span> <span class="n">form</span><span class="p">.</span><span class="nf">fields_for</span> <span class="ss">:ownerships</span><span class="p">,</span> <span class="no">Ownership</span><span class="p">.</span><span class="nf">new</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
              <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">label</span> <span class="ss">:client_id</span><span class="p">,</span> <span class="s1">'新增关联客户'</span> <span class="cp">%&gt;</span>
              <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">select</span> <span class="ss">:client_id</span><span class="p">,</span> <span class="n">options_from_collection_for_select</span><span class="p">(</span><span class="vi">@available_clients</span><span class="p">,</span> <span class="ss">:id</span><span class="p">,</span> <span class="ss">:name</span><span class="p">),</span> <span class="p">{},</span> <span class="p">{</span> <span class="ss">class: </span><span class="s1">'form-control'</span> <span class="p">}</span> <span class="cp">%&gt;</span>
            <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
          <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;/div&gt;</span>

        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"card-footer"</span><span class="nt">&gt;</span>
          <span class="cp">&lt;%=</span> <span class="n">form</span><span class="p">.</span><span class="nf">submit</span> <span class="s1">'添加客户'</span><span class="p">,</span> <span class="ss">class: </span><span class="s1">'btn btn-success'</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">render</span> <span class="ss">template: </span><span class="s1">'layouts/listing'</span> <span class="cp">%&gt;</span>
</code></pre>
								</div>
							</div>
							<p>其中选择新关联客户的下拉选单仅显示可正常添加的客户（不存在冲突账户的客户），其产生逻辑见 3.2.7 节。</p>
							<h4 id="339-业务统计页面">3.3.9 「业务统计」页面</h4>
							<p>业务统计页面包含两个大卡片，分别列出储蓄业务概览数据及贷款业务概览数据，内容参见 3.2.11 节，代码 <code class="language-plaintext highlighter-rouge">stats/index.html.erb</code> 如下：</p>
							<div class="language-erb highlighter-rouge">
								<div class="highlight">
									<pre class="highlight"><code><span class="cp">&lt;%</span> <span class="n">card_class</span> <span class="o">=</span> <span class="s1">'shadow flex-grow-1 px-0 mb-4'</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="n">dl_class</span> <span class="o">=</span> <span class="s1">'row mb-0'</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="n">dt_class</span> <span class="o">=</span> <span class="s1">'col col-6 px-2 text-right'</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="n">dd_class</span> <span class="o">=</span> <span class="s1">'col col-6 px-2'</span> <span class="cp">%&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">render</span> <span class="ss">partial: </span><span class="s1">'svg_header'</span><span class="p">,</span> <span class="ss">locals: </span><span class="p">{</span> <span class="ss">file: </span><span class="s1">'combo-chart.svg'</span><span class="p">,</span> <span class="ss">text: </span><span class="n">title</span><span class="p">(</span><span class="s1">'数据统计'</span><span class="p">)</span> <span class="p">}</span> <span class="cp">%&gt;</span>

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row d-flex flex-column flex-md-row"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col col-12 col-md-6 d-flex flex-column flex-grow-1"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"card </span><span class="cp">&lt;%=</span> <span class="n">card_class</span> <span class="cp">%&gt;</span><span class="s">"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"card-header text-center bg-success text-light"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;h3</span> <span class="na">class=</span><span class="s">"mb-0 font-weight-normal"</span><span class="nt">&gt;</span>储蓄业务<span class="nt">&lt;/h3&gt;</span>
      <span class="nt">&lt;/div&gt;</span>

      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"card-body pb-3"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;dl</span> <span class="na">class=</span><span class="s">"</span><span class="cp">&lt;%=</span> <span class="n">dl_class</span> <span class="cp">%&gt;</span><span class="s">"</span><span class="nt">&gt;</span>
          <span class="cp">&lt;%</span> <span class="vi">@deposit_card_content</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">dt</span><span class="p">,</span> <span class="n">dd</span><span class="o">|</span> <span class="cp">%&gt;</span>
            <span class="nt">&lt;dt</span> <span class="na">class=</span><span class="s">"</span><span class="cp">&lt;%=</span> <span class="n">dt_class</span> <span class="cp">%&gt;</span><span class="s">"</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">dt</span> <span class="cp">%&gt;</span><span class="nt">&lt;/dt&gt;</span>
            <span class="nt">&lt;dd</span> <span class="na">class=</span><span class="s">"</span><span class="cp">&lt;%=</span> <span class="n">dd_class</span> <span class="cp">%&gt;</span><span class="s">"</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">dd</span> <span class="cp">%&gt;</span><span class="nt">&lt;/dd&gt;</span>
          <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;/dl&gt;</span>
      <span class="nt">&lt;/div&gt;</span>

      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"card-footer text-center bg-success text-light"</span><span class="nt">&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">raw</span><span class="p">(</span><span class="n">t</span><span class="s1">'actions.info'</span><span class="p">),</span> <span class="n">deposit_stats_path</span><span class="p">,</span> <span class="ss">class: </span><span class="s1">'btn btn-primary'</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>

  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col col-12 col-md-6 d-flex flex-column flex-grow-1"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"card </span><span class="cp">&lt;%=</span> <span class="n">card_class</span> <span class="cp">%&gt;</span><span class="s">"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"card-header text-center bg-danger text-light"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;h3</span> <span class="na">class=</span><span class="s">"mb-0 font-weight-normal"</span><span class="nt">&gt;</span>贷款业务<span class="nt">&lt;/h3&gt;</span>
      <span class="nt">&lt;/div&gt;</span>

      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"card-body pb-3"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;dl</span> <span class="na">class=</span><span class="s">"</span><span class="cp">&lt;%=</span> <span class="n">dl_class</span> <span class="cp">%&gt;</span><span class="s">"</span><span class="nt">&gt;</span>
          <span class="cp">&lt;%</span> <span class="vi">@loan_card_content</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">dt</span><span class="p">,</span> <span class="n">dd</span><span class="o">|</span> <span class="cp">%&gt;</span>
            <span class="nt">&lt;dt</span> <span class="na">class=</span><span class="s">"</span><span class="cp">&lt;%=</span> <span class="n">dt_class</span> <span class="cp">%&gt;</span><span class="s">"</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">dt</span> <span class="cp">%&gt;</span><span class="nt">&lt;/dt&gt;</span>
            <span class="nt">&lt;dd</span> <span class="na">class=</span><span class="s">"</span><span class="cp">&lt;%=</span> <span class="n">dd_class</span> <span class="cp">%&gt;</span><span class="s">"</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">dd</span> <span class="cp">%&gt;</span><span class="nt">&lt;/dd&gt;</span>
          <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;/dl&gt;</span>
      <span class="nt">&lt;/div&gt;</span>

      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"card-footer text-center bg-danger text-light"</span><span class="nt">&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">raw</span><span class="p">(</span><span class="n">t</span><span class="s1">'actions.info'</span><span class="p">),</span> <span class="n">loan_stats_path</span><span class="p">,</span> <span class="ss">class: </span><span class="s1">'btn btn-primary'</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</code></pre>
								</div>
							</div>
							<p>其中 <code class="language-plaintext highlighter-rouge">svg_header</code> 为一个小部件，用于在标题前面添加图标，以便美观，其代码如下：</p>
							<div class="language-erb highlighter-rouge">
								<div class="highlight">
									<pre class="highlight"><code><span class="nt">&lt;h1</span> <span class="na">class=</span><span class="s">"text-center py-4 py-md-5 display-4 d-sm-flex justify-content-center"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"d-block d-sm-inline pb-4 pb-sm-0"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">svg_tag</span> <span class="n">file</span><span class="p">,</span> <span class="ss">class: </span><span class="s1">'svg-inline svg-xl zero-width'</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/span&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">text</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/h1&gt;</span>
</code></pre>
								</div>
							</div>
							<h4 id="3310-业务统计的搜索页面">3.3.10 业务统计的搜索页面</h4>
							<p>该搜索页面由「储蓄业务」和「贷款业务」两页面共用，因此提取为 <code class="language-plaintext highlighter-rouge">stats/_common.html.erb</code>：</p>
							<div class="language-erb highlighter-rouge">
								<div class="highlight">
									<pre class="highlight"><code><span class="cp">&lt;%</span> <span class="n">content_for</span> <span class="ss">:head</span> <span class="k">do</span> <span class="cp">%&gt;</span>
  <span class="c">&lt;%# Chart libraries %&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">javascript_include_tag</span> <span class="s2">"https://cdn.jsdelivr.net/npm/chartkick@3.2.0/dist/chartkick.min.js"</span><span class="p">,</span> <span class="ss">integrity: </span><span class="s2">"sha256-QQ42jSsvKp0SDBvW+xRjHWfK2I4ObL37tEF4+l8a0qg="</span><span class="p">,</span> <span class="ss">crossorigin: :anonymous</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">javascript_include_tag</span> <span class="s2">"https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.js"</span><span class="p">,</span> <span class="ss">integrity: </span><span class="s2">"sha256-R4pqcOYV8lt7snxMQO/HSbVCFRPMdrhAFMH+vr9giYI="</span><span class="p">,</span> <span class="ss">crossorigin: :anonymous</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">render</span> <span class="ss">partial: </span><span class="s1">'svg_header'</span><span class="p">,</span> <span class="ss">locals: </span><span class="p">{</span> <span class="ss">file: </span><span class="n">title_svg</span><span class="p">,</span> <span class="ss">text: </span><span class="n">title_text</span> <span class="p">}</span> <span class="cp">%&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">render</span> <span class="ss">partial: </span><span class="s1">'search_form'</span><span class="p">,</span> <span class="ss">locals: </span><span class="p">{</span> <span class="ss">url: </span><span class="n">current_path</span> <span class="p">}</span> <span class="cp">%&gt;</span>

<span class="cp">&lt;%</span> <span class="k">if</span> <span class="vi">@action</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"card shadow"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"card-header text-center bg-primary text-white"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;h3</span> <span class="na">class=</span><span class="s">"mb-0"</span><span class="nt">&gt;</span>搜索结果<span class="nt">&lt;/h3&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"card-body rounded-bottom bg-white p-3"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"nav nav-tabs"</span> <span class="na">id=</span><span class="s">"branches-tabs"</span> <span class="na">role=</span><span class="s">"tablist"</span><span class="nt">&gt;</span>
        <span class="cp">&lt;%</span> <span class="vi">@data_branches</span><span class="p">.</span><span class="nf">each_with_index</span> <span class="k">do</span> <span class="o">|</span><span class="n">record</span><span class="p">,</span> <span class="n">index</span><span class="o">|</span> <span class="cp">%&gt;</span>
          <span class="cp">&lt;%</span> <span class="n">branch_id</span> <span class="o">=</span> <span class="n">record</span><span class="p">.</span><span class="nf">branch_id</span> <span class="cp">%&gt;</span>
          <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"nav-item"</span> <span class="na">role=</span><span class="s">"presentation"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">"nav-link </span><span class="cp">&lt;%=</span> <span class="s1">'active'</span> <span class="k">if</span> <span class="n">index</span><span class="p">.</span><span class="nf">zero?</span> <span class="cp">%&gt;</span><span class="s">"</span> <span class="na">id=</span><span class="s">"tab-branch-</span><span class="cp">&lt;%=</span> <span class="n">branch_id</span> <span class="cp">%&gt;</span><span class="s">"</span> <span class="na">data-toggle=</span><span class="s">"tab"</span> <span class="na">href=</span><span class="s">"#branch-</span><span class="cp">&lt;%=</span> <span class="n">branch_id</span> <span class="cp">%&gt;</span><span class="s">"</span> <span class="na">role=</span><span class="s">"tab"</span> <span class="na">aria-controls=</span><span class="s">"branch-</span><span class="cp">&lt;%=</span> <span class="n">branch_id</span> <span class="cp">%&gt;</span><span class="s">"</span> <span class="na">aria-selected=</span><span class="s">"</span><span class="cp">&lt;%=</span> <span class="n">index</span><span class="p">.</span><span class="nf">zero?</span> <span class="cp">%&gt;</span><span class="s">"</span><span class="nt">&gt;</span>
              <span class="cp">&lt;%=</span> <span class="n">record</span><span class="p">.</span><span class="nf">branch_name</span> <span class="cp">%&gt;</span>
            <span class="nt">&lt;/a&gt;</span>
          <span class="nt">&lt;/li&gt;</span>
        <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/ul&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"tab-content"</span> <span class="na">id=</span><span class="s">"branches"</span><span class="nt">&gt;</span>
        <span class="cp">&lt;%</span> <span class="vi">@data_branches</span><span class="p">.</span><span class="nf">each_with_index</span> <span class="k">do</span> <span class="o">|</span><span class="n">record</span><span class="p">,</span> <span class="n">index</span><span class="o">|</span> <span class="cp">%&gt;</span>
          <span class="cp">&lt;%</span> <span class="n">branch_id</span> <span class="o">=</span> <span class="n">record</span><span class="p">.</span><span class="nf">branch_id</span> <span class="cp">%&gt;</span>
          <span class="cp">&lt;%</span> <span class="n">records</span> <span class="o">=</span> <span class="vi">@query</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">branch_id: </span><span class="n">branch_id</span><span class="p">)</span> <span class="cp">%&gt;</span>
          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"tab-pane fade </span><span class="cp">&lt;%=</span> <span class="s1">'show active'</span> <span class="k">if</span> <span class="n">index</span><span class="p">.</span><span class="nf">zero?</span> <span class="cp">%&gt;</span><span class="s">"</span> <span class="na">id=</span><span class="s">"branch-</span><span class="cp">&lt;%=</span> <span class="n">branch_id</span> <span class="cp">%&gt;</span><span class="s">"</span> <span class="na">role=</span><span class="s">"tabpanel"</span> <span class="na">aria-labelledby=</span><span class="s">"tab-branch-</span><span class="cp">&lt;%=</span> <span class="n">branch_id</span> <span class="cp">%&gt;</span><span class="s">"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;table</span> <span class="na">class=</span><span class="s">"table table-hover border border-top-0"</span><span class="nt">&gt;</span>
              <span class="nt">&lt;thead&gt;</span>
                <span class="nt">&lt;tr&gt;</span>
                  <span class="nt">&lt;th</span> <span class="na">class=</span><span class="s">"border-top-0"</span><span class="nt">&gt;</span>时间<span class="nt">&lt;/th&gt;</span>
                  <span class="nt">&lt;th</span> <span class="na">class=</span><span class="s">"border-top-0"</span><span class="nt">&gt;</span>客户数<span class="nt">&lt;/th&gt;</span>
                  <span class="nt">&lt;th</span> <span class="na">class=</span><span class="s">"border-top-0"</span><span class="nt">&gt;</span>业务额<span class="nt">&lt;/th&gt;</span>
                <span class="nt">&lt;/tr&gt;</span>
              <span class="nt">&lt;/thead&gt;</span>

              <span class="nt">&lt;tbody&gt;</span>
                <span class="cp">&lt;%</span> <span class="n">records</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">record</span><span class="o">|</span> <span class="cp">%&gt;</span>
                  <span class="nt">&lt;tr&gt;</span>
                    <span class="nt">&lt;td&gt;</span><span class="cp">&lt;%=</span> <span class="n">record</span><span class="p">.</span><span class="nf">display_time</span> <span class="cp">%&gt;</span><span class="nt">&lt;/td&gt;</span>
                    <span class="nt">&lt;td&gt;</span><span class="cp">&lt;%=</span> <span class="n">record</span><span class="p">.</span><span class="nf">clients_count</span> <span class="cp">%&gt;</span><span class="nt">&lt;/td&gt;</span>
                    <span class="nt">&lt;td&gt;</span><span class="cp">&lt;%=</span> <span class="n">currency_value</span> <span class="n">record</span><span class="p">.</span><span class="nf">total_amount</span> <span class="cp">%&gt;</span><span class="nt">&lt;/td&gt;</span>
                  <span class="nt">&lt;/tr&gt;</span>
                <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
              <span class="nt">&lt;/tbody&gt;</span>
            <span class="nt">&lt;/table&gt;</span>

            <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
              <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col col-12 col-md-6"</span><span class="nt">&gt;</span>
                <span class="cp">&lt;%=</span> <span class="n">column_chart</span> <span class="n">stats_amount_chart</span> <span class="n">records</span> <span class="cp">%&gt;</span>
              <span class="nt">&lt;/div&gt;</span>
              <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col col-12 col-md-6"</span><span class="nt">&gt;</span>
                <span class="cp">&lt;%=</span> <span class="n">column_chart</span> <span class="n">stats_clients_chart</span> <span class="n">records</span> <span class="cp">%&gt;</span>
              <span class="nt">&lt;/div&gt;</span>
            <span class="nt">&lt;/div&gt;</span>
          <span class="nt">&lt;/div&gt;</span>
        <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</code></pre>
								</div>
							</div>
							<p>其中搜索结果使用 <code class="language-plaintext highlighter-rouge">&lt;table&gt;</code> 列出表格，使用 <a href="https://chartkick.com/">Chartkick 插件</a>（后端采用 <a href="https://www.chartjs.org/">Chart.js</a>）绘制图表。由于 Chart.js 对曲线图表有额外的技术限制难以绕过，因此此处待用了柱状图表。此处绘制两个图表，分别展示总金额和总客户数。</p>
							<p>搜索表格代码如下：</p>
							<div class="language-erb highlighter-rouge">
								<div class="highlight">
									<pre class="highlight"><code><span class="cp">&lt;%</span> <span class="vi">@date_options</span> <span class="o">||=</span> <span class="p">{</span> <span class="ss">date_separator: </span><span class="s1">'&lt;/div&gt;&lt;div class="col col-4"&gt;'</span><span class="p">,</span> <span class="ss">start_year: </span><span class="vi">@start_year</span><span class="p">,</span> <span class="ss">end_year: </span><span class="vi">@end_year</span> <span class="p">}</span> <span class="cp">%&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">form_with</span> <span class="ss">url: </span><span class="n">url</span><span class="p">,</span> <span class="ss">local: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">id: </span><span class="s1">'search-form'</span><span class="p">,</span> <span class="ss">method: :get</span><span class="p">,</span> <span class="ss">class: </span><span class="s1">'card shadow mb-3'</span> <span class="k">do</span> <span class="o">|</span><span class="n">form</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"card-header text-center bg-info text-white"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;h3</span> <span class="na">class=</span><span class="s">"mb-0"</span><span class="nt">&gt;</span>搜索<span class="nt">&lt;h3&gt;</span>
  <span class="nt">&lt;/div&gt;</span>

  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"card-body"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form-group"</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">form</span><span class="p">.</span><span class="nf">label</span> <span class="ss">:branch_ids</span><span class="p">,</span> <span class="s1">'支行'</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">form</span><span class="p">.</span><span class="nf">hidden_field</span> <span class="ss">:branch</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">form</span><span class="p">.</span><span class="nf">select</span> <span class="ss">:branch_ids</span><span class="p">,</span> <span class="n">options_from_collection_for_select</span><span class="p">(</span><span class="no">Branch</span><span class="p">.</span><span class="nf">select</span><span class="p">(</span><span class="ss">:id</span><span class="p">,</span> <span class="ss">:name</span><span class="p">),</span> <span class="ss">:id</span><span class="p">,</span> <span class="ss">:name</span><span class="p">,</span> <span class="vi">@branches</span><span class="p">),</span> <span class="p">{</span> <span class="ss">include_hidden: </span><span class="kp">false</span> <span class="p">},</span> <span class="p">{</span> <span class="ss">class: </span><span class="s1">'form-control'</span><span class="p">,</span> <span class="ss">multiple: </span><span class="kp">true</span> <span class="p">}</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/div&gt;</span>

    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form-group"</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">form</span><span class="p">.</span><span class="nf">label</span> <span class="ss">:start_date</span><span class="p">,</span> <span class="s1">'开始日期'</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">form</span><span class="p">.</span><span class="nf">hidden_field</span> <span class="ss">:start_date</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form-row"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col col-4"</span><span class="nt">&gt;</span>
          <span class="cp">&lt;%=</span> <span class="n">form</span><span class="p">.</span><span class="nf">date_select</span> <span class="ss">:start_date</span><span class="p">,</span> <span class="vi">@date_options</span><span class="p">.</span><span class="nf">merge</span><span class="p">({</span> <span class="ss">default: </span><span class="vi">@start_date</span> <span class="p">}),</span> <span class="p">{</span> <span class="ss">class: </span><span class="s1">'form-control'</span> <span class="p">}</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>

    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form-group"</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">form</span><span class="p">.</span><span class="nf">label</span> <span class="ss">:end_date</span><span class="p">,</span> <span class="s1">'结束日期'</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">form</span><span class="p">.</span><span class="nf">hidden_field</span> <span class="ss">:end_date</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form-row"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col col-4"</span><span class="nt">&gt;</span>
          <span class="cp">&lt;%=</span> <span class="n">form</span><span class="p">.</span><span class="nf">date_select</span> <span class="ss">:end_date</span><span class="p">,</span> <span class="vi">@date_options</span><span class="p">.</span><span class="nf">merge</span><span class="p">({</span> <span class="ss">default: </span><span class="vi">@end_date</span> <span class="p">}),</span> <span class="p">{</span> <span class="ss">class: </span><span class="s1">'form-control'</span> <span class="p">}</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>

    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form-group mb-0"</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">form</span><span class="p">.</span><span class="nf">label</span> <span class="ss">:time_span</span><span class="p">,</span> <span class="s1">'按时间归类'</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-12"</span><span class="nt">&gt;</span>
        <span class="cp">&lt;%</span> <span class="vi">@time_spans</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="nb">name</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span> <span class="cp">%&gt;</span>
          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form-check form-check-inline"</span><span class="nt">&gt;</span>
            <span class="cp">&lt;%=</span> <span class="n">form</span><span class="p">.</span><span class="nf">radio_button</span> <span class="ss">:time_span</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="ss">checked: </span><span class="p">(</span><span class="vi">@time_span</span> <span class="o">==</span> <span class="n">value</span><span class="p">),</span> <span class="ss">class: </span><span class="s1">'form-check-input'</span> <span class="cp">%&gt;</span>
            <span class="cp">&lt;%=</span> <span class="n">form</span><span class="p">.</span><span class="nf">label</span> <span class="ss">:time_span</span><span class="p">,</span> <span class="nb">name</span><span class="p">,</span> <span class="ss">value: </span><span class="n">value</span><span class="p">,</span> <span class="ss">class: </span><span class="s1">'form-check-label'</span> <span class="cp">%&gt;</span>
          <span class="nt">&lt;/div&gt;</span>
        <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>

  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"card-footer text-center bg-info text-white"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form</span><span class="p">.</span><span class="nf">button</span> <span class="ss">class: </span><span class="s1">'btn btn-success'</span><span class="p">,</span> <span class="ss">type: :submit</span><span class="p">,</span> <span class="ss">name: :action</span><span class="p">,</span> <span class="ss">value: :submit</span><span class="p">,</span> <span class="ss">onclick: </span><span class="s1">'onSubmit()'</span> <span class="k">do</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;i</span> <span class="na">class=</span><span class="s">"fa fas fa-search"</span><span class="nt">&gt;&lt;/i&gt;</span> 搜索
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">raw</span><span class="p">(</span><span class="n">t</span><span class="s1">'actions.back'</span><span class="p">),</span> <span class="n">stats_path</span><span class="p">,</span> <span class="ss">class: </span><span class="s1">'btn btn-secondary'</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">javascript_include_tag</span> <span class="s1">'search-form'</span><span class="p">,</span> <span class="ss">async: </span><span class="kp">true</span> <span class="cp">%&gt;</span>
</code></pre>
								</div>
							</div>
							<p>该表格使用 GET 方法发送，以确保所有搜索结果链接可复用。另外该模块包含了一个自己写的帮助脚本，其内容如下：</p>
							<div class="language-javascript highlighter-rouge">
								<div class="highlight">
									<pre class="highlight"><code><span class="kd">function</span> <span class="nf">onSubmit</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
  <span class="nf">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">#branch</span><span class="dl">'</span><span class="p">).</span><span class="nf">val</span><span class="p">(</span><span class="nf">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">#branch_ids</span><span class="dl">'</span><span class="p">).</span><span class="nf">val</span><span class="p">().</span><span class="nf">join</span><span class="p">(</span><span class="dl">"</span><span class="s2"> </span><span class="dl">"</span><span class="p">));</span>
  <span class="nf">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">#branch_ids</span><span class="dl">'</span><span class="p">).</span><span class="nf">removeAttr</span><span class="p">(</span><span class="dl">'</span><span class="s1">name</span><span class="dl">'</span><span class="p">);</span>

  <span class="nx">$</span><span class="p">.</span><span class="nf">each</span><span class="p">([</span><span class="dl">"</span><span class="s2">start_date</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">end_date</span><span class="dl">"</span><span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">index</span><span class="p">,</span> <span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="p">[],</span> <span class="nx">elem</span><span class="p">;</span>
    <span class="k">for </span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">elem</span> <span class="o">=</span> <span class="nf">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">#_</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">id</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">_</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">i</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">i</span><span class="dl">"</span><span class="p">);</span>
      <span class="nx">a</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">elem</span><span class="p">.</span><span class="nf">val</span><span class="p">();</span>
      <span class="nx">elem</span><span class="p">.</span><span class="nf">removeAttr</span><span class="p">(</span><span class="dl">'</span><span class="s1">name</span><span class="dl">'</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">date</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Date</span><span class="p">(</span><span class="nb">Date</span><span class="p">.</span><span class="nc">UTC</span><span class="p">(</span><span class="nx">a</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">a</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">a</span><span class="p">[</span><span class="mi">3</span><span class="p">]));</span> <span class="c1">// 2nd parameter is monthIndex</span>
    <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nx">date</span><span class="p">.</span><span class="nf">toISOString</span><span class="p">());</span>
    <span class="nf">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">#</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">id</span><span class="p">).</span><span class="nf">val</span><span class="p">(</span><span class="nx">date</span><span class="p">.</span><span class="nf">toISOString</span><span class="p">().</span><span class="nf">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">));</span>
  <span class="p">});</span>

  <span class="nf">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">#search-form input</span><span class="dl">'</span><span class="p">).</span><span class="nf">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">index</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">item</span> <span class="o">=</span> <span class="nf">$</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
    <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">item</span><span class="p">.</span><span class="nf">val</span><span class="p">()</span> <span class="o">||</span> <span class="nx">item</span><span class="p">.</span><span class="nf">val</span><span class="p">()</span> <span class="o">==</span> <span class="dl">'</span><span class="s1">none</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">item</span><span class="p">.</span><span class="nf">removeAttr</span><span class="p">(</span><span class="dl">'</span><span class="s1">name</span><span class="dl">'</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">});</span>
<span class="p">}</span>
</code></pre>
								</div>
							</div>
							<p>其作用为</p>
							<ul>
								<li>从原始的输入框中去掉 <code class="language-plaintext highlighter-rouge">name</code> 属性，因为该属性是由 Rails 的 Form Helper 生成的，格式不美观</li>
								<li>将支行选择用逗号连接作为查询参数</li>
								<li>将日期输入拼接成 ISO 8601 的日期格式作为查询参数</li>
							</ul>
							<p>使用该脚本可以生成美观的查询 URL。</p>
							<h3 id="34-sprockets-assets-pipeline">3.4 Sprockets Assets Pipeline</h3>
							<p>本项目的主要前端功能都使用 jQuery，Bootstrap，Rails UJS 和 Vue.js 实现，但也包含少量了自定义代码，因此使用 <a href="https://github.com/rails/sprockets">Sprockets</a> 作为 Assets Pipeline 来编译打包这些额外代码。</p>
							<p>Sprockets 的配置文件 <code class="language-plaintext highlighter-rouge">/app/assets/config/manifest.js</code> 内容如下：</p>
							<div class="language-javascript highlighter-rouge">
								<div class="highlight">
									<pre class="highlight"><code><span class="c1">//= link_tree ../images</span>
<span class="c1">//= link_directory ../javascripts .js</span>
<span class="c1">//= link application.css</span>
</code></pre>
								</div>
							</div>
							<p>在生产环境中一般不随时从源码编译，而是在部署前一次性提前编译好，减少生产环境服务器的重复工作。预编译使用 Rake 任务 <code class="language-plaintext highlighter-rouge">assets:precompile</code> 完成，该操作在打包 Docker 镜像前也会执行，因为 Docker 镜像内为生产环境。</p>
							<h4 id="341-javascript-脚本">3.4.1 JavaScript 脚本</h4>
							<p>本项目使用了两段自定义 JavaScript 脚本，分别在 3.3.4 节和 3.3.10 节介绍。该脚本使用原生 JavaScript 语法编写，使用 Sprockets 编译打包，并在 Action View 模板中使用 <code class="language-plaintext highlighter-rouge">javascript_include_tag</code> 调用。Sprockets 会自动在生成的文件的文件名部分末尾添加一段 hash，这样当源文件修改时生成的文件名也会变化，可以省去清除浏览器缓存的必要。</p>
							<h4 id="342-css-样式表">3.4.2 CSS 样式表</h4>
							<p>本项目使用了多段自定义 CSS 样式表，采用 <a href="https://sass-lang.com/">SCSS</a> 语法书写，使用 <a href="https://github.com/sass/sassc-ruby">SassC</a> 编译为正统的 CSS 语法并最小化（minify）。该过程同样借助 Sprockets 自动化，详见 3.4.1 节。</p>
							<p>与 JavaScript 不同，本项目所使用的全部 CSS 打包到一个文件 <code class="language-plaintext highlighter-rouge">application.css</code> 内，避免不同页面加载不同文件带来的额外网络开销和延迟。主文件的源文件 <code class="language-plaintext highlighter-rouge">application.scss</code> 仅包含一行有效代码：</p>
							<div class="language-scss highlighter-rouge">
								<div class="highlight">
									<pre class="highlight"><code><span class="c1">//= require_tree .</span>
</code></pre>
								</div>
							</div>
							<p>该代码指示包含（include）当前目录下全部 CSS / SCSS 格式文件。</p>
							<h4 id="343-图片">3.4.3 图片</h4>
							<p>本项目使用了多个 SVG 矢量图作为图标等，并使用一个 PNG 文件作为网站图标（favicon），它们同样由 Sprockets 编译打包，过程与 3.4.1 节所述 JavaScript 的打包流程相同，此处不再重复。</p>
							<h2 id="4-实现与测试">4 实现与测试</h2>
							<h3 id="41-实现结果">4.1 实现结果</h3>
							<h4 id="首页">首页</h4>
							<p><img src="https://ibug.github.io/Junk-Bank-System/image/home.png" alt="首页" class="border"></p>
							<h4 id="支行列表页面">支行列表页面</h4>
							<p><img src="https://ibug.github.io/Junk-Bank-System/image/branches-index.png" alt="支行列表页面" class="border"></p>
							<h4 id="支行详细信息页面">支行详细信息页面</h4>
							<p><img src="https://ibug.github.io/Junk-Bank-System/image/branches-show.png" alt="支行详细信息页面" class="border"></p>
							<h4 id="账户编辑页面">账户编辑页面</h4>
							<p><img src="https://ibug.github.io/Junk-Bank-System/image/accounts-edit.png" alt="账户编辑页面" class="border"></p>
							<h4 id="支行的关联账户页面">支行的关联账户页面</h4>
							<p><img src="https://ibug.github.io/Junk-Bank-System/image/branches-accounts.png" alt="支行的关联账户页面" class="border"></p>
							<h4 id="账户的关联客户页面">账户的关联客户页面</h4>
							<p><img src="https://ibug.github.io/Junk-Bank-System/image/accounts-owners.png" alt="账户的关联客户页面" class="border"></p>
							<h4 id="贷款的支付页面">贷款的支付页面</h4>
							<p><img src="https://ibug.github.io/Junk-Bank-System/image/loans-issues.png" alt="贷款的支付页面" class="border"></p>
							<h4 id="业务统计页面">「业务统计」页面</h4>
							<p><img src="https://ibug.github.io/Junk-Bank-System/image/stats.png" alt="业务统计页面" class="border"></p>
							<h4 id="业务统计的搜索页面">业务统计的搜索页面</h4>
							<p><img src="https://ibug.github.io/Junk-Bank-System/image/stats-search.png" alt="业务统计的搜索页面" class="border"></p>
							<p><img src="https://ibug.github.io/Junk-Bank-System/image/stats-search-results.png" alt="业务统计的搜索结果页面" class="border"></p>
							<p>以上即为本系统的实现结果（外观）。</p>
							<h3 id="42-测试结果">4.2 测试结果</h3>
							<h4 id="421-操作成功结果">4.2.1 操作成功结果</h4>
							<h5 id="创建支行">创建支行</h5>
							<p><img src="https://ibug.github.io/Junk-Bank-System/image/branches-create.png" alt="创建支行" class="border"></p>
							<h5 id="更新支行">更新支行</h5>
							<p><img src="https://ibug.github.io/Junk-Bank-System/image/branches-update.png" alt="更新支行" class="border"></p>
							<h5 id="删除支行">删除支行</h5>
							<p><img src="https://ibug.github.io/Junk-Bank-System/image/branches-destroy.png" alt="删除支行" class="border"></p>
							<h5 id="账户新增关联客户">账户新增关联客户</h5>
							<p><img src="https://ibug.github.io/Junk-Bank-System/image/ownerships-create.png" alt="账户新增关联客户" class="border"></p>
							<h5 id="贷款新增支付">贷款新增支付</h5>
							<p><img src="https://ibug.github.io/Junk-Bank-System/image/issues-create.png" alt="贷款新增支付" class="border"></p>
							<h4 id="422-操作失败结果">4.2.2 操作失败结果</h4>
							<h5 id="创建支行-1">创建支行</h5>
							<p><img src="https://ibug.github.io/Junk-Bank-System/image/branches-create-fail.png" alt="创建支行" class="border"></p>
							<h5 id="删除支行-1">删除支行</h5>
							<p><img src="https://ibug.github.io/Junk-Bank-System/image/branches-destroy-fail.png" alt="删除支行" class="border"></p>
							<h5 id="更新账户">更新账户</h5>
							<p>修改开户支行</p>
							<p><img src="https://ibug.github.io/Junk-Bank-System/image/accounts-edit-fail.png" alt="更新账户" class="border"></p>
							<p>错误的账户余额</p>
							<p><img src="https://ibug.github.io/Junk-Bank-System/image/accounts-edit-fail-2.png" alt="更新账户" class="border"></p>
							<h5 id="贷款支付">贷款支付</h5>
							<p><img src="https://ibug.github.io/Junk-Bank-System/image/issues-create-fail.png" alt="贷款支付" class="border"></p>
							<p>若修改前端强行提交不正确的数值</p>
							<p><img src="https://ibug.github.io/Junk-Bank-System/image/issues-create-fail-2.png" alt="贷款支付" class="border"></p>
							<p>以上即为本系统的测试结果，其表明本系统具有符合正常逻辑的错误检查。</p>
							<h2 id="5-总结与讨论">5 总结与讨论</h2>
							<p>本人自 2018 年<a href="https://github.com/Charcoal-SE/metasmoke">初次接触 Ruby on Rails</a> 以来，一直想要找个机会通过自己编写一个完整项目来熟悉这个框架，正好本次实验是一个绝佳的机会，因此决定采用 Ruby on Rails 作为完成本实验的框架。由于几乎是零基础（Ruby 语言除外），同时使用了最新的版本（Rails 6.0.3），而网上的大部分资料及手头的一本教程书籍都是讲 Rails 5 甚至 Rails 4/3 的，也遇到了不少新旧版本不一致的坑，导致 Rails 5 以前的解决方案不适用，前期花了大量时间在 Google 及 Stack Overflow 上，这从本人的浏览器历史记录里就可以看出：</p>
							<p><img src="https://ibug.github.io/Junk-Bank-System/image/browser-history.png" alt="Browser History"></p>
							<p>整体体验看来，得益于 Ruby 语言灵活的设计，Ruby on Rails 是最方便快捷的 Web 框架（显然它的性能比不上 Go 和 PHP 等语言），相比其他同学动辄上千行的 <code class="language-plaintext highlighter-rouge">views.py</code>，我只用了不到 700 行 Ruby 就实现了全部控制器功能，并且额外实现了支行、部门和员工的增删改查（这是实验文档里所没有要求的功能），甚至其中一半左右的代码都是框架代码（由 <code class="language-plaintext highlighter-rouge">rails generate</code> 命令生成的“默认”代码）和空行。</p>
							<p><img src="https://ibug.github.io/Junk-Bank-System/image/wc-controllers.png" alt="Word Count on Controllers"></p>
							<p>同样由于 Ruby 语言方便的设计，Action View 视图模板的整体体验也比 Django + Jinja2 要好，所有变量只要写入类实例变量（class instance variables，<code class="language-plaintext highlighter-rouge">@var</code>），就自动在 ERB 模板中可用。同时 Rails 的 Action View 模板中还可以无缝使用各种自带的及自己编写的帮助函数（helper methods），这更进一步减少了重复工作。</p>
							<p>再一次受益于 Ruby 语言的优势，Rails 的一些周边配置文件也十分简洁灵活，例如控制器的路由配置：</p>
							<div class="language-ruby highlighter-rouge">
								<div class="highlight">
									<pre class="highlight"><code><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="n">root</span> <span class="s1">'stats#home'</span>
  <span class="n">get</span> <span class="s1">'/about'</span><span class="p">,</span> <span class="ss">to: </span><span class="s1">'stats#about'</span><span class="p">,</span> <span class="ss">as: :about</span>

  <span class="n">resources</span> <span class="ss">:branches</span>
  <span class="n">resources</span> <span class="ss">:departments</span>
  <span class="n">resources</span> <span class="ss">:staffs</span>
  <span class="n">resources</span> <span class="ss">:clients</span>
  <span class="n">resources</span> <span class="ss">:accounts</span>
  <span class="n">resources</span> <span class="ss">:loans</span><span class="p">,</span> <span class="ss">except: </span><span class="sx">%i[edit update]</span>

  <span class="n">scope</span> <span class="ss">:branches</span> <span class="k">do</span>
    <span class="n">get</span> <span class="s1">':id/staffs'</span><span class="p">,</span> <span class="ss">to: </span><span class="s1">'branches#staffs'</span><span class="p">,</span> <span class="ss">as: :branch_staffs</span>
    <span class="n">get</span> <span class="s1">':id/accounts'</span><span class="p">,</span> <span class="ss">to: </span><span class="s1">'branches#accounts'</span><span class="p">,</span> <span class="ss">as: :branch_accounts</span>
    <span class="n">get</span> <span class="s1">':id/loans'</span><span class="p">,</span> <span class="ss">to: </span><span class="s1">'branches#loans'</span><span class="p">,</span> <span class="ss">as: :branch_loans</span>
  <span class="k">end</span>

  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre>
								</div>
							</div>
							<p>对比一个典型 Django 项目的路由配置 <code class="language-plaintext highlighter-rouge">urls.py</code>：</p>
							<div class="language-python highlighter-rouge">
								<div class="highlight">
									<pre class="highlight"><code><span class="kn">from</span> <span class="n">django.urls</span> <span class="kn">import</span> <span class="n">path</span><span class="p">,</span> <span class="n">reverse_lazy</span>
<span class="kn">from</span> <span class="n">django.views.generic</span> <span class="kn">import</span> <span class="n">TemplateView</span>
<span class="kn">from</span> <span class="n">django.contrib.auth</span> <span class="kn">import</span> <span class="n">views</span> <span class="k">as</span> <span class="n">auth_views</span>
<span class="kn">from</span> <span class="n">.</span> <span class="kn">import</span> <span class="n">views</span>


<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="nf">path</span><span class="p">(</span><span class="sh">''</span><span class="p">,</span> <span class="n">TemplateView</span><span class="p">.</span><span class="nf">as_view</span><span class="p">(</span><span class="n">template_name</span><span class="o">=</span><span class="sh">"</span><span class="s">app/index.html</span><span class="sh">"</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="sh">'</span><span class="s">index</span><span class="sh">'</span><span class="p">),</span>
    <span class="nf">path</span><span class="p">(</span><span class="sh">'</span><span class="s">login/</span><span class="sh">'</span><span class="p">,</span> <span class="n">auth_views</span><span class="p">.</span><span class="n">LoginView</span><span class="p">.</span><span class="nf">as_view</span><span class="p">(</span><span class="n">template_name</span><span class="o">=</span><span class="sh">'</span><span class="s">app/login.html</span><span class="sh">'</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="sh">'</span><span class="s">login</span><span class="sh">'</span><span class="p">),</span>
    <span class="nf">path</span><span class="p">(</span><span class="sh">'</span><span class="s">logout/</span><span class="sh">'</span><span class="p">,</span> <span class="n">views</span><span class="p">.</span><span class="n">user_logout</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="sh">'</span><span class="s">logout</span><span class="sh">'</span><span class="p">),</span>
    <span class="c1"># 此处省略 60+ 行，每行都很长
</span><span class="p">]</span>
</code></pre>
								</div>
							</div>
							<p>可见 Ruby 及 Ruby on Rails 宣称的 convention over configuration 确实大大减少了开发工作量，但同时带来的一个难点是开发者需要熟悉 Rails 的这些 convention。显然，稍微熟悉 Rails 之后，这些“难点”并不是什么实际的问题，甚至 Stack Overflow 上标签 <code class="language-plaintext highlighter-rouge">ruby-on-rails</code> 的问题比标签 <code class="language-plaintext highlighter-rouge">ruby</code> 的问题还要多一半：</p>
							<p><img src="https://ibug.github.io/Junk-Bank-System/image/so-tags.png" alt="Stack Overflow Tags"></p>
							<p>因此我认为，Ruby on Rails 是一个对开发者友好、对用户也友好、同时又功能强大的 web 框架，适合作为敏捷开发 web 应用程序的<strong>首选</strong>。</p>
							<hr>
							<p>作为对比，本实验的实验报告模板<strong>极为冗长</strong>，不仅要求重复实验文档中已有的内容，如系统目标和需求说明等，还要求绘制一大堆麻烦又没有意义的结构图流程图，并且说明一些毫无意义的细节（如各模块的输入、输出和程序流程图等）。此报告将本实验的整体体验结构拉到了一个十分科学的平衡点，即著名的<a href="https://zh.wikipedia.org/wiki/%E5%B8%95%E7%B4%AF%E6%89%98%E6%B3%95%E5%88%99">八二法则</a>：实验中 80% 的汗水带来了 20% 的痛苦（编写应用程序本身），而 20% 的汗水带来了 80% 的痛苦🤮（撰写实验报告）。本报告之所以能够写得如此详细尽致，不仅在于找准了写报告之道，关键在于找准了写报告之道。</p>
							<p>因此，本实验最亟需改进的地方，甚至可能是唯一需要改进的地方，就是<strong>将这份又臭又长的实验报告模板扔掉</strong>，为做实验的学生们，也为读实验报告的助教们减轻大量不必要的负担。</p>
							<p>本报告至此基本结束了，已近一万七千字，在此诚挚地向完整仔细阅毕本报告的各位助教们道一句：<strong>辛苦了</strong>，并恳请助教仔细考虑复杂繁长的实验报告的必要性，<strong>谢谢助教</strong>。</p>
						</section>
						<footer class="page__meta">
							<p class="page__taxonomy">
								<strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
								<span itemprop="keywords">
									<a href="/tag/study-notes" class="page__taxonomy-item p-category" rel="tag">study-notes</a>
								</span>
							</p>
							<p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time class="dt-published" datetime="2021-03-27">Mar 27, 2021</time></p>
						</footer>
						<section class="page__share">
							<h4 class="page__share-title">Share on</h4>
							<a href="https://twitter.com/intent/tweet?text=%E9%93%B6%E8%A1%8C%E4%B8%9A%E5%8A%A1%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%0A%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%E6%8A%A5%E5%91%8A%20https%3A%2F%2Fibug.io%2Fcn%2F2020%2F06%2Fdb-lab-3-report%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>
							<a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fibug.io%2Fcn%2F2020%2F06%2Fdb-lab-3-report%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>
							<a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://ibug.io/cn/2020/06/db-lab-3-report/" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
						</section>
						<nav class="pagination">
							<a href="/cn/2019/11/backTCP-report/" class="pagination--pager" title="backTCP 实验报告
">Previous</a>
							<a href="/cn/2020/07/clash-for-windows-custom-rules/" class="pagination--pager" title="Clash for Windows 自定义规则整合
">Next</a>
						</nav>
					</div>
					<div class="page__comments">
						<h4 class="page__comments-title">Leave a comment</h4>
						<section id="disqus_thread"></section>
					</div>
				</article>
			</div>
		</div>
		<div class="search-content">
			<div class="search-content__inner-wrap">
				<div class="search-searchbar"></div>
				<div class="search-hits"></div>
			</div>
		</div>
		<div id="footer" class="page__footer">
			<footer>
				<!-- start custom footer snippets -->
				<!-- end custom footer snippets -->
				<div class="page__footer-follow">
					<ul class="social-icons">
						<li><strong>Follow:</strong></li>
						<li><a href="https://github.com/iBug" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
						<li><a href="https://stackoverflow.com/users/5958455/ibug" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-stack-overflow" aria-hidden="true"></i> Stack Overflow</a></li>
						<li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
					</ul>
				</div>
				<div class="page__footer-copyright">
					<p>© 2024 iBug. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</p>
					<p>Except when otherwise noted, content on this site is licensed under the <a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0 License</a>.</p>
					<p><a href="/privacy-policy">Privacy Policy</a> | <a href="/sitemap.xml">Sitemap (XML)</a></p>
					<p>
						Site version <a href="/status" class="version-text">G-893</a>
					</p>
				</div>
			</footer>
		</div>
		<script src="/assets/js/main.min.js"></script>
		<script>
			// Including InstantSearch.js library and styling
			const loadSearch = function() {
			  const loadCSS = function(src) {
			    var link = document.createElement('link');
			    link.rel = 'stylesheet';
			    link.type = 'text/css';
			    link.href = src;
			    link.media = 'all';
			    document.head.appendChild(link);
			  };

			  var script = document.createElement('script');
			  script.setAttribute("type", "text/javascript");
			  script.setAttribute("src", "https://cdn.jsdelivr.net/npm/instantsearch.js@2.3.3/dist/instantsearch.min.js");
			  script.addEventListener("load", function() {
			    // Instantiating InstantSearch.js with Algolia credentials
			    const search = instantsearch({
			      appId: '14DZKASAEJ',
			      apiKey: 'a0d8cb9da2d6ad0d17dcd40c58c72a56',
			      indexName: 'iBug_website',
			      searchParameters: {
			        restrictSearchableAttributes: ['title', 'content']
			      }
			    });

			    const hitTemplate = function(hit) {
			      const url = hit.url;
			      const hightlight = hit._highlightResult;
			      const title = hightlight.title && hightlight.title.value  || "";
			      const content = hightlight.html && hightlight.html.value  || "";

			      return `
			        <div class="list__item">
			          <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
			            <h2 class="archive__item-title" itemprop="headline"><a href="${url}">${title}</a></h2>
			            <div class="archive__item-excerpt" itemprop="description">${content}</div>
			          </article>
			        </div>
			      `;
			    }

			    // Adding searchbar and results widgets
			    search.addWidget(
			      instantsearch.widgets.searchBox({
			        container: '.search-searchbar',
			        poweredBy: true,
			        placeholder: 'Enter your search term...'
			      })
			    );
			    search.addWidget(
			      instantsearch.widgets.hits({
			        container: '.search-hits',
			        templates: {
			          item: hitTemplate,
			          empty: 'No results',
			        }
			      })
			    );

			    if (!search.started) {
			      search.start();
			    }
			  });
			  document.body.appendChild(script);

			  loadCSS("https://cdn.jsdelivr.net/npm/instantsearch.js@2.3.3/dist/instantsearch.min.css");
			  loadCSS("https://cdn.jsdelivr.net/npm/instantsearch.js@2.3.3/dist/instantsearch-theme-algolia.min.css");
			};

			// Starting the search only when toggle is clicked
			$(document).ready(function() {
			  var scriptLoaded = false;

			  $(".search__toggle").on("click", function() {
			    if (!scriptLoaded) {
			      loadSearch();
			      scriptLoaded = true;
			    }
			  });
			});
		</script>
		<!-- Global site tag (gtag.js) - Google Analytics -->
		<script async src="https://www.googletagmanager.com/gtag/js?id=G-V93196TX91"></script>
		<script>
			window.dataLayer = window.dataLayer || [];
			function gtag(){dataLayer.push(arguments);}
			gtag('js', new Date());

			gtag('config', 'G-V93196TX91', { 'anonymize_ip': false});
		</script>
		<script>
			var disqus_config = function () {
			  this.page.url = "https://ibug.io/cn/2020/06/db-lab-3-report/";  /* Replace PAGE_URL with your page's canonical URL variable */
			  this.page.identifier = "/cn/2020/06/db-lab-3-report"; /* Replace PAGE_IDENTIFIER with your page's unique identifier variable */
			};
			(function() { /* DON'T EDIT BELOW THIS LINE */
			  var d = document, s = d.createElement('script');
			  s.src = 'https://ibugone.disqus.com/embed.js';
			  s.setAttribute('data-timestamp', +new Date());
			  (d.head || d.body).appendChild(s);
			})();
		</script>
		<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
		</noscript>
	</body>
</html>